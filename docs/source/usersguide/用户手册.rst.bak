.. _usersguide:

==========
用户手册
==========

.. contents:: 目录
   :depth: 3

|
|


运行RMC程序
==================

通过编译（参见《 :ref:`compiling` 》） 或从程序包中，得到适应当前系统的RMC可执行程序
，在完成配置数据库、编写输入文件后，即可运行RMC程序进行计算。

本节介绍如何运行程序，后续章节介绍输入文件编写方法。


安装配置
---------------

在运行程序前，需要配置截面数据库。

RMC采用ACE格式中子反应截面数据库，并通过索引文件获得数据库位置进而读取数据。

 - 将数据库（如Library文件夹）拷贝到计算机某一目录

 - 用文本编辑器打开数据库相应的索引文件xsdir，设置数据库文件所在的 **完整目录**
   ，形如 "DATAPATH = E:\\Library\\endf7_2" （windows）
   或 "DATAPATH = /home/username/Library/endf7_2" （Linux）

 - 将输入文件置于RMC可执行程序的目录内，即可运行算例。注意应保证“xsdir”索引文
   件与RMC可执行程序在同一目录。执行燃耗计算之前，还需保证“DepthMainLib”燃耗数据库
   文件与RMC可执行程序置于同一目录


运行命令
---------------

串行运行
~~~~~~~~~~~~~~

假定串行版RMC可执行程序文件名为“RMC”，串行运行RMC的方法是：通过windows命令控制
台或Linux终端进入RMC可执行程序所在目录，输入以下命令：

.. code-block:: none

  Windows系统： RMC [OPTION...] 输入文件名

  Linux系统： ./RMC [OPTION...] 输入文件名


**注意** ：

    - 输入文件应与RMC可执行程序处于同一目录，否则应当使用完整的文件路径。

    - 输出文件名可省略，程序默认将输入文件名加上后缀“.out”作为输出文件名。对于
      燃耗计算，程序还将自动指定后缀“.nuc”和“.power”等作为附加输出文件，用户应避
      免输出文件名的冲突。

    - *输入文件名如果有后缀，应包含后缀*\ 。

    - *不建议windows系统下的输入文件和linux系统下的输入文件混用*\ 。
      Windows系统默认使用ANSI文件编码（中文操作系统中，就是GBK编码），
      Linux系统默认使用UTF-8文件编码，混用可能导致文件读取失败。
      若确有需求，推荐使用 `UltraEdit`_ 、 `VSCode`_ 等软件手动转换编码格式。


纯MPI并行运行
~~~~~~~~~~~~~~~~~~~

并行调用RMC需要先在操作系统中配置好MPI并行环境，mpich、impi、openmpi和mvapich等
软件都可以提供MPI并行环境。

以Windows下的MPICH2-1.4.1p1为例，假定并行版RMC可执行程序为“RMC_mpi”，则执行并行
计算的命令为：

.. code-block:: none

  mpiexec –n 并行核数 RMC_mpi [OPTION...] 输入文件名

例如 `mpiexec –n 10 RMC_mpi -o output input` 表示使用10个进程计算，输入文件名为
"input"，输出文件名为"output"。


MPI/OepnMP混合并行运行
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

假定同时使用MPI和OpenMP编译成功的混合并行版RMC可执行程序为“RMC_MPI_OMP”，
则执行并行计算的命令为：

.. code-block:: none

  mpiexec –n MPI进程数 RMC_MPI_OMP -s OMP线程数 输入文件名

例如 `mpiexec –n 2 RMC_MPI_OMP -s 10 input -o output` 表示使用2个进程，每个进程10个线程计算，
输入文件名为"input"，输出文件名为"output"。


测试输入输出
----------------

程序发布包中的Example文件夹下附带典型算例的输入文件和输出文件，用户可通过计算其
中的某些算例（如“3_1_PWR_assembly、8_1_Burn_PWR_Pin”），以检验程序是否正确安装。


试用版功能限制
----------------

试用版用户需要注意，试用版RMC的最大并行MPI进程数为8，最长运行时间为240核时，超出最长运行时间会导致程序
中断退出，且不会输出计算结果。试用版不支持的计算功能有：敏感性与不确定度分析/随机介质与弥散介质/临界搜索
/时空动力学计算功能/群常数/区域分解/计数器数据分解(在目录标题上已标出)。


|

输入概述
===============

输入模块
------------

RMC的输入文件按照模块划分，各模块的名称及相应功能如下所示：

   -  **SURFACE**\ 模块：定义曲面类型和曲面方程。

   -  **UNIVERSE**\ 模块：描述某个完整的几何空间。RMC采用基于层级空间的几何描述，输入文件
      中可能存在多个UNIVERSE模块。

   -  **MATERIAL**\ 模块：定义材料组成。

   -  **CRITICALITY**\ 模块：定义临界计算参数，包括粒子数、初始源等。

   -  **TALLY**\ 模块：定义计数器，包括通量、功率、反应率等。

   -  **CONVERGENCE**\ 模块：定义源收敛诊断和加速参数。

   -  **BURNUP**\ 模块：定义燃耗计算参数，包括燃耗栅元、功率、时间步长等。

   -  **PRINT**\ 模块：定义输出内容。

   -  **PLOT**\ 模块：定义画图参数。

   -  **FIXEDSOURCE**\ 模块：定义固定源计算参数，主要包括需要模拟的初始源粒子数。

   -  **EXTERNALSOURCE**\ 模块：定义外源粒子的信息，包括粒子的类型、位置、飞行方向和能量分布等。

输入卡
----------

各个输入模块具有特定的输入卡：

.. table:: RMC输入卡总览表
  :name: keywords_table

  +------------+-------------+--------------------------------------------------+
  | 输入模块   | 输入卡      | 功能描述                                         |
  +============+===============+================================================+
  | Surface    | Surf          | 定义一个曲面。包括曲面类型，曲面方程参数，曲面 |
  |            |               | 边界条件，等。                                 |
  +------------+---------------+------------------------------------------------+
  | Universe   | Cell          | 定义空间内的某个栅元。包括填充材料，几何形状， |
  |            |               | 体积，温度，等                                 |
  +------------+---------------+------------------------------------------------+
  |            | Universe      | 定义某个完整的几何空间(坐标变换，重复网格等)   |
  +------------+---------------+------------------------------------------------+
  | Material   | Mat           | 定义一种材料。包括材料密度，核素组成，等。     |
  +------------+---------------+------------------------------------------------+
  |            | Sab           | 指定某种材料所使用的热化截面库。               |
  +------------+---------------+------------------------------------------------+
  |            | CeAce         | 指定与连续能量ACE截面相关的输入参数。          |
  +------------+---------------+------------------------------------------------+
  |            | MgAce         | 指定与多群ACE截面相关的输入参数。              |
  +------------+---------------+------------------------------------------------+
  | Criticality| PowerIter     | 指定源迭代的初始keff和粒子数。                 |
  +------------+---------------+------------------------------------------------+
  |            | InitSrc       | 指定源迭代计算的初始裂变源分布。               |
  +------------+---------------+------------------------------------------------+
  |            | RNG           | 指定随机数发生器的类型和参数。                 |
  +------------+---------------+------------------------------------------------+
  |            | ParallelBank  | 指定并行临界计算裂变源中子库的处理模式。       |
  +------------+---------------+------------------------------------------------+
  | Tally      | CellTally     | 定义栅元计数器。统计某个或多个栅元内的积分通   |
  |            |               | 量、功率、吸收反应率或裂变反应率。             |
  +------------+---------------+------------------------------------------------+
  |            | MeshTally     | 定义网格计数器。按照预先定义的网格，统计每个网 |
  |            |               | 格内的积分通量、功率、吸收反应率或裂变反应率。 |
  +------------+---------------+------------------------------------------------+
  |            | CsTally       | 定义截面计数器。指定某个或多个反应类型，统计某 |
  |            |               | 个栅元内所有核素的反应截面。                   |
  +------------+---------------+------------------------------------------------+
  |            | AcceTally     | 指定是否使用计数器加速功能。                   |
  +------------+---------------+------------------------------------------------+
  | Convergence| SeMesh        | 定义香农熵网格。                               |
  +------------+---------------+------------------------------------------------+
  |            | FmMesh        | 定义裂变矩阵网格。                             |
  +------------+---------------+------------------------------------------------+
  |            | AcceFsc       | 指定源收敛加速方法和相关参数。                 |
  +------------+---------------+------------------------------------------------+
  | Burnup     | BurnCell      | 指定燃耗区。                                   |
  +------------+---------------+------------------------------------------------+
  |            | Power         | 指定总功率。                                   |
  +------------+---------------+------------------------------------------------+
  |            | PowerDen      | 指定总功率密度。                               |
  +------------+---------------+------------------------------------------------+
  |            | TimeStep      | 指定时间步长。                                 |
  +------------+---------------+------------------------------------------------+
  |            | BurnupStep    | 指定燃耗深度步长。                             |
  +------------+---------------+------------------------------------------------+
  |            | SubStep       | 指定内燃耗步长。                               |
  +------------+---------------+------------------------------------------------+
  |            | Inherent      | 指定重要核素继承份额。                         |
  +------------+---------------+------------------------------------------------+
  |            | AceLib        | 指定重要核素所匹配的ACE截面数据库。            |
  +------------+---------------+------------------------------------------------+
  |            | Strategy      | 指定是否使用预估-校正的燃耗步策略。            |
  +------------+---------------+------------------------------------------------+
  |            | Solver        | 指定燃耗方程求解方法。                         |
  +------------+---------------+------------------------------------------------+
  |            | Parallel      | 指定是否使用并行燃耗计算。                     |
  +------------+---------------+------------------------------------------------+
  |            | OutputCell    | 指定需要输出核素密度的栅元。                   |
  +------------+---------------+------------------------------------------------+
  |            | Varymat       | 指定在特定燃耗步变更材料信息。                 |
  +------------+---------------+------------------------------------------------+
  |            | Xeequilibrium | 定义平衡氙功能。                               |
  +------------+---------------+------------------------------------------------+
  |            | Succession    | 定义燃耗接续计算功能。                         |
  +------------+---------------+------------------------------------------------+
  |            | Naecf         | 定义燃耗区中子平均能量。                       |
  +------------+---------------+------------------------------------------------+
  |            | Impnuc        | 定义强制筛选进入临界计算的核素。               |
  +------------+---------------+------------------------------------------------+
  |            | FixedNuc      | 定义筛选进入临界计算的核素数目。               |
  +------------+---------------+------------------------------------------------+
  | Print      | Mat           | 指定是否输出所有材料信息。                     |
  +------------+---------------+------------------------------------------------+
  |            | Keff          | 指定是否输出每代的有效增殖因子。               |
  +------------+---------------+------------------------------------------------+
  |            | Source        | 指定是否输出每次的裂变源信息。                 |
  +------------+---------------+------------------------------------------------+
  |            | CellTally     | 指定是否输出栅元计数器。                       |
  +------------+---------------+------------------------------------------------+
  |            | MeshTally     | 指定是否输出网格计数器。                       |
  +------------+---------------+------------------------------------------------+
  |            | CsTally       | 指定是否输出截面计数器。                       |
  +------------+---------------+------------------------------------------------+
  | Plot       | ColorScheme   | 指定画图颜色方案                               |
  +------------+---------------+------------------------------------------------+
  |            | PlotID        | 指定参数                                       |
  +------------+---------------+------------------------------------------------+

输入格式
------------

RMC输入文件的格式应注意以下几点：

1. 每个模块以相应的关键词标识，模块之间以空行隔开。形如：

    .. code-block:: none

      Universe 0

      ……

      Universe 1

      ……

      Surface

      ……

      Material

      ……

      Criticality

      ……


2. 输入卡顶格写，输入卡中的选项卡以空格间隔。如果输入卡一行未写完，可换行后空
   格续写。例如：

     .. code-block:: none

       CellTally 2 type = 1 filter = 1 0 1 energy = 0 6.25E-7 20.0
                   cell = 2 > 0 > 1:289


3. 注释符使用“//”（C++风格）。

4. RMC输入文件不区分大小写。

5. 在windows下，不建议使用txt格式的文本文件作为输入文件。建议使用UltraEdit转换
   为Dos格式。


|

.. _section_geometry:

几何
==========

复杂几何描述是蒙卡程序相对于确定论程序的重要优势之一。与世界上其它绝大多数蒙卡程
序一样，RMC采用基于层级空间的几何描述系统（universe-based
geometry system）。

RMC的几何描述系统包括三类基本的几何描述单元，即，曲面（surface），栅元（cell）和
空间（universe）。一般地，物理系统由多个或单个层级空间组成，每个空间由一定数量的
栅元构成，栅元通过曲面方向（sense）的交并运算来定义。RMC几何输入模块的一般具有以下形式：

.. code-block::none

  UNIVERSE 0 // 描述最顶层的Universe模块
  Cell …     // 描述Universe模块当中的第1个栅元
  Cell …     // 描述Universe模块当中的第2个栅元
  ...

  UNIVERSE 1 // 描述用于填充的Universe模块
  ...

  SURFACE    // 描述曲面模块
  Surf ...   // 描述第1个曲面
  Surf ...   // 描述第2个曲面
  ...

.. _section_geometry_surface:

曲面（surface）
-------------------

曲面是RMC几何描述的最基本单元。考虑到MCNP用户的广泛性，RMC参考了MCNP的曲面定义方
式。曲面输入卡的定义方式为：

.. code-block:: none

  Surf <id> <type> {params} [bc = <flag>] [pair = <pair surf>] [value=<v1 v2 ... vn>] [time=<t1 t2 ... tn>]

其中，

-  **Surf** 是曲面输入卡关键词。

-  **id**\ 是曲面编号。编号为正整数，且不允许重复。

-  **type**\ 是曲面类型所对应的关键词，\ **params**\ 是曲面方程参数。
   :numref:`surftypes_table` 给出了RMC支持的曲面类型及相应的曲面方程。

-  **bc**\ 是曲面边界条件（boundary condition）。bc = 0（缺省值）表示真空边界条
   件，bc = 1表示全反射边界条件，bc = 2表示白边界条件，bc = 3表示周期边界条件。

-  **pair**\ 是在周期边界条件下两个周期面的另一个，pair surf 是与该 surf 配对的另
   一个周期面。
   另外，使用周期边界条件有如下限制：

      - 周期边界条件的面只能是平面，即 P/ PX/ PY/ PZ；
      - 周期边界条件的面只能是最外表面，即周期边界条件的平面的其中一边必须是重要性为零的 Cell
      - 配对的面必须平行，且不能有变形

-  **value**\ 卡和\ **time**\ 卡结合使用，描述曲面方程中最后一个参数随时间的变化规律，
   两个卡中输入的值的数目相等，表示当时间超过ti时，对应参数取为vi。

.. table:: 曲面类型
   :name: surftypes_table

   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 类型                | 关键词 | 说明              | 方程                                           | 曲面方程参数               |
   +=====================+========+===================+================================================+============================+
   | 平面                | **P**  | 一般              | :math:`Ax+By+Cz-D=0`                           |:math:`A,B,C,D`             |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **PX** | 垂直X轴           | :math:`x-D=0`                                  |:math:`D`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **PY** | 垂直Y轴           | :math:`y-D=0`                                  |:math:`D`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **PZ** | 垂直Z轴           | :math:`z-D=0`                                  |:math:`D`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 球面                | **SO** | 球心在原点        | :math:`x^2+y^2+z^2-R^2=0`                      |:math:`R`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **S**  | 一般              | :math:`(x-x_0)^2+(y-y_0)^2+(z-z_0)^2-R^2=0`    |:math:`x_0,y_0,z_0,R`       |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **SX** | 球心在X轴         | :math:`(x-x_0)^2+y^2+z^2-R^2=0`                |:math:`x_0,R`               |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **SY** | 球心在Y轴         | :math:`x^2+(y-y_0)^2+z^2-R^2=0`                |:math:`y_0,R`               |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **SZ** | 球心在Z轴         | :math:`x^2+y^2+(z-z_0)^2-R^2=0`                |:math:`z_0,R`               |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 圆柱面              | **C/X**| 平行于X轴         | :math:`(y-y_0)^2+(z-z_0)^2-R^2=0`              |:math:`y_0,z_0,R`           |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **C/Y**| 平行于Y轴         | :math:`(x-x_0)^2+(z-z_0)^2-R^2=0`              |:math:`x_0,z_0,R`           |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **C/Z**| 平行于Z轴         | :math:`(x-x_0)^2+(y-y_0)^2-R^2=0`              |:math:`x_0,y_0,R`           |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **CX** | 轴心在X轴         | :math:`y^2+z^2-R^2=0`                          |:math:`R`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **CY** | 轴心在Y轴         | :math:`x^2+z^2-R^2=0`                          |:math:`R`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **CZ** | 轴心在Z轴         | :math:`x^2+y^2-R^2=0`                          |:math:`R`                   |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 圆锥面              | **K/X**| 平行于X轴         | :math:`\sqrt{(y-y_0)^2+(z-z_0)^2}=\pm t(x-x_0)`|:math:`x_0,y_0,z_0,t^2,\pm1`|
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **K/Y**| 平行于Y轴         | :math:`\sqrt{(x-x_0)^2+(z-z_0)^2}=\pm t(y-y_0)`|:math:`x_0,y_0,z_0,t^2,\pm1`|
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **K/Z**| 平行于Z轴         | :math:`\sqrt{(x-x_0)^2+(y-y_0)^2}=\pm t(z-z_0)`|:math:`x_0,y_0,z_0,t^2,\pm1`|
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **KX** | 轴心在X轴         | :math:`\sqrt{y^2+z^2}=\pm t(x-x_0)`            |:math:`x_0,t^2,\pm1`        |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **KY** | 轴心在Y轴         | :math:`\sqrt{x^2+z^2}=\pm t(y-y_0)`            |:math:`y_0,t^2,\pm1`        |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **KZ** | 轴心在Z轴         | :math:`\sqrt{x^2+y^2}=\pm t(z-z_0)`            |:math:`z_0,t^2,\pm1`        |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 椭球面/双曲面/抛物面| **SQ** | 轴平行于X、Y或Z轴 | :math:`A(x-x_0)^2+B(y-y_0)^2+C(z-z_0)^2        |:math:`A,B,C,D,E,F,G,x_0,y_0|
   |                     |        |                   | +2D(x-x_0)+2E(y-y_0)+2F(z-z_0)+G=0`            |,z_0`                       |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 圆柱面/圆锥面/椭球面| **GQ** | 轴不平行于X、Y    | :math:`Ax^2+By^2+Cz^2+Dxy+Eyz+Fzx+Gx+Hy+Jz+K=0`|:math:`A,B,C,D,E,F,G,H,J,K` |
   | /双曲面/抛物面      |        | 或Z轴             |                                                |                            |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   | 椭圆或圆形的圆环面  | **TX** | 平行于X轴         | :math:`(x-x_0)^2/B^2+                          |:math:`x_0,y_0,z_0,A,B,C`   |
   |                     |        |                   | (\sqrt{(y-y_0)^2+(z-z_0)^2}-A)^2/C^2-1=0`      |                            |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **TY** | 平行于Y轴         | :math:`(y-y_0)^2/B^2+                          |:math:`x_0,y_0,z_0,A,B,C`   |
   |                     |        |                   | (\sqrt{(x-x_0)^2+(z-z_0)^2}-A)^2/C^2-1=0`      |                            |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+
   |                     | **TZ** | 平行于Z轴         | :math:`(z-z_0)^2/B^2+                          |:math:`x_0,y_0,z_0,A,B,C`   |
   |                     |        |                   | (\sqrt{(x-x_0)^2+(y-y_0)^2}-A)^2/C^2-1=0`      |                            |
   +---------------------+--------+-------------------+------------------------------------------------+----------------------------+


.. _section_geometry_cell:

栅元（cell）
----------------

栅元输入卡的定义方式为：

.. code-block:: none

  Cell <id> {surf_bool_definition} {cell_info}


其中，

-  **Cell** 是栅元输入卡关键词。

-  **id**\ 是栅元编号。编号为正整数，且不允许重复。

-  **surf_bool_definition**\ 指栅元的曲面布尔定义，由带方向的曲面和布尔运算符组
   成，用来定义栅元区域。\ **cell_info**\ 定义了该栅元的其它相关信息。下面将分别阐述。

栅元的曲面布尔定义
~~~~~~~~~~~~~~~~~~~~~~~~

栅元的曲面布尔定义由一系列曲面和布尔运算符组成，形如：

.. code-block:: none

  <±surf> <boolean> <±surf> <boolean> <±surf> …

曲面方向（sense）的定义为：如果点（x,y,z）在一个曲面方程\ *f* (*x,y,z*)的计算值
为\ *f* (*x,y,z*) > 0，则称该点对于这个曲面是正向的；若计算值为\ *f* (*x,y,z*) <
0，则为负向；若计算值为\ *f* (*x,y,z*) = 0，则表明该点在曲面上。
:numref:`surfsense_fig` 给出了某二次曲面的方向所对应的区域：

.. figure:: media/surface_sense.png
   :width: 4.5in
   :name: surfsense_fig

   曲面方向示意图

RMC的布尔运算符包括交集（&）、并集（:）和补集（!）两种，并支持用圆括号调整运算优
先级。\ *补集的优先级高于交集和并集*\ ；\ *交集和并集的优先级相同*\ ，按照定义的
先后顺序进行逻辑运算；\ *圆括号的优先级最高*\ ，并且可以使用多层圆括号嵌套，类似
于算术运算。假设栅元1和栅元2的几何描述分别为：

.. code-block:: none

  栅元1： (1 & -2) : 3

  栅元2： 4 & -5 : !1

栅元1所表示的几何区域为：（曲面1的正向 ∩ 曲面2的负向）∪ 曲面3的正向

栅元2所表示的区域为：（曲面4的正向 ∩ 曲面5的负向）∪ 非栅元1。栅元2的另一种等价
描述方式为：4 & 5 : !( (1 & -2) : 3)。需要注意的是，若“!”之后紧跟数字，则表示非
栅元；若“!”之后为括号，则表示非曲面。

栅元信息选项卡
~~~~~~~~~~~~~~~~~~~~

栅元信息选项卡由一系列选项卡组成，主要用于描述栅元的物理和几何参数，包括材料、体
积、温度、层级填充信息、几何变换，等。

.. code-block:: none

    Cell … [Mat = <id>] [Vol = <vol>] [Tmp = <tmp>]
    [Dens = <dens>] [Void = <flag>] [Fill = <id>] [Inner = <flag>]
    [Move = <params>] [Rotate = <params>] [Noburn = <flag>]


其中，

-  **Mat**\ 选项卡定义该栅元的填充材料，缺省值为\ **Mat=0（真空）**\ 。

-  **Vol**\ 选项卡定义该栅元的体积，单位为cm\ :sup:`3`\ ，缺省值为\ **Vol=1.0**\ cm\ :sup:`3`\ 。

-  **Tmp**\ 选项卡定义该栅元的温度。用户可输入大于0的自然数，或小于0的整数。
   当输入的值大于0时，表示输入了该栅元的温度，单位为K；当输入的值小于0时，表示
   用户输入了该栅元的温度网格（详见网格章节），单位为K；当用户未输入该选项卡时，
   默认用户输入了\ **293.6（K）**\ 。
   当栅元温度与栅元内填充的材料的温度不匹配时，如果用户未指定任何在线展宽选项，
   程序将对核素截面热化区进行简单修正；若用户指定了在线展宽选项，则按照用户指定
   的选项进行在线多普勒展宽或在线插值。

-  **Dens**\ 选项卡定义该栅元的密度。用户可输入大于0的自然数，或小于0的整数。
   当输入的值大于0时，表示输入了该栅元的原子密度，
   单位为10\ :sup:`24`\ 原子/cm\ :sup:`3`\ ；当输入的值小于0时，表示
   用户输入了该栅元的温度网格（详见网格章节），单位为g/cm\ :sup:`3`\ ；
   当用户未输入该选项卡时，默认用户输入的密度与所填充材料的密度保持一致。
   \ **需要注意的是，当前版本的程序不支持对燃耗栅元使用该选项**\ 。

-  **Void**\ 选项卡指定中子进入该栅元后是否停止跟踪，主要用于描述真空边界以外的
   区域。\ **Void=0**\ （缺省值），中子进入该区域继续跟踪；\ **Void=1**\ ，中子
   进入该区域停止跟踪；

-  **Fill** 选项卡定义该栅元内部填充的空间，详见后续章节。

-  **Inner**\ 选项卡指定该栅元是否为内部栅元，即，在填充过程中未被外层边界分割。
   \ **Inner= 0**\ （缺省值）表示非内部栅元，\ **Inner =1**\ 表示内部栅元。指定
   内部 栅元可以加速几何处理，但错误地指定内部栅元会导致几何跟踪出错，因此只建议
   高级用户使用。

-  **Move**\ 选项卡定义该栅元的平移向量，**Rotate**\ 选项卡定义该栅元几何变换的旋转矩阵的转置，
   分别类似于3.3.3 空间几何变换的move和rotate卡。对栅元进行几何变换时，是先旋转，再平移。
   对于被填充的栅元，是连同其内部填充结构做整体变换。这里不支持对包含圆环面(TX/TY/TZ)的旋转。

-  **Noburn**\ 选项卡定义该栅元是否参与燃耗计算。\ **Noburn = 0**\ 
   （缺省值）表示不参与燃耗计算，\ **Noburn = 0**\ 表示参与燃耗计算。

.. _section_geometry_universe:

空间（universe）
--------------------

单层空间
~~~~~~~~~~~~~~

空间由一系列栅元组合而成，且这些栅元之间\ *不能存在重叠或未定义区域*\ 。单层空间
输入卡的形式为：

.. code-block:: none

  UNIVERSE <id> [options]


其中，\ **id**\ 是空间编号。\ **options**\ 是与空间几何变换、重复结构相关的选项
，形式如下，后面将具体述及。

.. code-block:: none

  [Move = <params>] [Rotate = <params>] [Lat = <params>] [DISP = <params>]
  [Pitch = <params>] [Scope = <params>] [Sita = <param>] [Fill = <params>]

对任意的物理系统，至少需要一个空间来描述，这在输入文件中定义为Universe 0。例如，
以下输入文件是一个普通压水堆栅元的几何部分。这里将栅元1顺时针旋转90°。

.. code-block:: c

    /////// PWR pin: defined in single universe /////////////
    Universe 0
    cell 1 -10      mat = 1   move=0 0 0 rotate=0 -1 0 1 0 0 0 0 1// Fuel Pin
    cell 2 !1 & -11 mat = 2                // Air
    cell 3 11 & -12 mat = 3                // cladding
    cell 4 12 & 13 & -14 & 15 & -16 mat= 4 // water
    cell 5 -13 : 14 : -15 : 16 void = 1    // outside

    Surface
    surf 10 cz 0.4096
    surf 11 cz 0.4178
    surf 12 cz 0.4750
    surf 13 px -0.63 bc = 1
    surf 14 px 0.63 bc = 1
    surf 15 py -0.63 bc = 1
    surf 16 py 0.63 bc = 1

若该单层空间用于随机栅格扰动法填充上层重复结合结构，则需要用到DISP关键词对随机颗
粒球心位置进行扰动，具体方法及输入在3.3.3节进行说明。

多层空间
~~~~~~~~~~~~~~

对于复杂的物理系统，可能需要用到空间填充的描述方式，即，将某个空间填充到另一个空
间的某个栅元当中。\ *注意，填充空间应涵盖被填充的栅元区域，*\ 否则该栅元区将存在
未定义的空白区域，造成粒子跟踪错误。

空间填充的选项卡内嵌在栅元输入卡中（参考3.2.2）：

.. code-block:: none

  Cell ... [Fill = <universe>]


对上例中的压水堆栅元，我们可以使用空间填充的方式来等价地进行描述，如下所示。首先
，定义了燃料棒及慢化剂区域（Universe 1），然后将其填充至栅元格（cell 102）。

.. code-block:: c

  /////// PWR pin: defined in multilevel universe /////////////
  Universe 0
  cell 101 13 & -14 & 15 & -16 Fill = 1 // define a cell filled by a universe
  cell 102 -13 : 14 : -15 : 16 void = 1 // outside the box

  Universe 1
  cell 1 -10      mat = 1 // Fuel Pin
  cell 2 10 & -11 mat = 2 // Air
  cell 3 11 & -12 mat = 3 // cladding
  cell 4 12       mat = 4 // water

  Surface
  surf 10 cz 0.4096
  surf 11 cz 0.4178
  surf 12 cz 0.4750
  surf 13 px -0.63 bc = 1
  surf 14 px 0.63  bc = 1
  surf 15 py -0.63 bc = 1
  surf 16 py 0.63  bc = 1


几何变换
~~~~~~~~~~~~~~

RMC支持对空间（universe）的平移变换/旋转变换/随机扰动（随机颗粒的球心坐标）。几何变换选
项卡内嵌在空间输入卡当中：

.. code-block:: none

  Universe ... [Move = Mx My Mz]
  [Rotate =Cx'x Cx'y Cx'z Cy'x Cy'y Cy'z Cz'x Cz'y Cz'z ]

平移变换的表达式为:

.. math::

    \mathbf{r'} = \mathbf{r} + \mathbf{m}

其中， :math:`\mathbf{r}=(r_x,r_y,r_z)` 和 :math:`\mathbf{r}=(r_x',r_y',r_z')` 分
别为变换前和变换后的空间任意一点的位置坐标， :math:`\mathbf{m}=(m_x,m_y,m_z)` 为
平移变换向量。

旋转变换可以绕任意轴，其表达式为：

.. math::

    \mathbf{r'} = \mathbf{R} \cdot \mathbf{r}

其中， :math:`\mathbf{R}` 为旋转变换矩阵。RMC实际要求用户输入的是旋转变换矩阵的
转置矩阵 :math:`\mathbf{R}^T` ，其参数按照以下方式定义：给定某直角坐标
系 :math:`(x,y,z)` ，它经过该旋转变换后得到新坐标系 :math:`(x',y',z')` ，
则 :math:`\mathbf{R}^T` 可表示为

.. math::

    \mathbf{R}^T = \begin{bmatrix} C_{x'x} & C_{x'y} &C_{x'z} \\ C_{y'x}
    & C_{y'y} &C_{y'z} \\ C_{z'x} & C_{z'y} &C_{z'z} \end{bmatrix}

其中， :math:`C_{x'x}` 表示 :math:`x` 和 :math:`x'` 两个坐标轴之间的夹角余弦，以
此类推。

*注意，如果对某个空间同时做旋转变换和平移变换，应先旋转，再平移。对于多层空间，
对某个空间的几何变换总是连同其内部填充结构做整体变换。此外，Universe
0是基准空间，因此不允许对Universe 0做几何变换。*

使用几何变换的方式，我们重新定义上面的压水堆栅元，如下所示。燃料棒和慢化剂区域
（Universe1）定义为与x轴平行，通过平移（move = 0.5 0.5 0）和旋转（rotate = 0 0 -1
0 1 0 1 0 0），填充到栅元格（Cell 102）中。

.. code-block:: c

  // PWR pin: defined in multilevel universe with coordinate transformation //
  Universe 0
  cell 101 13 & -14 & 15 & -16 Fill = 1 // define a cell filled by a universe
  cell 102 -13 : 14 : -15 : 16 void = 1 // outside the box

  Universe 1 move = 0.5 0.5 0 rotate = 0 0 -1 0 1 0 1 0 0
  cell 1 -10      mat = 1 // Fuel Pin
  cell 2 10 & -11 mat = 2 // Air
  cell 3 11 & -12 mat = 3 // cladding
  cell 4 12       mat = 4 // water

  Surface
  surf 10 c/x -0.5 -0.5 0.4096
  surf 11 c/x -0.5 -0.5 0.4178
  surf 12 c/x -0.5 -0.5 0.4750
  surf 13 px -0.63 bc = 1
  surf 14 px 0.63 bc = 1
  surf 15 py -0.63 bc = 1
  surf 16 py 0.63 bc = 1

对于随机栅格扰动法，DISP参数用于填充重复几何结构的单层空间，球心坐标扰动方程为：

.. math::

    x& =x'+(2\xi_{1}-1) \times \delta_{x} \\
    y& =y'+(2\xi_{2}-1) \times \delta_{y} \\
    z& =z'+(2\xi_{3}-1) \times \delta_{z}


其中， :math:`\xi_i` 为(0,1)之间的随机数， :math:`\delta_i` 为对应坐标轴方向的扰动幅度。
\ **注意：坐标转换的随机扰动幅度不能超过栅格的边界。**\

以下是随机栅格扰动法的一个输入示例：

.. code-block:: c

    ////////  HTR 5*5*5 lattice, liu-sc, 2014-10-28 ////////
    UNIVERSE 2 lat = 1  pitch = 0.1982 0.1982 0.1982    scope = 5  5  1  fill =
      1 1 1 1 1
      1 1 1 1 1
      1 1 1 1 1
      1 1 1 1 1
      1 1 1 1 1

    UNIVERSE 1 move = 0.0991 0.0991 0.0991      Disp=0.0536 0.0536 0.0536
    cell  3   -1       mat = 3   //fuel
    cell  4   1 & -2   mat = 1     //1.1C
    cell  5   2 & -3   mat = 4     //1.9C
    cell  6   3 & -4   mat = 2     //SiC
    cell  7   4 & -5   mat = 4    //1.1C
    cell  8   5        mat = 4    //1.1C


.. _section_geometry_lattice:

重复结构（lattice）
-----------------------

重复结构是一类特殊的空间，该空间由规则排列的网格组成。RMC支持常用的四边形重复结
构和六边形重复结构，它们在反应堆堆芯计算分析时最为常见。四边形重复结构可以建立在
1维、2维平面或3维空间，六边形重复结构建立在2维平面。

同时，为了描述弥散燃料介质随机模型，RMC在重复结构选项卡中增加了两个特殊选项，分别
为隐式模拟方法和显式模拟方法。
**（注意：RMC的随机介质功能仅企业版本提供）**
RMC隐式方法采用弦长抽样法（CLS），通过概率分布函数
在线抽样确定随机介质燃料颗粒的位置，其特点是不需要显式构建众多燃料颗粒的位置，因此
在填充率上没有严格限制。其缺点是计算精确性比显式模拟差一些，并且填充率高时，实际
填充率与目标填充率存在差别，需要通过修正改善精度。RMC的显式方法采用随机介质序列添加法
（RSA），在输运计算前会显式确定每一个弥散介质燃料颗粒的空间位置，因此实际填充率即为
目标填充率。但由于方法的固有特性，填充率不宜过高，上限值为38%，越接近上限则产生颗粒的时间越长。

重复结构选项卡内嵌在空间
（universe）输入卡当中：

.. code-block:: none

  Universe … [Lat = <type>]


其中，\ **Lat = 1**\ 表示四边形重复结构，\ **Lat = 2**\ 表示六边形重复结构，\ **Lat = 3**\ 表示
显式建模法随机几何，\ **Lat = 4**\ 表示弦长抽样法随机几何。下面针对这两种重复结构类型分别阐述。

四边形重复结构
~~~~~~~~~~~~~~~~~~~~

:numref:`lattice_mesh_fig` 给出了四边形重复结构的示意图。\ *四边形重复网格建立在xyz坐标系，坐标原点O建
立在第一个网格（编号为1）的左下角点*\ 。

.. figure:: media/lattice_mesh.png
   :width: 4.5in
   :name: lattice_mesh_fig

   四边形重复结构示意图

四边形重复结构的选项卡为：

.. code-block:: none

  Universe … [Lat = 1] [Scope = <xNum yNum zNum>]
  [Pitch = <xLen yLen zLen>] [Fill = <U1 U2 … UM>]


其中，

-  **Lat = 1**\ 表示重复结构类型为四边形。

-  **Scope**\ 选项卡定义重复网格在x，y，z方向的数量。特别地，参数为1表示该方向上
   只有一层网格。例如，2维PWR组件的重复网格表示为\ **Scope = 17 17 1**\ 。需要指
   出的是，尽管程序支持直接定义3维四边形重复结构，但建议用户通过2维重复结构和1维
   重复结构的填充方式来生成3维重复结构。

-  **Pitch**\ 选项卡定义重复网格在x，y，z方向的宽度，参数必须为正。若某方向只有
   一层网格，\ **Pitch**\ 选项卡中对应的参数没有实际意义。

-  **Fill**\ 选项卡依次定义网格内填充的空间（universe）的编号，一共
   有 :math:`M = xNum \times yNum \times zNum` 个编号。\ **Fill**\ 选项卡的填充
   次序为：\ **先按x方向填充，再按y方向填充，最后按照z方向
   填充**\ 。:numref:`lattice_mesh_fig` 给出了四边形重复结构的索引下标的编号方式
   ，对应\ **Fill**\ 选项卡的填充顺序，同时也对应重复结构计数器的编号。

在使用随机栅格扰动法时，需要对四边形重复结构填充的Universe添加disp选项，具体内容参见3.3.3后半部分。

六边形重复结构
~~~~~~~~~~~~~~~~~~~~

.. figure:: media/lattice_hex.png
   :width: 4.5in
   :name: lattice_hex_fig

   六边形重复结构示意图

六边形重复网格的排列方式见 :numref:`lattice_hex_fig` 。不难发现，各个六边形的中心
按照平行四边形的方式
排列。平行四边形的两条边所对应的方向向量b1和b2位于xy平面内，b1与x方向重合。

六边形重复结构的选项卡为：

.. code-block:: none

  Universe … [Lat = 2] [Scope = <b1Num b2Num>] [Sita = <sita>]
  [Pitch = <b1Len b2Len>] [Fill = <U1 U2 … Um]


其中，

-  **Lat = 2**\ 表示重复结构类型为六边形。

-  **Scope**\ 选项卡定义重复网格在b\ :sub:`1`\ 和b\ :sub:`2`\ 方向的数量。

-  **Pitch**\ 选项卡定义重复网格在b\ :sub:`1`\ 和b\ :sub:`2`\ 方向的宽度。

-  **Sita**\ 选项卡定义六边形网格其中一对邻边的夹角（如图所示），单位为度°。

-  **Fill**\ 选项卡依次定义网格内填充的空间（universe）的编号，一共
   有 :math:`M = b_1Num \times b_2Num` 个编号。
   \ **Fill**\ 选项卡的填充次序为：先按 :math:`M = b_1` 方向（即x方向）填充，
   再按 :math:`M = b_2` 方向填充，具体次序见 :numref:`lattice_hex_fig` 给出的编号。

需要指出的是，\ **与四边形重复结构不同的是，六边形重复结构总是建立在xy平面，坐标
原点O建立在第一个重复六边形（编号为1）的中心。通过平移和旋转变换，可以将其转换到
其它平面。**

弦长抽样随机几何（仅限企业版本）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

弦长抽样随机几何的选项卡为：

.. code-block:: none

    Universe … [Lat = 3] [MATRIC = <UM>] [PARTICLE = <U1 U2 … UP>]
    [PF = <pf1 pf2 … pfp>] [RAD = <rad1 rad2 … radp>]
    [TYPE = <1/2/3>] [SIZE = <size>] [PFCORRECT]


其中，

-  **Lat = 3**\ 表示弦长抽样法随机几何。

-  **MATRIC**\ 选项卡定义基体所在空间（universe）的编号。

-  **PARTICLE**\ 选项卡定义颗粒所在空间（universe）的编号。通过其后定义的Ui标识
   分辨不同类型的燃料颗粒，一种燃料对应一个空间（universe）的编号。

-  **PF**\ 选项卡定义颗粒占其填充的几何的体积份额。

-  **RAD**\ 选项卡定义颗粒的半径。

-  **PFCORRECT**\ 选项卡定义是否使用隐式方法自动修正，若选用该模式，
   在临界计算前会对填充率进行自动校正。0表示不用校正方法，为默认选项，
   1表示开启自动校正模式。(注： **隐式方法填充率自动修正模式不兼容固定源模式**\ )


显式建模法随机几何（仅限企业版本）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

显式建模法随机几何的选项卡为：

.. code-block:: none

    Universe … [Lat = 4] [MATRIC = <UM>] [PARTICLE = <U1 U2 … UP>]
    [PF = <pf1 pf2 … pfp>] [RAD = <rad1 rad2 … radp>]
    [RSA = <0/1>] [TYPE = <1/2/3>] [SIZE = <size>]
    [DEM = <0/1>] [TIME = <time>]


其中，

-  **Lat = 4**\ 表示显式建模法随机几何。

-  **MATRIC**\ 选项卡定义基体所在空间（universe）的编号。

-  **PARTICLE**\ 选项卡定义颗粒所在空间（universe）的编号。通过其后定义的Ui标识
   分辨不同类型的燃料颗粒，一种燃料对应一个空间（universe）的编号。

-  **PF**\ 选项卡定义颗粒占其填充的几何的体积份额。

-  **RAD**\ 选项卡定义颗粒的半径。

-  **RSA**\ 选项卡定义随机颗粒的产生方式，RSA = 1 表示颗粒位置由程序内部使用RSA方法产生，
   并产生存储颗粒位置的文本,名字为 “ random\_geometry\_[当前空间号(Lat=4)] ”；RSA = 0表示
   球的位置从外部文件读取，外部文件的名字为 “ random\_geometry\_[当前空间号(Lat=4)] ”。

   \ **注意** 颗粒产生文件的格式为：

   x坐标  y坐标  z坐标  颗粒最外层半径   颗粒空间编号（用户编号）

   \ **例如** :

   -1.67308E+00  2.92296E-01  1.07829E+00  4.55000E-02 1
 
   这里，坐标及半径的单位是cm，位置坐标是颗粒球心坐标，对应的坐标系
   原点是随机介质区域中心

-  **TYPE**\ 选项卡定义被颗粒填充几何的形状，TYPE = 1表示颗粒填充的形状为球体，
   TYPE = 2表示被颗粒填充的形状为圆柱体，TYPE = 3表示被颗粒填充的形状为长方体。

-  **SIZE**\ 选项卡定义被颗粒填充几何的尺寸。TYPE = 1时，输入球的半径（一个参数），
   TYPE = 2时依次输入圆柱体的半径和高（两个参数），TYPE = 3时，依次输入长方体的长宽高
   （x,y,z三个参数）。

-  **DEM**\ 选项卡选择是否使用DEM方法产生随机颗粒以获得更高的填充率，DEM = 1 表示颗粒位置使用DEM方法产生，
   并产生存储颗粒位置的文本,名字同样为 “ random\_geometry\_[当前空间号(Lat=4)]” ,此时坐标系为随机介质区域中心坐标系，
   这个文件可以被RMC直接读取进行计算；DEM= 0表示不使用DEM方法产生颗粒。需要注意的是：\ **选取DEM的
   方法获得更高的填充率时必须先进行RSA计算，RSA的输入卡片必须为1，且相关选项卡也必须填写完全**。

-  **TIME**\ 选项卡定义DEM方法产生小球的下落时间(自落体体时间),单位为s，一般建议时间设置为颗粒下落两倍的几何高度所需时间的两倍。
   例如几何高度为1m时，建议时间设置为1s。

需要注意的是，\ **显式建模法的Lattice所在的空间的坐标原点不是在球、圆柱、长方体的几何中心
而是在定位小球位置的网格中，坐标原点为网格的左下角角点。如下图所示：**

.. figure:: media/StochasticMedium/explicit_coordinate.png
   :width: 4.5in

   显式建模法坐标原点

\ **显式建模法的Lattice所在的空间去填充Cell的时候，要根据被填充Cell
的坐标原点进行必要的坐标平移。Particle空间定义建议球心定位于原点，即选用so类型面。**



几何模块输入示例
--------------------

PWR组件
~~~~~~~~~~~~~

:numref:`pwr_assembly_input` 是一个PWR17×17组件（ :numref:`pwr_assembly_fig` ）
的输入示例。Universe 1和Universe 3分别为燃料栅
元和管道栅元，中心坐标在（0, 0, 0）。Universe 8为四边形重复结构。因为四边形重复
结构的下角点总是建立在（0, 0, 0），所以Universe 8的第一个网格的中心点位置为
（0.63, 0.63, 0）。将Universe 1和Universe 3按照向量（0.63, 0.63, 0）平移后，填充
到Universe 8的第一个网格中，然后按照四边形重复结构排列展开。

.. figure:: media/pwr_assembly_17by17.png
   :name: pwr_assembly_fig

   PWR17×17组件

|

.. code-block:: c
  :caption: 17x17组件几何输入示例
  :name: pwr_assembly_input

  // STANDARD WESTINGHOUSE 17*17 ASSEMBLY MODEL. SHE DING : 2012-03-08 //
  UNIVERSE 0
  CELL 1 6 & -7 & 8 & -9 mat = 0 Fill = 8 // Assembly inside
  CELL 2 -6 : 7 : -8 : 9 mat = 0 void = 1 // Assembly outside

  UNIVERSE 8 lat = 1 pitch = 1.26 1.26 1 scope = 17 17 1 fill =
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 3 1 1 3 1 1 3 1 1 1 1 1
      1 1 1 3 1 1 1 1 1 1 1 1 1 3 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 3 1 1 1 1 1 1 1 1 1 3 1 1 1
      1 1 1 1 1 3 1 1 3 1 1 3 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

  UNIVERSE 1 move = 0.63 0.63 0   // Fuel rod
  cell 3 -1     mat = 1 inner = 1 // Fuel
  cell 4 1 & -2 mat = 3 inner = 1 // Air
  cell 5 2 & -3 mat = 4 inner = 1 // Zr
  cell 6 3      mat = 5           // water

  UNIVERSE 3 move = 0.63 0.63 0 // Guide tube
  cell 11 -4     mat = 5 inner = 1 // water
  cell 12 4 & -5 mat = 4 inner = 1 // Air
  cell 13 5      mat = 5           // water

  SURFACE
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 4 cz 0.5690
  surf 5 cz 0.6147
  surf 6 px 0     bc = 1
  surf 7 px 21.42 bc = 1
  surf 8 py 0     bc = 1
  surf 9 py 21.42 bc = 1

  MATERIAL
  mat 1 -10.196
      92235.30c 6.9100E-03
      92238.30c 2.2062E-01
      8016.30c 4.5510E-01
  mat 3 -0.001
      8016.30c 3.76622E-5
  mat 4 -6.550
      40000.60c -98.2
  mat 5 9.9977E-02
      1001.30c 6.6643E-02
      8016.30c 3.3334E-02
  sab 5 lwtr.60t

  CRITICALITY
  PowerIter population = 10000 50 300 // keff0 = 1.0
  InitSrc point = 0.63 0.63 0



PWR堆芯
~~~~~~~~~~~~~

:numref:`pwr_core_input` 是一个PWR堆芯几何模块输入示例。简单起见，堆芯输入文件仅
包含一种类型的组件
。堆芯（Cell 1）被填充21×21的四边形重复结构（Universe 1），其中包括组件网格和反
射层网格。组件（Universe 3）是17×17的四边形重复结构，填充有燃料栅元（Universe 6）
和管道栅元（Universe 7）。


.. code-block:: c
  :caption: PWR堆芯几何输入示例
  :name: pwr_core_input

  ////////// PWR core. SHE Ding 2012-07-01 ////////////
  UNIVERSE 0
  CELL 1 -10 mat = 0 Fill = 1 // Core inside
  CELL 2 10 mat = 0 void = 1 // Core outside

  UNIVERSE 1 lat = 1 pitch = 21.42 21.42 1 scope = 21 21 1 Fill = // core lattice zone
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 3 3 3 3 3 3 3 2 2 2 2 2 2 2
      2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2
      2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2
      2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2
      2 2 2 2 2 2 2 3 3 3 3 3 3 3 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2

  UNIVERSE 2 // reflector
  cell 21 1 mat = 5
  cell 22 -1 mat = 5

  UNIVERSE 3 lat = 1 pitch = 1.26 1.26 1 scope = 17 17 1 fill = // assembly
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 6 6 7 6 6 7 6 6 7 6 6 6 6 6
      6 6 6 7 6 6 6 6 6 6 6 6 6 7 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 7 6 6 7 6 6 7 6 6 7 6 6 7 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 7 6 6 7 6 6 7 6 6 7 6 6 7 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 7 6 6 7 6 6 7 6 6 7 6 6 7 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 7 6 6 6 6 6 6 6 6 6 7 6 6 6
      6 6 6 6 6 7 6 6 7 6 6 7 6 6 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
      6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6

  UNIVERSE 6 move = 0.63 0.63 0   // Fuel rod
  cell 3 -1     mat = 1 inner = 1 // Fuel
  cell 4 1 & -2 mat = 3 inner = 1 // Air
  cell 5 2 & -3 mat = 4 inner = 1 // Zr
  cell 6 3      mat = 5           // water

  UNIVERSE 7 move = 0.63 0.63 0    // Guide tube
  cell 11 -4     mat = 5 inner = 1 // water
  cell 12 4 & -5 mat = 4 inner = 1 // Air
  cell 13 5      mat = 5           // water

  SURFACE
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 4 cz 0.5690
  surf 5 cz 0.6147
  surf 10 c/z 224.91 224.91 209 bc = 1 // container

  MATERIAL
  mat 1 -10.196
      92235.30c 6.9100E-03
      92238.30c 2.2062E-01
      8016.30c 4.5510E-01
  mat 3 -0.001
      8016.30c 3.76622E-5
  mat 4 -6.550
      40000.60c -98.2
  mat 5 9.9977E-02
      1001.30c 6.6643E-02
      8016.30c 3.3334E-02
  sab 5 lwtr.60t

  CRITICALITY
  PowerIter population = 100000 250 500 // keff0 = 1.0
  InitSrc point = 224.91 226.17 0



六边形组件
~~~~~~~~~~~~~~~~

.. figure:: media/lattice_hex_assembly.png
   :name: lattice_hex_assembly_fig

   六边形组件结构简化示意图

:numref:`lattice_hex_assembly_input` 是一个六边形组件的简化输入示例，包含61个六边形燃料栅元。
:numref:`lattice_hex_assembly_fig` 中蓝色为燃
料，黄色为绕线，红色为冷却剂，绿色为反射层。Universe 1为六边形重复结构，其中
Universe 2和Universe 3分别为冷却剂栅元和燃料栅元。由 :numref:`lattice_hex_fig`
中六边形的排列结构可知，
六边形重复结构的原点在左下角六边形的中心，所以Universe 1需要向x和y方向分别移动
-15和-9.05，才能使得Universe 1的中心与Cell 1的中心重合。

|

.. code-block:: c
  :caption: 六边形组件输入示例
  :name: lattice_hex_assembly_input

  ///////////// MFR ASSEMBLY. FAN Xiao 2012-09-17 /////////////
  Universe 0
  cell 1 -1 & -2 & -3 & 4 & -5 & -6 & 7 & -8 mat = 0 fill = 1 //Assembly inside
  cell 2 16 : -17 : 18 mat = 0 void = 1 //Assembly outside
  cell 3 -16 & 17 & -18 & (1 : 2 : 3 : -4 : 5 : 6 : -7 : 8) mat = 5 //reflector

  niverse 1 move=-15 -9.05 0 lat=2 pitch=2 2.06787 scope=11 11 sita=63.435 fill=
      2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 3 3 3 3 3 2
      2 2 2 2 3 3 3 3 3 3 2
      2 2 2 3 3 3 3 3 3 3 2
      2 2 3 3 3 3 3 3 3 3 2
      2 3 3 3 3 3 3 3 3 3 2
      2 3 3 3 3 3 3 3 3 2 2
      2 3 3 3 3 3 3 3 2 2 2
      2 3 3 3 3 3 3 2 2 2 2
      2 3 3 3 3 3 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2

  Universe 2
  cell 21 -15 mat = 1
  cell 22 15 mat = 1

  Universe 3
  cell 31 -15 mat = 2
  cell 32 15 mat = 3

  Surface
  surf 1 py 8.4
  surf 2 p 1.732 1 0 16.3
  surf 3 p 1.732 -1 0 16.3
  surf 4 py -8.4
  surf 5 p -1.732 -1 0 16.3
  surf 6 p -1.732 1 0 16.3
  surf 7 pz -30
  surf 8 pz 30
  surf 15 cz 0.975
  surf 16 cz 30
  surf 17 pz -35
  surf 18 pz 35

  Material
  mat 1 -0.8139 // Na
      11023.30c 1.0
  mat 2 -10.41 // UO2
      92235.30c -56.5 92238.30c -31.1 8016.30c -12.3 13027.30c -0.02
      20000.60c -0.02 12000.60c -0.02 26000.55c -0.02 14000.60c -0.02
  mat 3 -0.8355 // wiry
      11023.30c 2.132E+0 28000.50c 3.223E-3
      24000.50c 4.759E-3 26000.55c 1.634E-2
  mat 5 0.1236 // Be9
      4009.30c 1

  Criticality
  PowerIter keff0 = 1.0 population = 2000 50 300
  InitSrc point = 0 0 0



六边形堆芯
~~~~~~~~~~~~~~~~

.. figure:: media/lattice_hex_core.png
   :name: lattice_hex_core_fig

   六边形堆芯结构简化示意图

:numref:`lattice_hex_core_input` 是一个六边形堆芯几何模块的简化输入示例。
:numref:`lattice_hex_core_fig` 中蓝色为燃料，黄色为绕线，红
色为冷却剂。简单起见，堆芯输入文件仅包含同一类的7个燃料组件，真实堆芯可以自行增
加组件，这里只重点介绍几何变换填充过程。Universe 1是六边形重复结构，其中
Universe 2是冷却剂，Universe 3是六边形燃料组件。Universe 3本身又包含六边形重复
结构排列的燃料栅元（类似于 :numref:`lattice_hex_assembly_input` 中的描述），即，
整个系统用到了两层嵌套的六边形
重复结构。在描述该几何结构时，首先把燃料和冷却剂（Universe 4和Universe 5）填充
到六边形栅元重复结构（Universe 3）中；接下来把六边形栅元重复结构（Universe 3）在
x-y平面内逆时针旋转90°（rotate = 0 1 0 -1 0 0 0 0 1）并平移
（move = 9.05, -15, 0），填充到六边形组件重复结构（Universe 1）；接下来再把六边
形重复结构（Universe 1）平移（move = -50.4 -27.942 0）到堆芯（即Cell 1）的中心位
置并填充。需要注意的是，用户在做几何变换时应先做旋转再做平移。

|

.. code-block:: c
  :caption: 六边形堆芯几何输入示例
  :name: lattice_hex_core_input

  //// MFR CORE.FAN Xiao 2012-09-17 ////
  Universe 0
  cell 1 -21&7&-8 mat=0 fill=1
  cell 2 21:-7:8 mat=0 void=1

  Universe 1 move=-50.4 -27.942 0 lat=2 pitch=16.8 16.302 scope=5 5 sita=60 fill=
      2 2 2 2 2
      2 2 3 3 2
      2 3 3 3 2
      2 3 3 2 2
      2 2 2 2 2

  Universe 2
  cell 21 -15 mat=1
  cell 22 15 mat=1

  Universe 3 move=9.05 -15 0 rotate=0 1 0 -1 0 0 0 0 1
  lat=2 pitch=2 2.06787 scope=11 11 sita=63.435 fill=
      4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 5 5 5 5 5 4
      4 4 4 4 5 5 5 5 5 5 4
      4 4 4 5 5 5 5 5 5 5 4
      4 4 5 5 5 5 5 5 5 5 4
      4 5 5 5 5 5 5 5 5 5 4
      4 5 5 5 5 5 5 5 5 4 4
      4 5 5 5 5 5 5 5 4 4 4
      4 5 5 5 5 5 5 4 4 4 4
      4 5 5 5 5 5 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4

  Universe 4
  cell 41 -15 mat=1
  cell 42 15 mat=1

  Universe 5
  cell 51 -15 mat=2
  cell 52 15 mat=3

  Surface
  surf 5 p 1 1.6632 0 46.474
  surf 2 p 1 -1.6632 0 46.474
  surf 3 p -1 -1.6632 0 46.474
  surf 6 p -1 1.6632 0 46.474
  surf 1 px 27.942
  surf 4 px -27.942
  surf 7 pz -30
  surf 8 pz 30
  surf 15 cz 0.975
  surf 21 cz 25

  Material
  mat 1 -0.8139 // Na
      11023.30c 1.0
  mat 2 -10.41 // UO2
      92235.30c -56.5 92238.30c -31.1 8016.30c -12.3 13027.30c -0.02
      20000.60c -0.02 12000.60c -0.02 26000.55c -0.02 14000.60c -0.02
  mat 3 -0.8355 // wiry
      11023.30c 2.132 28000.50c 3.223E-3 24000.50c 4.759E-3 26000.55c 1.634E-2

  Criticality
  PowerIter keff0=1.0 population = 50000 200 1000
  InitSrc point=0 0 0

|


随机介质模型
~~~~~~~~~~~~~~~~~~~~


:numref:`explicit_model` 是一个随机介质单棒模型（显式建模法），随机介质内燃料颗粒体积份额为0.32。
对于单棒模型，周围介质为水，单棒包壳外表面半径，内表面半径，燃料棒半径分别为0.7116,0.6546
0.6461cm。

下表给出了所填充TRISO球的几何信息。

.. table:: TRISO颗粒尺寸
   :name: triso_sizes

  +-------------+-----------+----------------+----------+
  | Layer       | Radius/cm | Density/ g/cm3 | Material |
  +=============+===========+================+==========+
  | **Layer1**  | 0.0450    | 12.95          | UC       |
  +-------------+-----------+----------------+----------+
  | **Layer2**  | 0.0525    | 1.05           | C        |
  +-------------+-----------+----------------+----------+
  | **Layer3**  | 0.0555    | 1.9            | C`       |
  +-------------+-----------+----------------+----------+
  | **Layer4**  | 0.0590    | 3.18           | SiC      |
  +-------------+-----------+----------------+----------+
  | **Layer5**  | 0.0610    | 1.9            | C        |
  +-------------+-----------+----------------+----------+
  | **Outside** | \         | 3.18           | SiC      |
  +-------------+-----------+----------------+----------+

|


.. code-block:: c
  :caption: 随机介质组件模型（隐式建模法）
  :name: explicit_model

    ///////////// SingleRod Explicit Model PF=0.32 /////////////
    Universe 0
    cell 1 -13:14:-15:16:-17:18 mat=0 void=1                           // Outside the Assembly
    cell 3 13&-14&15&-16&17&-18  fill=2                                // Inside the Assembly

    Universe 2                        //Fuel Rods
    cell 21 -30&17&-18    fill=5
    cell 22 30&-31&17&-18  mat=2      // Helium Fill
    cell 27 31&-32&17&-18  mat=3      // Cladding FeCrAl
    cell 23 32&17&-18      mat=4

    // TRISO Particles distribution using explicit model
    Universe 5   lat = 4  MATRIC = 7 move = -0.6461 -0.6461 -176.5
                 PARTICLE = 12
                 PF = 0.32
                 RSA = 1
                 RAD = 0.061
                 TYPE = 2
                 SIZE = 0.6461 353

    Universe 7
    cell 66 -49    mat = 7

    Universe 12
    cell 60 -44 mat=1  vol=0.000381704      tmp=900
    cell 61 44&-45 mat= 5    tmp=900
    cell 62 45&-46 mat= 6    tmp=900
    cell 63 46&-47 mat= 7    tmp=900
    cell 64 47&-48 mat= 8    tmp=900
    cell 65 48 mat=7         tmp=900

    Surface
    surf 30 cz 0.6461
    surf 31 cz 0.6546
    surf 32 cz 0.7116
    surf 13 py  -0.90                   bc=1
    surf 14 py   0.90                   bc=1
    surf 15 px  -0.90                   bc=1
    surf 16 px   0.90                   bc=1
    surf 17 pz  -176.5 bc=1
    surf 18 pz   176.5 bc=1
    surf 44 so  0.0450
    surf 45 so  0.0525
    surf 46 so  0.0555
    surf 47 so  0.0590
    surf 48 so  0.0610
    surf 49 inf
    surf 54 so  0.0130
    surf 55 so  0.0385
    surf 56 so  0.0425
    surf 57 so  0.0460
    surf 58 so  0.0500

    Material
    mat 1 -12.95                      //UC
      92235.90c 16.10097657
      92238.90c 83.89902343
      6000.90c  100
    mat 2 -0.0022                    // Helium
      2004.90c  1.0
    mat 3  1.6701076E-02            //FeCrAl
      26056.60c  1.22593E-02
      24052.60c  3.55342E-03
      13027.60c  8.88356E-04
    mat 4 -0.72    // Water
      8016.60c  1.0
      1001.60c  2.0
    sab 4  lwtr.62t
    mat 5 -1.05
      6000.90c    1.0
    //sab 5 grph.65t
    mat 6 -1.9
      6000.90c    1.0
    //sab 6 grph.65t
    mat 7 -3.18                   //SiC
      6000.90c     1.0
      14028.90c     1.0
    //sab 7 grph.65t
    mat 8 -1.9
      6000.90c    1.0
    //sab 8 grph.65t


.. figure:: media/StochasticMedium/TRISO_Particle.png
   :name: triso_fig

   TRISO球截面几何

.. figure:: media/StochasticMedium/Fuelrod.png
   :name: fuel_rod

   燃料棒模型示意图

:numref:`triso_fig` 和 :numref:`fuel_rod` 为 :numref:`explicit_model` 的几何模型示意图。

:numref:`explicit_model_assembly` 是随机介质组件模型（隐式建模法），由上述单棒模型9*9棒束阵列构成

|


.. code-block:: c
  :caption: 随机介质组件模型（隐式建模法）
  :name: explicit_model_assembly

    ///////////// Array9*9 Implicit Model PF=0.32 /////////////
    Universe 0
    cell 1 -1:2:-3:4    mat=0 void=1                                 // Outside the Assembly
    cell 2 1&-2&3&-4    fill=1                                       // Inside the Assembly

    Universe 1 lat=1 pitch=1.8 1.8 1 scope=9 9 1 fill=
     2*81


    Universe 2  move=0.9 0.9 0       //Fuel Rods
    cell 3  32      mat=4            //water
    cell 21 -30     fill=5
    cell 22 30&-31  mat=2            //Helium Fill
    cell 27 31&-32  mat=3            //Cladding FeCrAl


    // TRISO Particles distribution using implicit model
    Universe 5   lat = 3  MATRIC = 7
                 PARTICLE = 12
                 PF = 0.32
                 RAD = 0.061


    Universe 7
    cell 66 -49    mat = 7

    Universe 12
    cell 60 -44 mat=1  vol=0.000381704      tmp=900
    cell 61 44&-45 mat= 5    tmp=900
    cell 62 45&-46 mat= 6    tmp=900
    cell 63 46&-47 mat= 7    tmp=900
    cell 64 47&-48 mat= 8    tmp=900
    cell 65 48 mat=7         tmp=900

    Surface
    surf 1  px  0                       bc=1
    surf 2  px  16.2                    bc=1
    surf 3  py  0                       bc=1
    surf 4  py  16.2                    bc=1
    surf 30 cz 0.6461
    surf 31 cz 0.6546
    surf 32 cz 0.7116
    surf 13 py  -0.90                   bc=1
    surf 14 py   0.90                   bc=1
    surf 15 px  -0.90                   bc=1
    surf 16 px   0.90                   bc=1
    surf 17 pz  -176.5 bc=1
    surf 18 pz   176.5 bc=1
    surf 44 so  0.0450
    surf 45 so  0.0525
    surf 46 so  0.0555
    surf 47 so  0.0590
    surf 48 so  0.0610
    surf 49 inf

    Material
    mat 1 -12.95                     //UC
      92235.90c 16.10097657
      92238.90c 83.89902343
      6000.90c  100
    mat 2 -0.0022                    //Helium
      2004.90c  1.0
    mat 3  1.6701076E-02             //FeCrAl
      26056.60c  1.22593E-02
      24052.60c  3.55342E-03
      13027.60c  8.88356E-04
    mat 4 -0.72                      //Water
      8016.60c  1.0
      1001.60c  2.0
    sab 4  lwtr.62t
    mat 5 -1.05
      6000.90c    1.0
    //sab 5 grph.65t
    mat 6 -1.9
      6000.90c    1.0
    //sab 6 grph.65t
    mat 7 -3.18                      //SiC
      6000.90c     1.0
      14028.90c     1.0
    //sab 7 grph.65t
    mat 8 -1.9
      6000.90c    1.0
    //sab 8 grph.65t

|


.. _section_material:

材料
==========

材料输入模块描述材料组成，包括材料密度、核素截面数据库、核素份额，以及定义与连续
能量或多群ACE截面数据库相关的参数选项。

.. _section_mat_mat:

材料输入卡
--------------

普通材料的输入卡为：

.. code-block:: none

  Mat <mat_id> <density>
      <zaid.xxx> <fraction>
      <zaid.xxx> <fraction>
      ……



其中，

-  **Mat**\ 为材料输入卡关键词。

-  **mat_id**\ 为材料编号，与Cell输入卡当中的填充材料相对应。

-  **density**\ 为材料总密度。\ **density >
   0**\ 表示原子密度，单位为10\ :sup:`24`\ 原子/cm\ :sup:`3`\ ；\ **density
   < 0**\ 表示质量密度，单位为g/cm\ :sup:`3`\ 。

-  **zaid.xxx**\ 指定核素所对应的ACE截面数据库，其中\ **zaid**\ 为核素ID，后缀
   \ **.xxx**\ 指定了截面数据库的类型。为便于区分，建议用户在生成数据库时使用后
   缀\ **.xxc**\ 对应连续能量ACE数据库，使用后缀\ **.xxm**\ 对应多群数据库。截面
   数据库具体对应的核素和类型可以查阅数据库索引文件xsdir。

-  **fraction**\ 为核素在材料中所占的比例。若\ **fraction > 0**\ ，表示原子密度
   份额（相对值），若\ **fraction < 0**\ ，表示质量密度份额（相对值）。同一种材
   料中的\ **fraction**\ 必须具有相同符号。

除普通材料输入卡以外，RMC还提供热化材料输入卡，为连续能量ACE截面指定相应的热化数据库。

.. code-block:: none

  Sab <mat_id> <zaid.xxx>
               <zaid.xxt>
               ……



其中，

-  **Sab**\ 为热化材料输入卡的关键词。

-  **mat_id**\ 为材料编号，与\ **Mat**\ 卡中的材料编号相匹配。

-  **zaid.xxx**\ 指定核素所使用的热化截面数据库，具体请查阅数据库索引文件xsdir。

.. _section_mat_ceace:

连续能量ACE截面相关输入卡
-----------------------------

若材料输入卡中的核素使用连续能量ACE截面，则可以通过以下输入卡为其设定相关参数选项。

.. code-block:: none

  CeAce [ErgBinHash = <flag>] [pTable = <flag>] [OTFPTB = <flag>] [DBRC = <flag>] [TMS = <flag>] [TMSTally = <flag>] [OTFDB = <flag>]

其中，

-  **CeAce**\ 为连续能量ACE截面相关输入卡的关键词。

-  **ErgBinHash**\ 选项卡指定是否使用程序内置的哈希表方法加速能量格点查找速度。
   当核素较多时，使用加速方法能获得更高的计算效率，但也会消耗少量额外的内存。
   \ **ErgBinHash = 1**\ （缺省值），使用哈希表加速；\ **ErgBinHash =0**\ ，不
   使用哈希表加速。

-  **pTable**\ 选项卡指定是否对不可分辨共振区使用概率表。仅当核素使用的ACE截面数
   据库中包含UNR模块时，该选项才生效。\ **pTable = 1**\ （缺省值）表示使用概率
   表，\ **pTable = 0**\ 表示不使用概率表。

-  **OTFPTB**\ 选项卡指定是否对不可分辨共振区使用在线概率表插值。该选项卡与
   **pTable**\配合使用，当\ **pTable = 1**\时才使用在线概率表插值。
   \ **OTFPTB = 1**\ 表示使用在线概率表插值，\ **OTFPTB = 0**\ （缺省值）
   表示不使用在线概率表插值。

-  **OTFSab**\选项卡指定是否对热化能区使用热散射数据在线插值（目前只支持轻水中氢
   的在线插值处理）。\ **OTFSab = 0**\ （缺省值）表示不使用在线热化插值，\ **OTFSab = 1**\
   表示使用在线热化插值。注意：使用在线热化插值时截面库中必须配备若干参考温度点下的
   热化截面库。同时，材料卡中对应的热化材料 " **lwtr.**\"可以采用截面库中具有的任意
   温度的热化库（只填写一种热化库即可）。" **xsdir_sab**\ "是热化插值时热化库的索引
   文件，该文件放置于与执行程序同一个文件夹中, " **xsdir_sab**\ "的内部结构如下所示：

   \ **Datapath = //**\ 此处跟插值用热化库所在文件夹


   **lwtr 293.6K lwtr01 //**\ **lwtr**\为热化材料的名称，此处为水中氢;
   "**293.6K**\"为热化核素的温度，单位为 **K**\;
   **lwtr01**\为插值用热化库的名称。

-  **DBRC**\ 选项卡指定是否使用多普勒展宽拒绝修正（Doppler Broaden Rejection Correction, DBRC）算法。
   **DBRC = 1** 表示使用DBRC， **DBRC = 0** （缺省值）表示不使用DBRC。
   不使用DBRC算法将忽略重核在超热区的共振弹性散射，使用DBRC算法会增加计算时间。
   DBRC算法需要用到0K数据库，该0K数据库的核素在xsdir文件中必须以 **zaid.00c** 命名。
   例如，若用户使用了 **1001.71c 8016.71c 92235.71c** 这几种核素，则相应地， **xsdir**
   文件中必须含有 **1001.00c 8016.00c 92235.00c** 这几种核素截面数据，且这几种核素的截面都是0K的。
   注意，用户无需在输入卡中指定 **zaid.00c** ，只需要将相关核素添加到索引文件 **xsdir** 中即可。

-  **TMS**\ 选项卡指定是否使用TMS（Target Motion Sampling）算法。
   TMS算法可以引入温度变化对截面的反馈效应。
   TMS算法需要使用0K的核数据库，并指定含核素cell的温度。
   使用TMS算法会增加计算时间。
   \ **TMS = 1**\ 表示使用TMS，\ **TMS = 0**\ （缺省值）表示不使用TMS。

-  **TMSTally**\ 选项卡指定在Tally中是否使用TMS计算截面。
   当Tally用到截面信息时，需要开启TMSTally，否则Tally结果不准确；
   当Tally不需要用到截面时，关闭TMSTally不影响结果的准确性。
   当\ **TMS = 1**\ 时，默认开启\ **TMSTally**\ ，但用户可以在输入卡中指定
   \ **TMSTally = 0**\ 以减少计算时间。
   当不使用TMS时，TMSTally关闭，也无法手动开启。

-  **OTFDB**\ 选项卡指定是否使用高斯厄米特积分方法进行在线多普勒展宽。
   当栅元内填充的材料的温度与栅元温度不匹配时，可以使用此方法。
   当使用此方法时，建议选择300K附近的截面数据库。
   使用此方法会增加计算时间。
   \ **OTFDB = 1**\ 表示使用高斯厄米特积分方法进行在线多普勒展宽，\ **OTFDB = 0**\ （缺省值）表示不使用高斯厄米特积分方法进行在线多普勒展宽。

.. _section_mat_mgace:

多群ACE截面相关输入卡
-------------------------

若材料输入卡中的核素使用多群ACE截面，\ *用户必须使用以下输入卡为多群截面指定相关
参数选项*\ 。

.. code-block:: none

  MgAce [ErgGrp = <grp>]



其中，

-  **MgAce**\ 为多群ACE截面相关输入卡的关键词。

-  **ErgGrp**\ 选项卡指定多群ACE截面的群数。

需要指出的是，多群截面数据库紧密依赖于实际物理问题。因此，公开发布的RMC程序包中
不提供多群ACE数据库，用户可以使用其它数据库处理软件生成与实际问题相关的多群ACE截
面数据库。

.. _section_mat_mtlib:

光核反应、光原反应数据库选择输入卡
---------------------------------------------

若需要选择光核反应和光原反应截面的数据库，则可以通过此输入卡为其设定相关参数。输入卡的格式为：

.. code-block:: none

	MTlib
        [Plib=<flag>]
        [PNlib=<flag>]

其中，

-  **MTlib**\ 为选择光核反应、光原反应截面数据库输入卡的关键词。

-  **Plib**\ 选项卡指定光原反应截面数据库类型。**Plib = 04P**\（缺省值），
   表示指定mcplib04p光原反应截面数据库。

-  **PNlib**\ 选项卡指定光核反应截面数据库类型。**PNlib = 24u**\（缺省值），
   表示指定endf24u光核反应截面数据库。


.. _section_mat_nubar:

调整平均裂变中子数选项卡
---------------------------------------------

在某些情况下，需要成比例地调整平均裂变中子数，以改变系统的增殖能力。例如，在准静态动力学计算中，
初始时刻需要处于临界状态。若模型本身不是临界状态，则可以使用该选项卡将其调整到临界
（输入有效增殖因子即可）。

输入卡的格式为：

.. code-block:: none

	nubar [factor = <factor>]

其中，

-  **nubar**\ 为调整平均裂变中子数选项卡的关键词。

-  **factor**\ 为调整平均裂变中子数的因子，注意该因子为除数，缺省值为1（表示不调整）。
   例如，若\ **factor = 2**\ ，则输运计算所使用的平均裂变中子数将变成数据库中的平均裂变中子数的1/2。


.. _section_mat_dynamicmat:

动态材料相关输入卡
-----------------------------

若材料输入卡中的核素使用随时间变化的动态参数，则可以通过以下输入卡为其设定相关参数选项。

.. code-block:: none

  DynamicMat <mat_id> [time =<t1 t2 ... tn>] [Matdenvalue = <v1 v2 ... vn>] [Nucdenvalue = <a1 a2 ... axn>]

其中，

-  **DynamicMat**\ 为动态材料相关输入卡的关键词。

-  **mat_id**\ 为材料编号，与\ **Mat**\ 卡中的材料编号相匹配。

-  **time**\ 卡和\ **Matdenvalue**\ 卡和\ **Nucdenvalue**\ 卡结合使用，分别描述时间,材料密度,该材料中各核素相对份额的变化规律，\ **time**\ 卡和\ **Matdenvalue**\ 卡中输入的值的数目相等，表示当时间超过ti时，对应参数取为vi。\ **Nucdenvalue**\ 卡中输入值的数目为\ **time**\ 卡中值数目的\ **x**\倍,\ **x**\为该材料中核素的数量。

.. _section_mat_example:

材料模块输入示例
--------------------

使用连续能量ACE数据库的材料模块
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

在下面的材料模块中，首先通过\ **Mat**\ 输入卡分别定义了UO\ :sub:`2`\ 和H\ :sub:`2`\ O这两种材料。UO\ :sub:`2`\ 的质量密度为-10.196
g/cm\ :sup:`3`\ ，U235、U238和O16的原子比为0.03 : 0.97 :
2.0。H\ :sub:`2`\ O的原子密度为0.9997
bar\ :sup:`-1`\ cm\ :sup:`-1`\ ，H1和O16的原子比为2 :
1。通过\ **Sab**\ 输入卡，为H\ :sub:`2`\ O中的H1（1001.30c）指定了热化数据库（lwtr.60t）。
在\ **CeAce**\ 输入卡中，\ **pTable =
0**\ 表示不使用概率表，\ **ErgBinHash =
1**\ 表示使用哈希表加速能量查找，
\ **DBRC = 0**\ 表示不使用DBRC算法，
\ **TMS = 0**\ 表示不使用TMS算法，
\ **OTFDB = 1**\ 表示使用高斯厄米特积分方法进行在线多普勒展宽。

.. code-block:: c

    MATERIAL
    mat 1 -10.196
        92235.30c 0.03
        92238.30c 0.97
        8016.30c 2.0
    mat 2 0.9997
        1001.30c 2.0
        8016.30c 1.0
    Sab 2 lwtr.60t
    CEACE pTable = 0 ErgBinHash = 1 DBRC = 0 TMS = 0 OTFDB = 1


使用多群ACE数据库的材料模块
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: c

  MATERIAL
  mat 1 -10.198
      92235.50m 6.9100E-03
      92238.50m 2.2062E-01
      8016.50m 4.5510E-01
  mat 2 -0.001
      8016.50m 3.76622E-5
  mat 3 -6.550
      40000.50m -98.2
  mat 4 -0.997
      1001.50m 6.6643E-02
      8016.50m 3.3334E-02
  MgAce ErgGrp = 30


在上面的材料模块中，.50m为30群的多群ACE截面库。通过\ **ErgGrp**\ 选项卡，指定了
多群截面的能群数量。

使用动态材料变化的材料模块
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: c

 Material
 mat 1   -15.0
         92235.71c  -5
         92238.71c  -10
 DynamicMat  1     time=  0 200e-8 400e-8 500e-8 700e-8 900e-8 1000e-8
            Matdenvalue=-15 -15    -15    -15    -15    -15    -15
            Nucdenvalue=-5  -6.5   -14    -14    -6.5   -5     -5
                        -10 -8.5   -1     -1     -8.5   -10    -10


在上面的材料模块中，通过\ **DynamicMat**\ 选项卡，指定了动态材料随时间变化的参数。\ **time**\ 卡指定时间点,\ **Matdenvalue**\ 卡指定与时间对应材料密度,\ **Nucdenvalue**\ 卡的第一行对应于核素92235随时间的相对份额值,第二行对应于核素92238随时间的相对份额值。在时间点之间的值程序会通过插值确定,比如当需要100e-8时刻的核素92235份额值时,程序会首先通过时间确定插值的位置,然后再由该核素的对应时间参数[-5,-6.5]插值确定。


|

.. _section_mesh:

网格
==============

在蒙卡计算，尤其是引入热工反馈的计算中，经常需要用到基于网格的参数，作为温度/密度等
信息的输入量。网格选项卡可根据用户指定的信息，读取定义好的网格参数。

.. _section_mesh_file:

网格文件格式
--------------

RMC可读取HDF5格式的网格文件。HDF5文件的组成方式可通过网络资源查询，此手册
不加赘述。RMC读取的HDF5网格文件至少需要包含两个内容，即几何Group与网格Dataset：

- 几何Group的Group名限定为"Geometry"。该组需要包含一个attribute，名称限定为
  "MeshType"，值为1，表示该网格是三维均匀结构化网格。后续RMC会增加读取其它类型
  网格的功能。该组还需要包含两个Dataset：第一个Dataset名称限定为"BinNumber"，
  是一个大小为3的数组，表示X/Y/Z每个维度上分别有多少个网格；
  第二个Dataset名称限定为"Boundary"，是一个3*2的矩阵，表示X/Y/Z每个维度上的
  最大边界与最小边界。

- 网格Dataset不限定名称、不限定数量，每个Dataset包含的数据在每个维度上的个数
  需要与Geometry中指定的数量一致。

.. _section_mesh_block:

网格模块输入卡
--------------

.. code-block:: none

  MESH
  MeshInfo <id> [type=<type>] [filename=<filename>]
  [datasetname=<datasetname>]

其中，

-  **Mesh**\ 是模块关键词；

-  **MeshInfo**\ 是网格信息输入卡关键词；

-  **id**\ 指定该网格的编号，此编号可用于栅元温度、栅元密度的输入等；

-  **type**\ 指定该网格的类型，目前RMC仅支持均匀结构化网格，因此
   需要固定\ **type=1**\ ；

-  **filename**\ 指定网格文件的名称；

-  **datasetname**\ 指定Dataset的名称。用户可在同一个网格文件中
   定义多个Dataset，但每个MeshInfo仅能使用一个Dataset。

网格模块输入示例
------------------------

.. code-block:: c

  Mesh
  MeshInfo 1 type=1 filename=Example1.h5 datasetname=Temperature
  MeshInfo 2 type=1 filename=Example2.h5 datasetname=Temperature
  MeshInfo 3 type=1 filename=Example2.h5 datasetname=Density

上面的网格模块一共包含三个网格：第一个网格读取自Example1.h5文件，其数据来自
Temperature数据集；第二个和第三个网格都读取自Example2.h5文件，其数据分别来自
Temperature和Density数据集。。


|

.. _section_criticality:

临界计算
==============

蒙卡临界计算采用裂变源迭代法，即，用当前代产生的裂变源作为下一代的初始源。用户需
要在输入文件中指定用于源迭代的基本参数，包括初始有效增殖因子（keff）、每代中子数
和中子代数，同时还需要指定初始裂变源分布。

在临界计算模块中，用户还可以选择随机数发生器的类型和参数，以及选择并行临界计算的
并行模式。

.. _section_crit_poweriter:

源迭代参数
--------------

.. code-block:: none

    PowerIter [Keff0 = <keff0>] [Population = <N Mi Mt>] [Batchnum = <Mb>]



其中，

-  **PowerIter**\ 为源迭代输入卡关键词。

-  **Keff0**\ 选项卡设置初始有效增殖系数，缺省值为\ **keff0 =
   1**\ 。程序要求用户输入的初始有效增殖系数0.1 < keff0 < 10。

-  **Population**\ 选项卡设置每代中子数（\ **N**\ ），非活跃代代数
   （ M\ :sub:`i` ）和总代数（ M\ :sub:`t` ）。相应地，蒙卡临界计算的
   活跃代代数为 M\ :sub:`a ` =  M\ :sub:`t` – M\ :sub:`i`)，总活跃中子数为
   M = N × M\ :sub:`a` 。

-  **Batchnum**\ 选项卡用于减少并行临界计算中计数器的归并操作，
   将 M\ :sub:`a` 个活跃代压缩为 M\ :sub:`b` 组，每隔 M\ :sub:`a` / M\ :sub:`b`
   活跃代进行一次数据归并。缺省值为 M\ :sub:`b` = M\ :sub:`a` 。

.. _section_crit_ufsmesh:

UFS网格参数
--------------

.. code-block:: none

    	UfsMesh [UfsType = <type>] [Scope = <params>] [Bound = <params>] [AutoCutWgt = <Mt>]

其中，

-  **UfsMesh**\ 为UFS网格输入卡的关键词。

-  **UfsType**\ 选项卡设置UFS方法类型，\ **UfsType = 0**\ 表示不使用UFS方法，
   \ **UfsType = 1**\ （默认值）表示使用均匀裂变源方法，\ **UfsType = 2**\ 表示使用偏倚裂变源方法（由于偏倚裂变源
   方法直接采用网格中最大中子数除以对应网格中子数，得到的均匀结果不明显，故不推荐使用）

-  **Scope**\ 选项卡指定网格在x，y，z方向的数量。特别地，参数为“-1”表示该方向上
   只有一层无限大网格。

-  **Bound**\ 选项卡指定网格在x，y，z方向的数量。形如“Bound = x_min x_max y_min y_max
   z_min z_max”。若某方向只有一层网格，\ **Bound**\ 选项卡中对应的参数没有实际意义。

-  **AutoCutWgt**\ 选项卡指定是否采用自动改变中子截断权重。若M\ :sub:`t` = 0，则程序设置中子
   截断权重为0.01。若M\ :sub:`t` = 1。则程序自动改变中子截断权重，推荐使用M\ :sub:`t` = 1。当
   UfsType = 2时，推荐使用 M\ :sub:`t` = 1，否则会有警告报出。

.. _section_crit_initsrc:

初始裂变源
--------------

.. code-block:: none

  InitSrc [<type> = {params}]

其中，

-  **InitSrc**\ 为初始裂变源输入卡的关键词。

-  **type**\ 为裂变源类型的关键词，\ **params**\ 为相应参数。RMC支持的初始裂变源
   分布包括点源和均匀体源两类，详见 :numref:`source_table` 。

.. table:: RMC支持的初始裂变源分布
  :name: source_table

  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | 关键词      | 说明                             | 参数                                                                                  |
  +=============+==================================+=======================================================================================+
  | **Point**   | 孤立点源                         | x\ :sub:`1` y\ :sub:`1` z\ :sub:`1` x\ :sub:`2` y\ :sub:`2` z\ :sub:`2` …             |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | **Slab**    | 平行于坐标轴方向的长方体均匀源   | x\ :sub:`min` x\ :sub:`max` y\ :sub:`min` y\ :sub:`max` z\ :sub:`min` z\ :sub:`max`   |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | **Sph**     | 球体均匀源                       | x y z R                                                                               |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | **Cyl/x**   | 平行于x轴的圆柱体均匀源          | y z R x\ :sub:`min` x\ :sub:`max`                                                     |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | **Cyl/y**   | 平行于y轴的圆柱体均匀源          | x z R y\ :sub:`min` y\ :sub:`max`                                                     |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+
  | **Cyl/z**   | 平行于z轴的圆柱体均匀源          | x y R z\ :sub:`min` z\ :sub:`max`                                                     |
  +-------------+----------------------------------+---------------------------------------------------------------------------------------+

.. _section_crit_rng:

随机数发生器
----------------

RMC含有三种不同类型的随机数发生器。对一般用户而言，建议使用默认的随机数发生器类
型和参数。高级用户可能需要使用特定的随机数参数，例如，对同一算例使用不同的随机数
种子来获得独立的计算结果。RMC提供了定制随机数发生器的输入卡：

.. code-block:: none

  RNG [Type = <type>] [Seed = <seed>] [Stride = <stride>]


其中，

-  **RNG**\ 为随机数发生器输入卡的关键词。

-  **Type**\ 选项卡指定随机发生器的类型，\ **Type = 1**\ 为48-bit乘法线性同余法
   随机数发生器， **Type =  2**\ （缺省值）为64-bit乘法线性同余法随机数发生器，
   \ **Type = 3**\ 为64-bit混合线性同余法随机数发生器。

-  **Seed**\ 选项卡指定随机数发生器的初始化种子，可以是任意正奇数，缺省值为
   \ **Seed = 1**\ 。

-  **Stride**\ 选项卡用于并行计算时为每个中子历史分配的分段随机数的长度，只建议
   高级用户使用。缺省值为\ **Stride = 10000**\ 。

.. _section_crit_cutoff:

截断条件
----------------

.. code-block:: none

  CutOff [MaxLost=<maxLost>]
         [MinWeight=<minWeightN minWeightP>]
         [MaxWeight=<maxWeightP>]

其中，

-  **CutOff**\  为截断条件输入卡的关键词。

-  **MaxLost**\ 选项卡指定程序允许丢失的最大粒子数，缺省值为 10。

-  **MinWeight**\ 选项卡指定输运过程中的权重下限，**minWeightN**\ 指定中子的
   权重下限，缺省值为0.25，**minWeightP**\ 指定光子的权重下限，缺省值为0.6。
   - 在权窗减方差功能开启后，此处输入无效

-  **MaxWeightP**\ 选项卡指定光子在输运过程中的权重上限，缺省值为1.4。

.. _section_crit_parallelbank:

并行临界计算模式
--------------------

在并行临界计算中，考虑到负载平衡，需要对各个进程上的裂变源中子进行收集并重新分
配。传统的蒙卡程序一般采用主从（master-slave）模式，收集和分配的效率较低。RMC采
用对等模式（slave-slave），提高了并行效率。选择并行临界计算模式的输入卡为：

.. code-block:: none

  ParallelBank <flag>

其中，

-  **ParallelBank**\ 为并行临界计算模式输入卡的关键词。

-  **flag**\ 指定并行模式。\ **flag = 0**\ 为主从模式，\ **flag =
   1**\ （缺省值）为对等模式。

裂变矩阵法求解临界伴随通量
------------------------------

.. code-block:: none

    MGAdjFisMatrix [Energy=<enenrgy>]  [Scope=<scope>] [Bound=<bound>]


其中，

-  **MGAdjFisMatrix**\ 为裂变矩阵法求解临界伴随通量输入卡的关键词。

-  **Energy**\ 选项卡指定伴随通量的能量分界点。

-  **Scope**\ 选项卡指定网格在x，y，z方向的数量。特别地，参数为“-1”表示该方向上
   只有一层无限大网格 (注意：在Universe重复几何中的Scope选项卡当中，参数为1表示
   该方向上只有一层无限大网格)。

-  **Bound**\ 选项卡指定网格在x，y，z方向的边界范围，形如“Bound = x_min
   x_max y_min y_max z_min z_max”。若某方向只有一层网格，
   \ **Bound**\ 选项卡中对应的参数没有实际意义。

另外，使用裂变矩阵求解临界伴随通量时需要在源收敛模块中写上相同几何网格的裂变矩阵

临界计算模块输入示例
------------------------

.. code-block:: none

  CRITICALITY
  PowerIter Population = 5000 30 100 // keff0 = 1.0
  InitSrc point = 0.0 0.0 0.0
                  0.5 0.5 0.0
                 -0.5 -0.5 0.0
  RNG type = 3 seed = 12345 stride = 10000
  ParallelBank 1

在上面的临界计算模块中，\ **PowerIter**\ 输入卡指定每代粒子数为5000，跳过30代，
一共模拟100代；初始有效增殖系数为缺省值，即1.0。\ **InitSrc**\ 输入卡指定了初始
源的类型为点源，位置为（0，0，0）、（0.5，0.5，0）和（-0.5，-0.5，0），裂变源将
在这三个位置随机产生。\ **RNG**\ 输入卡指定了随机数类型为64-bit混合线性同余法随
机数发生器，初始随机数种子为12345，为每个粒子分配的随机数长度为10000。
\ **ParallelBank**\ 输入卡表示在并行计算中使用对等模式收集和分配裂变源。


|

.. _section_tally:

计数器
============

RMC包含三类计数器，分别是栅元计数器（cell tally）、网格计数器（mesh tally）和截
面计数器（cross-section tally）。

栅元计数器用来统计栅元内的宏观物理量，包括积分通量、功率、裂变反应率和吸收反应率
等。RMC采用Cell-Mapping方法，能够高效地处理大规模栅元计数器。网格计数器与栅元计
数器类似，但它统计的宏观物理量不是基于栅元，而是基于预先划定的网格。截面计数器统
计栅元内指定核素、指定反应类型的反应截面（微观反应率）。以上三种计数器都支持分能
群统计，即，按照指定的能量区间分别计数。

需要注意的是，若用户在几何模块使用了随机介质隐式模拟方法，为了检验计算合理性，需要
利用计数器对隐式方法填充率进行检验以确保实际填充率正确。

栅元计数器
--------------

栅元计数器的输入卡为：

.. code-block:: none

    CellTally <id> [Type = <type>] [Energy = <erg_bin>] [Filter = <params>]
              [Integral = <params>] [Cell = <cell_vector_group>] [Time = <time_bin>]
              [Volume=<vol>] [Multiplier=<mul>] [Attenuator=<att>] [Dose=<dose>] 
	          [Gaussian=<gaussian>] [Value=<val_bin>] [Segment=<seg_bin>]
              [Flag=<flag_bin>] [Nest=<nest>] [ReactionRate=<params>]
              [Source=<source_bin>]
			  

其中，

-  **CellTally**\ 为栅元计数器输入卡的关键词。

-  **id**\ 为栅元计数器的编号，便于查阅输出。

-  **Type**\ 卡指定计数类型。\ **Type = 1**\ 表示栅元通量，
   \ **Type =2**\ 表示栅元功率，\ **Type = 3**\ 表示栅元裂变反应率，
   \ **Type = 4**\ 表示栅元吸收反应率，\ **Type = 5**\ 表示裂变中子产生率，
   \ **Type = 6**\ 表示中子或光子释热率，\ **Type = 7**\ 表示非弹性散射反应率，
   \ **Type = 8**\ 表示弹性散射反应率。
   注意，这里所指的通量、功率、反应率等都是对栅元体积的积分量。

-  **Energy**\ 选项卡指定分群计数的能量区间，参数为能量间隔点（Mev）。例如，
   “\ **Energy = 0 6.25E-7 20**\ ”表示计数区间为0到0.625ev，0.625ev到20Mev，20Mev
   到正无穷，   共3个区间；同时，程序还将给出总计数。特别地，对于多群临界计
   算，“\ **Energy  = -1**\ ”表示使用截面数据库的能群结构划分。若输入中
   没有\ **Energy**\ 选项卡，则表示只统计总的计数率。

-  **Time**\ 选项卡指定分时计数的时间区间，参数为时间间隔点（s）。例如，
   “\ **Time = 0 5.0e-8  1.0e-7**\ ”表示计数区间为0到5.0e-8s，5.0e-8s到1.0e-7s 共2个区间；
   同时，程序还将给出总计数。只在固定源中使用。具体参见第11章示例。

-  **Cell、Filter、Integral**\ 选项卡用于描述计数栅元，下面将具体介绍。

-  **particle**\ 为栅元计数器统计的粒子类型，1代表中子、2代表光子、3代表电子。

-  **volume**\ 为栅元体积列表，为正数，和归并后的Cell数对应，Type=6时为质量得到的释热率
   量纲为MeV/g。
  
-  **Multiplier**\ 为截面乘子，为整数，用于自定义乘数或反应截面，在使用Multiplier时计数
   类型Type必须设置为1，且不能使用Dose功能。
   
-  **Attenuator**\ 为衰减乘子，用于计算衰减因子，其用法在后面介绍。

-  **Gaussian**\ 定义高斯能量展宽，是由实数构成的展宽数组，其用法在后面介绍。

-  **Value**\ 用于定义计数值分箱，即对计数器的单次计数器进行分箱处理。

-  **Segment**\ 用于定义切割分箱，其用法在后面介绍。

-  **Flag**\ 用于定义标记分箱，即对穿过某个特定面或栅元的粒子单独进行统计，其用法在后面介绍。

-  **Nest**\ 用于定义分箱之间的嵌套，如输出能量分箱和余弦分箱之间的嵌套，其用法在后面介绍。

-  **Reactionrate**\ 用于产生一个文件单独输出能群通量及反应率。

-  **Source**\ 用于定义源分箱，即对抽样自某个源的粒子单独进行统计，仅用于固定源计算中，其
   用法在后面介绍。

Cell选项卡
~~~~~~~~~~~~~~~~

在层级几何系统中，任意一个栅元区域都是通过一系列的栅元编号及其层级关系来唯一地确
定。我们\ **以栅元向量（Cell vector）的形式来描述这种具有层级关系的栅元**\ ：

.. code-block:: none

    Cell_vector = C[1] > C[2] > … > C[n]

其中，“>”表示上层对下层的包含关系，n为该栅元所处的层级，C[i]表示栅元编号或重复结
构编号（当第i层为重复结构时）。在蒙卡跟踪过程，总是需要将粒子定位到底层栅元
（即C[n]不被其它任何空间填充），然后获取相应的材料和温度等信息进行输运模拟。

与粒子定位的栅元描述类似（参考第3.5节），计数栅元采用也如下所示的向量描述：

.. code-block:: none

    C[1] > C[2] > … > C[n]

首先考虑C[n]为底层栅元的情形，即C[n]不再被下层结构填充。计数器的基本实现过程是：
在蒙卡模拟过程中，检查粒子定位栅元是否与计数栅元匹配（二者都是底层栅元）；若是，
则累加计数信息。值得指出的是，同一个\ **Cell**\ 选项卡中给出的栅元列表不允许存在
重复的栅元向量。

为提高计数栅元描述的灵活性，程序引入“ : ”和“ \* ”两种辅助表达符。

以某压水堆堆芯为例，假设全堆（栅元编号1）包括21×21=441个重复网格，每个网格为燃料
组件或反射层；其中，燃料组件进一步划分为17×17=289个重复网格，每个网格内填充燃料
棒（栅元编号35）和慢化剂（栅元编号36）。

为统计该堆芯中心组件（重复网格编号221）的中心栅元（重复网格编号145）燃料棒内的通
量，计数栅元的输入为：

.. code-block:: none

    1 > 221 > 145 > 35

以此类推，若用户需要统计其它组件中心燃料棒内的通量，需要输入：

.. code-block:: none

    1 > 1 > 145 > 35
    1 > 2 > 145 > 35
    1 > 3 > 145 > 35
    …
    1 > 441 > 145 > 35

通过使用展开符“：”，上述输入方式可简写为：

.. code-block:: none

    1 > 1:441 > 145 > 35

RMC程序还支持形如“1 > 1:441 > 1:289 > 35”的多层展开输入方式，按照从右至左的方向
逐层展开：

.. code-block:: none

    1 > 1 > 1 > 35
    …
    1 > 1 > 289 > 35
    1 > 2 > 1 > 35
    …
    1 > 2 > 289 > 35
    …
    1 > 441 > 1 > 35
    …
    1 > 441 > 289 > 35

全局展开符“\*”是展开符“：”的一个特例，它会自动搜索所有底层栅元为特定编号的区域，
分别予以计数。在上述算例中，用户输入：

.. code-block:: none

    *36

即可分别统计各个组件内的各慢化剂区（栅元编号36）的通量。

Filter选项卡
~~~~~~~~~~~~~~~~~~

6.1.1中的计数栅元描述“C[1] > C[2] > … > C[n]”只考虑了C[n]是底层栅元（即C[n]不再
被下层结构填充）。但用户有时可能需要统计非底层栅元或复合栅元的通量分布，这时就
需要用到\ **Filter**\ 选项卡。

**Filter**\ 选项卡的参数是由0和1组成的序列，序列长度等于计数栅元的层级。默认情况
下，序列内的
元素为1；若计数栅元中出现“0”通配符（见后面的示例），则Filter向量中相应位置用0代替。

**Filter**\ 选项卡的功能之一是统计非底层栅元的通量。以6.1.1中的情形为例，通量统
计的对象为组件，即，第一层重复结构当中的网格。栅元计数器的输入卡为：

.. code-block:: none

    CellTally 1 Type = 1 Filter = 1 1
    Cell = 1 > 1:441



其中，1 > 1:441等同于输入“1 > 1 1 > 2 …… 1 > 441”，“Filter = 1
1”标识该计数器内的所有计数栅元都只有两层。该计数器将给出441个计数，分别对应441个
组件层面的网格（包含反射层网格）的通量。

**Filter**\ 选项卡的另一功能是用于统计复合栅元的计数，如下所示：

.. code-block:: none

    CellTally 1 Type = 1 Filter = 1 1 0 1
    Cell = 1 > 1:441 > 0 > 35


注意到“1 > 1:441> 0 > 35”当中的0是一个通配符，表示在计数匹配过程中忽略该层级的栅
元编号或网格编号。\ **Filter**\ 选项卡中相应层的位置用0标识。该计数器将给出441个
通量计数，其中第i个计数对应第i个组件内的所有燃料棒通量之和。

RMC采用Cell mapping方法快速处理大规模栅元计数。用户应尽量将相同类型（具有相同
Filter）的计数栅元置于同一个CellTally中，减少CellTally总数（增加单个CellTally的
计数规模），提高计数效率。

Integral选项卡
~~~~~~~~~~~~~~~~~~~~

**Integral**\ 选项卡的作用是将计数器内的计数栅元进行逐段合并，作为一个整体进行
计数。例如：

.. code-block:: none

    CellTally 1 Type = 1 Filter = 1 1 0 1
    Integral = 100*3 141 （namely Integral = 100 100 100 141）
    Cell = 1 > 1:441 > 0 > 35


该计数器将给出4个计数，分别是1 > 1:100 > 0 > 35计数之和，1 > 101:200 > 0
> 35计数之和，1 > 201:300 > 0 > 35计数之和，1 > 301:441 > 0 > 35计数之和。通过使
用Integral选项卡，理论上可以将任意多个栅元当作一个整体进行计数（即使它们在物理
上并不相邻）。

Multiplier选项卡
~~~~~~~~~~~~~~~~~~~~

**Multiplier**\ 选项卡的通用输入格式为：

.. code-block:: none

    Multiplier=C m R
    其中R为一系列反应截面（或其他物理量）标号x1, x2, x3...的逻辑组合，可以表示为
    多个物理量之和： x1 : x2 : x3...
    多个物理量之积： x1 x2 x3...


乘子可以用于统计形如 :math:`\mathrm{C} \int \varphi(E) \mathrm{R}(E) dE` 的物理量，
其中φ(E)为通量，R(E)为截面、裂变产额等利用加或乘运算得到的物理量，通过栅元计数器的统计，
得到的统计值即代表了上面式子中对能量积分的结果。
m为截面的材料号。乘子的层级高于分箱的层级。当指定Multiplier选项卡，
原未经乘子处理的tally值不再保留输出，用户如需该值，可另行添加Tally。

当m存在且为正整数时，RMC对统计的tally值乘以材料卡中mat=m对应材料中由R(x1,x2,…,xi)
确定的微观截面运算值，再乘以C归一，得到 :math:`\mathrm{C} \int \varphi(E) \mathrm{R}(E) dE` 的值。
R部分的语法规则如下：xi为微观截面代号, 当用户使用的库为ENDF/B库时，
常用的反应截面序号见表3.5。逻辑符号‘ : ’连接x1,x2表示加运算，空格连接x1,x2为乘运算，乘运算优先级高于加运算。
所以对照表6-1-1，不同的Type类型均可用C m R来实现，其中m为栅元对应的材料编号，
C为对应材料的原子密度（1024原子/cm3）。

例如，Type=2计算中子裂变功率可以表示为

.. code-block:: none

    Multiplier = C m -6 -8  （R部分为-6 -8，-6为总裂变截面，-8为裂变能）


Type=3计算中子裂变反应率可以表示为；

.. code-block:: none

    Multiplier = C m -6


Type=4计算中子吸收反应率可以表示为

.. code-block:: none

    Multiplier = C m -2


Type=5裂变中子产生率可以表示为

.. code-block:: none

    Multiplier = C m -7 -6


Type=6计算中子释热率时可以表示为

.. code-block:: none

    Multiplier = C m 1 -4


计算光子释热率时可以写成

.. code-block:: none

    Multiplier = C m -5 -6


这解释了为什么Type取非1值时与Multiplier卡冲突。用户也可根据需求利用截面的组合
求得有实际含义的物理量。

当m为-1、-2或-3时为特殊乘子，此时R部分必须为空。C=-1时将每次统计的值置为1，
对于栅元计数器统计穿过栅元的径迹数，对于面计数器统计穿过面的径迹数，即Type=0时的总面流J
（注意不是净面流，无量纲单位），对于点计数器统计源和碰撞数，以上所有值在固定源计算模式下
以外源粒子数进行归一，在临界计算模式下以每代中子数归一，再对活跃代求平均；
C=-2时R==v；C=-3时计算能量注量率，即C=1,R=E(MeV)。

.. table:: ENDF/B反应截面序号
  :name: xs_table

  +-------+-------+-----------------------+
  |粒子	|标号   |反应截面               |
  +=======+=======+=======================+
  |中子	|-1     |非热化总截面           |
  +-------+-------+-----------------------+ 
  |       |   -2  |   吸收截面            |
  +-------+-------+-----------------------+
  |       |   -3  |   非热化弹性散射截面  |
  +-------+-------+-----------------------+
  |       |   -4  |   平均热数(MeV/碰撞)  |
  +-------+-------+-----------------------+
  |       |   -5  |   光子产生截面        |
  +-------+-------+-----------------------+
  |       |   -6  |   总裂变截面          |
  +-------+-------+-----------------------+
  |       |   -7  |   裂变中子产额        |
  +-------+-------+-----------------------+
  |       |   -8  |   裂变能Q（MeV/裂变） |
  +-------+-------+-----------------------+
  |光子   |   -1  |   非相干散射截面      |
  +-------+-------+-----------------------+
  |       |   -2  |   相干散射截面        |
  +-------+-------+-----------------------+
  |       |   -3  |   光电效应截面        |
  +-------+-------+-----------------------+
  |       |   -4  |   电子对效应截面      |
  +-------+-------+-----------------------+
  |       |   -5  |   总截面              |
  +-------+-------+-----------------------+
  |       |   -6  |   光子热数            |
  +-------+-------+-----------------------+

Dose选项卡
~~~~~~~~~~~~~~~~~~~~

**Dose**\ 选项卡由三部分组成：插值方式、能量数组、乘子数组。

RMC实现剂量统计的原理是利用以能量为自变量的通量剂量转换因子函数，该函数利用能量数组代替
连续变化的能量，用乘子数组代替连续变化的转换因子，所以两数组数组长度必须相同，且均为单调
递增的实数。数组长度越大，表明插值点越多，结果越精确，插值方式共有四种，由Dose选项卡中第
一个正整数指定，1为log-log插值，即能量-转换因子函数在双对数坐标图上线性插值，2为log-lin插值，
即在能量对数坐标图上线性插值，3为lin-log插值，即在转换因子对数坐标图上线性插值，4为lin-lin
插值，即线性插值。

能量数组及乘子数组的设置可参考辐射防护国际组织制定的标准，例如ICRP-21指定的中子通量剂量转换
可在Dose卡中写成：1(插值类型)  2.5E-8  1.0E-7  1.0E-6  1.0E-5  1.0E-4  1.0E-3  1.0E-2  1.0E-1  5.0E-1
1.0  2.0  2.5  5.0  7.0  10.0  14.0  20.0(选取的能量点)  3.85E-6  4.17E-6  4.55E-6  4.35E-6  4.17E-6
3.70E-6  3.57E-6  2.08E-5  7.14E-5  1.18E-4  1.43E-4  1.47E-4  1.47E-4  1.47E-4  1.47E-4(乘子数组)
1.47E-4  1.54E-4。

Attenuator选项卡
~~~~~~~~~~~~~~~~~~~~

**Attenuator**\ 选项卡输入格式为：

.. code-block:: none

    Attenuator=C m1 px1 m2 px2...
	
C为归一化常数，m为材料号，px为密度和衰减厚度的乘积，px为正值时为原子密度和衰减厚度的乘积
（1024cm-2），px为负值时为质量密度和衰减厚度的乘积（1024g/cm2）。该选项卡可实现在不进行实
际建模的情形下计算衰减因子 :math:`e^{-\sigma 1 p \times 1-\sigma 2 p \times 2}` 。

Gaussian选项卡
~~~~~~~~~~~~~~~~~~~~

**Gaussian**\ 选项卡用于对tally的能量值进行高斯分布抽样，抽样的微分概率为
:math:`\mathrm{f}(\mathrm{E})=\operatorname{Cexp}\left(-\left(\frac{E-E_{0}}{A}\right)^{2}\right)` ，
C为归一化常数，使得 :math:`\int_{0}^{+\infty} f(\mathrm{E}) \mathrm{d} \mathrm{E}=1` ，
:math:`A=\frac{F w H M}{2 \sqrt{\ln 2}}` 。

Gaussian选项卡输入格式为a b c，用于指定半高宽，
:math:`\mathrm{FWHM}=\mathrm{a}+\mathrm{b} \sqrt{E+c E^{2}}` 。

Gaussian选项卡的优先级高于Energy分箱而低于Dose卡。
展宽后能量为负值时将能量置为零。

Energy选项卡
~~~~~~~~~~~~~~~~~~~~

**Energy**\ 选项卡用于定义统计量的能量分箱统计结果，目前RMC中有两种定义Energy关键词的格式：

第一种定义方式使用需要Bin输入卡，在栅元计数器中定义Energy=bi，bi为对应的连续能量分箱，为此所需的
分箱卡定义为：

.. code-block:: none

	Bin ni Type=1, bound=e0, e1, e2, ... , en
	
可以统计按照e0, e1, e2, ... , en划分的能量分区。

第二种定义方式是直接在栅元计数器中定义Energy=e0, e1, e2, ... , en，其统计结果和使用Bin完全相同，
在不使用其他Bin的情况下可以简化输入。

\ **注意** \：建议使用第一种输入方式，在栅元计数器中使用了Bin的情况下（不管是该栅元计数器还是其他栅元
计数器），\ **不允许使用第二种输入方式** \，目前第二种输入方式与Bin不兼容。

Time选项卡
~~~~~~~~~~~~~~~~~~~~

**Time**\ 选项卡用于定义统计量的时间分箱统计结果。

Time卡的定义方式是直接在栅元计数器中定义Time=t0, t1, t2, ... , tn。\ **注意** \ ，目前Time卡和
其他使用Bin的分箱不兼容，如果使用Time卡则不能在CellTally中使用其他Bin。

Value选项卡
~~~~~~~~~~~~~~~~~~~~

**Value**\ 卡用于对计数器的单次计数值进行分箱，可用于栅元、面和点计数器中。单次计数值为粒子一次
穿面、或在栅元中进行一次输运模拟时、或点探测器的一次碰撞时，对通量、流等的贡献。

**Value**\ 的输入格式为Value=bn, 其中bn为Bin卡中的id号，Bin卡应使用连续分箱：

.. code-block:: none

        Type=1 bound=a1 a2 a3 … an

上面的输入格式可得到n-1个分箱结果：(a1, a2), (a2, a3), …, (an-1 ,an)。

Segment选项卡
~~~~~~~~~~~~~~~~~~~~

**Segment**\ 卡用于对CellTally或SurfaceTally进行切割，得到多个子tally。

**Segment**\ 的输入格式为Segment=bn，其中bn为Bin卡中的id号。对应的Bin卡的格式应为

.. code-block:: none

	Type=2，value=±s_1  ±s_2 … ±s_n

其中s_i为在surf卡中的面编号。前面的正负号指定面的正负，这样定义的切割分箱表示该曲面
s_i和前面的所有面s_1、s_2、...、s_(i-1)的非逻辑运算求交。例如：value=1 2 3 -3产生四
个分箱，分别为1、-1∩2、-1∩-2∩3、-1∩-2∩-3。

对于栅元计数器来说，指定面将对统计的径迹进行分割，得到的子径迹分别落入对应分箱，对于
面计数器来说，指定面将对统计的面进行分割，粒子径迹穿过面的位置决定其落入哪一个分箱。
因此，栅元计数器的分割分箱不互斥而面计数器的分割分箱互斥且完整（互斥指某次tally计数
属于分箱a则不属于其他非a分箱，完整指任意一次tally计数必然落
入其中一个分箱）。Segment选项卡优先级低于Type和Multiplier。

对应的示例输入文件几何及Tally模块的部分文件如下：

.. code-block:: none

	UNIVERSE 0
	Cell  1  2           mat=0 void=1
	Cell  2  1&-2&-3     mat=1
	Cell  3  1&-2&3&-4  mat=1
	Cell  4  1&-2&4     mat=1
	Cell  5  -1          mat=1

	SURFACE 
	Surf 1  SO  10
	Surf 2  SO  20
	Surf 3  PX  2
	Surf 4  PX  5

	Tally
	CellTally  1  particle=1  type=1  cell=5  segment=b1
	
	SurfTally  1  particle=1  type=2  surf=1  segment=b1
	Bin 1 type=2 value=-3 -4 4

则上述CellTally 1中Segment的效果将与下面输入文件中CellTally 1、CellTally 2和
CellTally 3相同，上述SurfTally 1中Segment的效果将与下面输入文件中SurfTally 1、
SurfTally 2和SurfTally 3相同。

.. code-block:: none

	UNIVERSE 0
	Cell  1  2           mat=0 void=1
	Cell  2  1&-2&-3     mat=1
	Cell  3  1&-2&3&-4  mat=1
	Cell  4  1&-2&4     mat=1
	Cell  5  -1&-3       mat=1
	Cell  6  -1&3&-4     mat=1
	Cell  7  -1&4        mat=1

	SURFACE 
	Surf 1  SO  10
	Surf 2  SO  20
	Surf 3  PX  2
	Surf 4  PX  5

	Tally
	CellTally  1  particle=1  type=1  cell=5  
	CellTally  2  particle=1  type=1  cell=6
	CellTally  3  particle=1  type=1  cell=7
	SurfTally  1  particle=1  type=2  surf=1  cell=5
	SurfTally  2  particle=1  type=2  surf=1  cell=6
	SurfTally  3  particle=1  type=2  surf=1  cell=7

Flag选项卡
~~~~~~~~~~~~~~~~~~~~
	
**Flag**\ 选项卡用于标记曾穿过指定栅元或指定面的粒子对于Celltally中对应cell的贡献。

输入格式为Flag=bn，n为Bin卡中id号，Bin卡中Type=2，value=c1 –s2 … (ci –sj…)…cn –sm，
正整数ci为cell编号（不支持重复几何结构），负整数sj为SURF中的面编号，括号表示归并，
归并采用逻辑或操作，即穿过其中任意一个栅元或面的均属于该分箱，不支持括号嵌套，支持
栅元和面混合标识。注意，栅元标识是指粒子曾经过指定栅元，所以是以粒子离开面为信号，
所以源（包括外源、裂变源等非散射情形）粒子第一次径迹在Flag栅元内时不计入该标识分箱，
面源粒子也不计入该面标识分箱。

示例模型与6.1.8相同，当采用Flag选项卡时，输入文件如下：

.. code-block:: none

	UNIVERSE 0
	Cell  1  2           mat=0 void=1
	Cell  2  1&-2&-3     mat=1
	Cell  3  1&-2&3&-4  mat=1
	Cell  4  1&-2&4     mat=1
	Cell  5  -1          mat=1

	SURFACE 
	Surf 1  SO  10
	Surf 2  SO  20
	Surf 3  PX  2
	Surf 4  PX  5

	Tally
	CellTally  1  particle=1  type=1  cell=5  flag=b1 
	SurfTally  1  particle=1  type=2  surf=1  flag=b2
	Bin 1 type=2 value=2 3 4 5
	Bin 2 type=2 value=-3 -4


以CellTally 1为例，其输出结果为：

.. code-block:: none

	FLAG         Ave            RE
	2           x.xxxxE+0x   x.xxxxE+0x
	3           x.xxxxE+0x   x.xxxxE+0x
	4           x.xxxxE+0x   x.xxxxE+0x
	5           x.xxxxE+0x   x.xxxxE+0x

这里CellTally 1分别统计径迹曾经过栅元2、3、4、5（从栅元2、3、4、5中穿出）的粒子对tally值的贡献；
SurfTally 1分别统计径迹曾穿过面3和4的粒子对tally值各自的贡献，其中，某径迹从源点（0，0，0）产
生经过栅元5进入栅元2，该径迹并不计入flag=5，该径迹从源点（0，0，0）产生经过栅元5进入栅元2并散
射回栅元5时，该径迹计入flag=5。

Source选项卡
~~~~~~~~~~~~~~~~~~~~

**Source**\ 选项卡用于分别统计抽样自特定源的粒子对tally值的贡献。

输入格式为Source=bn，n为Bin卡中id号，Bin卡中Type=2，value=s1 s2 ...
其中si为ExternalSource选项卡中各个Source的编号。示例输入文件如下：

.. code-block:: none

    EXTERNALSOURCE
    Source 1 xxx
    Source 2 xxx

	Tally
	CellTally  1  particle=1  type=1  cell=5  source=b1 
	Bin 1 type=2 value=1 2

这里CellTally将分别统计来自Source 1和Source 2的粒子对栅元通量的贡献。

Nest选项卡
~~~~~~~~~~~~~~~~~~~~

**Nest**\ 选项卡用于指定分箱嵌套关系，当不含Nest卡时只输出总结果，各分箱统计结果，
当使用Nest分箱时，除输出以上结果，还输出嵌套分箱的结果。

输入格式：Nest=h1 h2…hn，hi为正整数，用于标识对应的分箱，1：能量分箱，2：余弦分箱
（面流计数器），3：切割分箱，4：标识分箱，5：碰撞次数分箱（点探测器），6：碰撞栅元
分箱（点探测器）, 7: 计数值分箱，11：源分箱。标识靠前优先输出。由于分箱嵌套产生子分箱数目为乘
法效应，增加程序运行内存，因此不建议过多的层级嵌套。

下面的实例显示了如何使用Nest卡：

.. code-block:: none

	UNIVERSE 0
	Cell  1  2           mat=0 void=1
	Cell  2  1&-2&-3     mat=1
	Cell  3  1&-2&3&-4  mat=1
	Cell  4  1&-2&4     mat=1
	Cell  5  -1          mat=1

	SURFACE 
	Surf 1  SO  10
	Surf 2  SO  20
	Surf 3  PX  2
	Surf 4  PX  5

	Tally
	CellTally  1  particle=1  type=1  cell=5  energy=b1 segment=b2 nest=3 1
	Bin 1 type=1 bound=0 10e-5 10E-3 1.0 10
	Bin 2 type=2 value=-3 -4 4

除了输出能量分箱和切割分箱外，还输出各切割分箱内的能量分箱。

Reactionrate选项卡
~~~~~~~~~~~~~~~~~~~~

**Reactionrate**\ 选项卡单独输出一个包含能群通量及反应率的.Reactionrate文件，
使用该选项卡时设置Reactionrate=1即可。
	
网格计数器
--------------

网格计数器的输入卡为：

.. code-block:: none

  MeshTally <id> [Type = <type>] [Particle = <type>]
                 [Energy = <erg_bin>] [Normalize = <flag>]
                 [HDF5Mesh = <flag>]
                 [Geometry=<geo>] [Axis=<a1><a2><a3>] 
                 [Vector=<v1><v2><v3>][Origin=<o1><o2><o3>] 
                 [Scope = <params>] [Bound = <params>]
                 [ScopeX/ScopeY/ScopeZ = <params>]
                 [BoundX/BoundY/BoundZ = <params>]



其中，

-  **MeshTally**\ 为网格计数器输入卡的关键词。

-  **id**\ 为网格计数器的编号，便于查阅输出。

-  **Type**\ 卡指定计数类型。\ **Type = 1**\ 表示通量，\ **Type = 2**\ 表示功率，
   \ **Type = 3**\ 表示裂变反应率，\ **Type = 4**\ 表示吸收反应率。
   \ **Type = 5**\ 表示裂变中子产生率，\ **Type = 6**\ 表示中子或光子释热率。

-  **Particle**\ 选项卡指定计数的粒子类型。\ **Particle = 1**\ 表示对中子计数，
   \ **Particle = 2**\ 表示对光子计数，\ **Particle = 3**\ 表示对电子和正电子计数。
   默认情况为对中子计数。

-  **Energy**\ 选项卡指定分群计数的能量区间，参数为能量间隔点（Mev）。
   例如，“\ **Energy   = 0 6.25E-7 20**\ ”表示计数区间为0到0.625ev，0.625ev到
   20Mev，20Mev到正无穷，共3个区间；同时，程序还将给出总计数。特别地，对于多
   群临界计算，“\ **Energy  =  -1**\ ”表示使用截面数据库的能群结构划分。若输入
   中没有\ **Energy**\ 选项卡，则表示只统计总的计数率。

-  **Normalize**\ 选项卡指定是否用网格体积进行归一化。
   **Normalize = 1**\ 表示使用网格体积进行归一化，
   **Normalize = 0**\ （缺省值）表示不使用。

- **HDF5Mesh**\ 选项卡制定是否将该网格计数器的结果输出为网格类型的HDF5文件。
   **HDF5Mesh = 1**\ 表示输出， **HDF5Mesh = 0**\ （缺省值）表示不输出。

-  **Geometry**\ 选项卡指定坐标系类别，1为直角坐标系，2为柱坐标系，缺省为1。

-  **Axis**\ 选项卡指定柱坐标系的z轴方向，直角坐标系不定义。

-  **Vector**\ 选项卡的向量和\ **Axis**\ 向量构成的平面为\ **φ = 0**\ 平面，
   \ **Vector**\ 和\ **Axis**\ 可以不垂直，但不能平行，直角坐标系不定义。

-  **Origin**\ 选项卡指定柱坐标系的原点坐标，直角坐标系不定义。

-  **Scope**\ 选项卡指定网格在x，y，z方向的数量。特别地，参数为“-1”表示该方向上
   只有一层无限大网格 (注意：在Universe重复几何中的Scope选项卡当中，参数为1表示
   该方向上只有一层无限大网格)。

-  **Bound**\ 选项卡指定网格在x，y，z方向的边界范围，形如“Bound = x_min
   x_max y_min y_max z_min
   z_max”。若某方向只有一层网格，\ **Bound**\ 选项卡中对应的参数没有实际意义。

-  **BoundX / BoundY / BoundZ**\ 选项卡分别指定非均匀网格在x，y，z方向的粗网格边界序列，
   比如"BoundX = 1.0 3.0 7.0"表示非均匀网格在x方向上有3个粗网格边界，分别为1.0，3.0,7.0。
   注意：每个方向上的粗网格边界序列必须单调递增。

-  **ScopeX \ ScopeY \ ScopeZ**\ 选项卡分别指定非均匀网格在x，y，z方向的细网格数量序列，
   比如"ScopeX = 2 8"表示非均匀网格在x方向上共有两个粗网格，每个粗网格内依次有2、8个细网格。
   注意：粗网格边界的数量必须比粗网格数量多1，此外，**程序暂不支持某一方向上只有一层无限大网格的
   非均匀网格**。
   
对于某一个MeshTally，均匀化网格参数/非均匀化网格参数仅能二选其一，不可以同时输入。

以下输入卡分别定义了一个均匀化网格和一个非均匀化网格。编号为1的MeshTally为均匀化网格，
在x方向上的边界为0、21.42,均匀划分为17个网格；
在y方向上的边界为0、21.42,均匀划分为17个网格；
在z方向上无限大。

编号为2的MeshTally为非均匀化网格，
在x方向上，[0, 21.42]间均匀划分为17个网格，[21.42, 42.84]间均匀划分为17个网格；
在y方向上，[0, 21.42]间均匀划分为17个网格，[21.42, 42.84]间均匀划分为17个网格；
在z方向上，[0, 300]间均匀划分为30个网格，[300, 1000]间均匀划分为10个网格，
[1000, 3000]间均匀划分为20个网格。

.. code-block:: c

    Tally
    MeshTally 1 Type = 1 Bound = 0 21.42 0 21.42 0 0 Scope = 17 17 -1
    MeshTally 2 Type = 2 BoundX = 0 21.42 42.84 ScopeX = 17 17
                         BoundY = 0 21.42 42.84 ScopeY = 17 17
                         BoundZ = 0 300 1000 3000 ScopeZ = 30 10 20


面计数器
--------------

面计数器的输入卡为：

.. code-block:: none

	SurfTally  <id>  [Particle=<particle>] [Type = <type>] [Surf=<surf_bin>]  
		[Cell = <cell_vector_group>] [Filter = <params>] [Integral = <params>] 
		[Area=<area>] [Vector=<vec>] [Multiplier=<mul>]  [Dose=<dose>] 
		[Attenuator=<att>] [Gaussian=<gaussian>]  [Energy = <erg_bin>] 
		[Cosine=<cosine>] [Value=<val_bin>] [Segment=<seg_bin>]
        [Flag=<flag_bin>] [Source=<source_bin>] [Nest=<nest>]

其中，

-  **SurfTally**\ 为面计数器输入卡的关键词。

-  **id**\ 为面计数器的编号，便于查阅输出。

-  **Type**\ 卡指定计数类型。0-中子或光子流；1-中子或光子通量，默认值为1。
   注意当Type不为1时与Multiplier、Dose卡冲突。
   
-  **Cell、Filter、Integral**\ 选项卡用于描述计数栅元，用法和CellTally中相同。

-  **particle**\ 为栅元计数器统计的粒子类型，1代表中子、2代表光子、3代表电子。

-  **Area**\ 为曲面面积列表，为正数，和归并后的Surf数对应，注意只适用于Type=1情况。
  
-  **Vector**\ 可以设置面流的参考向量，需要和余弦分箱配合使用
  
-  **Multiplier**\ 为截面乘子，为整数，用于自定义乘数或反应截面，在使用Multiplier时计数
   类型Type必须设置为1，且不能使用Dose功能。
   
-  **Dose**\ 用于统计剂量，使用方法和CellTally中相同。
   
-  **Attenuator**\ 为衰减乘子，用于计算衰减因子，其用法和Celltally中相同。

-  **Gaussian**\ 定义高斯能量展宽，是由实数构成的展宽数组，其用法在后面介绍。

-  **Energy**\ 选项卡指定分群计数的能量区间，参数为能量间隔点（Mev）。例如，
   “\ **Energy = 0 6.25E-7 20**\ ”表示计数区间为0到0.625ev，0.625ev到20Mev，20Mev
   到正无穷，   共3个区间；同时，程序还将给出总计数。特别地，对于多群临界计
   算，“\ **Energy  = -1**\ ”表示使用截面数据库的能群结构划分。若输入中
   没有\ **Energy**\ 选项卡，则表示只统计总的计数率。
   
-  **Cosine**\ 选项卡用于定义角度分箱，其用法在后面介绍。

-  **Value**\ 用于定义计数值分箱，即对计数器的单次计数器进行分箱处理。
   
-  **Segment**\ 用于定义切割分箱，其用法和Celltally中相同。

-  **Flag**\ 用于定义标记分箱，即对穿过某个特定面或栅元的粒子单独进行统计，其用法和Celltally中相同。

-  **Source**\ 用于定义源分箱，即对抽样自某个源的粒子单独进行统计，仅用于固定源计算中，其
   用法和Celltally中相同。

-  **Nest**\ 用于定义分箱之间的嵌套，如输出能量分箱和余弦分箱之间的嵌套，其用法和celltally中相同。 

Surf选项卡
~~~~~~~~~~~~~~~~~~~~~~

Surf选项卡指定要计数的面，有面定位和栅元定位两种输入模式。需要注意的是\ **指定的面必须是参与构成cell的面** \。
任意定义的surf是无法参与统计的。

1、面定位

采用面定位时，用户指定统计面，该面上所有粒子不论位置方向均统计，
此时与Cell、Filter和Integral选项卡冲突。注意：\ **RMC几何许多面均为无限大，若用户要统计有限大面的相关计数，建议采用第二种方式，利用栅元定位，否则很容易出错** \。

输入格式为Surf=s1…(si…sj)…sn，即分别统计各个面上的tally值，括号为面归并，
不支持括号嵌套。由于si是Surf卡中面编号，而对于重复几何结构大量面并未出现
在Surf卡而是以栅元定位，所以此输入模式不适合重复几何结构。

2、栅元定位

采用此模式时，输入格式为Surf=s，s须为SURF卡中包含的面编号，配合Cell、Filter
和Integral选项卡使用，产生的分箱数与CellTally中语法规定的相同，统计的面为面
s在对应cell上的部分，如果cell有归并的效果，对应的子面也同样进行归并。

面计数器需要注意的是如果想统计除面流和面通量外的物理量，无法通过Type卡实现
而只能通过Multiplier手动实现。这是因为统计面两侧的材料可能不同而导致无法确定截面。

Vector选项卡和Cosine选项卡
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Cosine选项卡可以用于统计面流的角度分箱，在使用Cosine选项卡时需要指定Type=0。Cosine
选项卡的输入格式为Cosine=bn，bn为Bin卡中对应的分箱编号。在Bin卡中，Type=1，value=u0,
u1,u2,...un，u为指定分箱的余弦值。

Vector选项卡可以指定面流的参考向量，其输入格式为 **Vector**\ =x y z。在不使用参考向量
的时候，默认的参考向量即为面的法向量。

点计数器
--------------

点计数器的输入卡为：

.. code-block:: none

	PointTally  <id> [Particle=<particle>] [Point=<x> <y> <z>]
		[Radius=<r>] [Multiplier=<mul>] [Dose=<dose>] [Attenuator=<att>]
		[Gaussian=<gaussian>] [Value=<val_bin>] [Energy = <erg_bin>] 
        [Number=<number>] [Cell=<cell>] [Source=<source_bin>] [Nest=<nest>]
		
其中，

-  **PointTally**\ 为点计数器输入卡的关键词。

-  **id**\ 为点计数器的编号，便于查阅输出。

-  **Particle**\ 卡指定粒子种类，1-中子，2-光子。
   
-  **Point**\ 选项卡用于描述统计点坐标(cm)，参数为空间三维坐标数组x, y, z。

-  **Radius**\ 用于定义点计数器的均匀球半径(cm)，默认值为0.1。
  
-  **Multiplier**\ 为截面乘子，为整数，用于自定义乘数或反应截面，在使用Multiplier时计数
   类型Type必须设置为1，且不能使用Dose功能。
   
-  **Dose**\ 用于统计剂量，使用方法和CellTally中相同。
   
-  **Attenuator**\ 为衰减乘子，用于计算衰减因子，其用法和Celltally中相同。

-  **Gaussian**\ 定义高斯能量展宽，是由实数构成的展宽数组，其用法在后面介绍。

-  **Value**\ 用于定义计数值分箱，即对计数器的单次计数器进行分箱处理。

-  **Energy**\ 选项卡指定分群计数的能量区间，参数为能量间隔点（Mev）。例如，
   “\ **Energy = 0 6.25E-7 20**\ ”表示计数区间为0到0.625ev，0.625ev到20Mev，20Mev
   到正无穷，   共3个区间；同时，程序还将给出总计数。特别地，对于多群临界计
   算，“\ **Energy  = -1**\ ”表示使用截面数据库的能群结构划分。若输入中
   没有\ **Energy**\ 选项卡，则表示只统计总的计数率。
   
-  **Number**\ 选项卡用于定义碰撞次数分箱，其用法在后面介绍。

-  **Cell**\ 选项卡定义碰撞点栅元数组，其用法在后面介绍。

-  **Source**\ 用于定义源分箱，即对抽样自某个源的粒子单独进行统计，仅用于固定源计算中，其
   用法和Celltally中相同。

-  **Nest**\ 用于定义分箱之间的嵌套，如输出能量分箱和碰撞次数分箱之间的嵌套，其用法和celltally中相同。

Number选项卡
~~~~~~~~~~~~~~~~~~~~

Number选项卡用于对统计粒子在粒子输运过程中发生的碰撞次数进行分箱，
输入格式为Number=bn，n为Bin卡id号，Bin卡中Type=2，value=n1 n2…(ni…nj)…nm，
括号用于归并，不支持括号嵌套，括号内外均满足互斥性，不满足完整性。

Cell选项卡
~~~~~~~~~~~~~~~~~~~

Cell选项卡用于对统计粒子所处的栅元进行分箱，输入格式为Cell=bn，
n为Bin卡id号，Bin卡中Type=2，value=c1 c2…(ci…cj)…cn，括号用于归并，
不支持括号嵌套，括号内外均满足互斥性，不满足完整性，ci为输入的栅元号，
不支持重复几何结构。

RMC点计数器对外源、裂变反应、中子致光子反应和光核反应均有各向同性的假设。

点计数器用于分箱和计算截面的能量和输运过程的能量通常不同，每次计算截面时
需要重新插值，因此无法使用Type功能计算除通量以外的物理量，用户可根据需要
使用Multiplier卡实现。

点计数器使用相比于栅元计数器和面计数器有以下几点注意；

1、点计数器是基于碰撞点次级事件估计法原理的计数器，由于次级事件估计法对于
碰撞点距离点探测距离过近的情形存在二次奇点情形，因此RMC采用均匀化处理，用
户需指定R_0 ，以半径为R_0 ，球心为点计数器的小球来代替探测点。R_0选取过大则误差
较大，较小则方差过大，用户可以探测点所处材料的平均自由程为
参考多次选取，直至在满足方差要求的基础上使R_0尽可能小。需要注意的是为了保证
R_0小球内部是均匀的，小球不能跨过两边材料不同的边界。

分箱
--------------

RMC对分箱的具体信息使用了单独的输入卡，使得多个计数器可以共用分箱以简化
输入，且程序对分箱功能有更好的扩展性。

分箱的输入卡为：

.. code-block:: none

	Bin    <id>    [Type = <type>]  [Bound = <params>]  [Value = <params>] 
        [Weight=<wgt>] 

其中，

- Bin为分箱输入卡的关键词。

-	id为分箱的编号，便于查阅输出。

- Type卡指定分箱类型。Type = 1表示连续区间分箱，Type = 2表示离散值分箱。

- Bound选项卡指定Type = 1时分箱区间的边界，Bound = x1 x2 x3…xn产生n-1个分箱，
  分别为[x1, x2)、[x2, x3)…[xn-1,xn]，注意开闭区间不同。

- Value选项卡指定Type = 2时离散分箱的整数值，Value = i1 i2…(ij…ik)…in，
  括号内为一个分箱。

-	Weight选项卡指定各分箱的权重，数目分箱数需一致。


截面计数器
--------------

截面计数器统计指定栅元内、指定材料的所有核素、指定反应类型的单群截面或分群截面
（目前版本暂不支持分群截面计数器）。截面计数器的输入卡为：

.. code-block:: none

  CsTally <id> [Cell = <cell_vector>] [Mat = <mat>] [Energy = <erg_bin>]
  [MT = <mt_list_1, mt_list_2, …>]



其中，

-  **CsTally**\ 为截面计数器输入卡的关键词。

-  **id**\ 为计数器的编号。

-  **Cell**\ 卡指定被计数的栅元。注意与栅元计数器不同的是，截面计数器输入的是
   单个栅元向量，且必须是底层栅元。此外还需注意，在不同的\ **CsTally**\ 卡当
   中，\ **Cell**\ 卡不允许重复。

-  **Mat**\ 卡指定被计数的材料。该材料可以不同于计数器栅元中实际填充的材料。用户
   若需要统计同一个栅元中的不同核素的截面，可以将这些核素定义在同一种材料中即可。

-  **Energy**\ 选项卡指定分群计数的能量区间，参数为能量间隔点（Mev）。例
   如，“\ **Energy = 0 6.25E-7
   20**\ ”表示计数区间为0到0.625ev，0.625ev到20Mev，20Mev到正无穷；同时，程序还
   将给出总计数。特别地，对于多群临界计算，“\ **Energy = -1**\ ”表示使用截面数据
   库的能群结构划分。若输入中没有\ **Energy**\ 选项卡，则表示只统计总的计数率。
   目前RMC版本暂不支持分能群统计功能，\ **Energy**\ 选项卡被关闭。

-  **MT**\ 选项卡指定各个核素的反应类型。每个核素可以对应多个反应类型，核素之间
   以逗号间隔，例如“MT = 16 17 , 102, -6, 107”。反应类型与编号的对应关系可查阅
   ENDF/B手册，:numref:`mt_table` 给出常见的一些反应类型编号。

.. table:: 反应类型与编号的对应关系（仅列出部分ENDF反应类型）
  :name: mt_table

  +-----------+-------------+-------------------------------------------------------------+
  | MT编号    | 反应类型    | 备注                                                        |
  +===========+=============+=============================================================+
  | **-1**    | 总截面      | 对于连续能量ACE截面，当截面温度与栅元温度不匹配时，采取多普 |
  |           |             | 勒展调整弹性散射截面和总截面。这里统计的是调整后的截面。    |
  +-----------+-------------+-------------------------------------------------------------+
  | **-2**    | 吸收        | 不包含裂变                                                  |
  +-----------+-------------+-------------------------------------------------------------+
  | **-3**    | 弹性散射    |                                                             |
  +-----------+-------------+-------------------------------------------------------------+
  | **-6**    | 裂变        |                                                             |
  +-----------+-------------+-------------------------------------------------------------+
  | **16**    | (n, 2n)     | 仅限连续能量ACE截面                                         |
  +-----------+-------------+-------------------------------------------------------------+
  | **17**    | (n, 3n)     |                                                             |
  +-----------+-------------+-------------------------------------------------------------+
  | **102**   | (n, γ)      |                                                             |
  +-----------+-------------+-------------------------------------------------------------+
  | **103**   | (n, p)      |                                                             |
  +-----------+-------------+-------------------------------------------------------------+
  | **107**   | (n, α）     |                                                             |
  +-----------+-------------+-------------------------------------------------------------+

以下输入卡统计了某个栅元（1 > 221 > 145 >
35）当中的3种核素的单群截面，其中包括：
U235的裂变截面，U238的吸收截面和裂变截面，O16的辐射俘获截面。

.. code-block:: c

  MATERIAL
  mat 2 -10.196
      92235.30c 0.03
      92238.30c 0.97
      8016.30c 2.0
  CsTally 1 Cell = 1 > 221 > 145 > 35 Mat = 2 MT = -6 , -2 -6 , 102

.. _section_accetally:

计数器统计检验
------------------------------


RMC可以针对不同的计数器提供一般性的统计检验功能，使用统计检验功能需要在计数器输入卡中开启统计检验开关：

.. code-block:: none

    Scheck 1

此开关默认情况下关闭，打开后对所有的计数器进行统计检验，由于统计检验功能会占用较大的内存并且对计算速度有
一定的影响，用户可以自行指定关闭特定计数器的统计检验开关，在cellTally、meshTally等计数器卡中设置check=0即可关闭
针对该计数器的统计检验。目前统计检验功能适用于固定源计算和临界计算模式。

当打开统计检验功能后，计数器输出的h5文件中除了平均值和方差之外，还会有额外的统计参数和检验结果。现将统计涨落的输出
内容介绍如下：

（1）10项基本的统计检验功能，在表格TenStatisticsChecks中输出，分别有：MeanBehaviourCheck、
ReValueCheck、ReDecreaseCheck、ReDeRateCheck、VOVValueCheck、VoVDecreaseCheck、
VoVDeRateCheck、FoMValueCheck、FoMBehaviourCheck、PdfSlopeCheck；

（2)一些统计学参数，具体说明如下：

- Confidence_interval_shift：表示由于实际分布并非正态分布而因此对平均值进行的修正，具体统计方法见理论手册；
- Shifted_confidence_interval_center：经过修正后的平均值（置信区间中点）；
- Efficiency_for_the_nonzero_tallies：计数效率，即非零计数粒子占总模拟粒子数的比例；
- Final_VOV：最终得到的相对方差的方差，具体统计方式见理论手册；
- Largest_unnormalized_history_tally：对该计数器贡献最大的粒子的计数值（未除以体积）；
- Unnorm_average_tally_per_history：未除以体积的计数平均值；
- Number_of_nonzero_history_tallies：非零的计数粒子的数目；
- Relative_error_from_nonzero_tallies：只考虑非零计数粒子对方差的贡献；
- Relative_error_from_zero_tallies：零计数粒子对方差的贡献；
- PDF_slope：计算得到的pdf函数斜率，具体定义和统计方式见理论手册；
- Fluctuated_Mean：如果对该计数器贡献最大的粒子在下次模拟中再次出现，受到影响的平均值；
- Fluctuated_Re：如果对该计数器贡献最大的粒子在下次模拟中再次出现，受到影响的相对标准差；
- Fluctuated_VOV：如果对该计数器贡献最大的粒子在下次模拟中再次出现，受到影响的相对方差的方差；
- Fluctuated_FOM：如果对该计数器贡献最大的粒子在下次模拟中再次出现，受到影响的品质因子；
- Fluctuated_Shifted_Center：如果对该计数器贡献最大的粒子在下次模拟中再次出现，受到影响的平均值修正量；

（3）pdf函数分布表pdfTable，将计数值按照对数等间隔划分为若干组，记录落入每组中的粒子数和粒子的计数和；

（4）一些基本统计参数的分组输出，包括Batches_of_Mean、Batches_of_Re、Batches_of_VoV、
Batches_of_FOM。


计数器加速及计数器数据分解（仅限企业版本）
-----------------------------------------------------


针对含大量栅元的栅元计数器和含大量核素的截面计数器，RMC提供相应的加速功能。计数
器加速的输入卡为：

.. code-block:: none

    AcceTally [Map = <flag>] [Union = <flag>] [DataDecomposition = <flag>]



其中，

-  **AcceTally**\ 为计数器加速输入卡的关键词。

-  **Map**\ 选项卡指定是否使用栅元快速定位方法来处理栅元计数器。\ **Map = 1**\
   （缺省值）表示使用快速定位方法，\ **Map = 0**\ 表示不使用快速定位。当栅元计数
   器栅元含有大量栅元时，开启该选项能显著节省计算时间。

-  **Union**\ 选项卡指定是否使用统一能量框架方法来处理截面计数器。\ **Union=
   1**\ 表示使用统一能量框架方法，\ **Union= 0**\ （缺省值）表示不使用统一能量框
   架方法。当截面计数器栅元内含有大量核素时，使用统一能量框架方法能节省计算时
   间，但代价是丢失了方差信息以及消耗额外的内存。

-  **DataDecomposition**\ 选项卡指定是否使用计数器数据分解。
   \ **DataDecomposition = 1**\表示使用计数器数据分解，
   \ **DataDecomposition = 0**\（缺省值）表示不使用计数器数据分解。

.. _section_tally_example:

计数器模块输入示例
----------------------

6.5.1 PWR燃料棒轴向分段计数
PWR燃料棒轴向分段计数
~~~~~~~~~~~~~~~~~~~~~~~~~~~

:numref:`pwrpin_tally_input` 是一个PWR的燃料棒，轴向分为10段。计数器模块中分别定
义了两个栅元计数器、一个网格计数器和一个截面计数器。

第一个栅元计数器（CellTally
1）统计轴向各段燃料区和慢化剂区的分能群通量，第二个栅元计数器（CellTally
2）统计轴向各段燃料区的裂变反应率之和。网格计数器（MeshTally
1）统计轴向100段的分能群通量分布。截面计数器（CsTally
1）统计第5段燃料区的各核素的单群截面：U235的裂变截面（-6）和辐射俘获截面（102），
U238的裂变截面（-6）、n-2n截面（16）和辐射俘获截面（102），O16的n-a截面（107）。

|

.. code-block:: c
  :caption: PWR燃料棒计数器输入
  :name: pwrpin_tally_input

  ///// PWR pin divided into 10 nodes in axial. Qiu Yishu 2012-09-15 //////
  UNIVERSE 0
  cell 1 6 & -7 & 8 & -9 & 10 & -11 Fill = 8 // Pin inside
  cell 2 -6 : 7 : -8 : 9 : -10 : 11 void = 1 // Pin outside

  UNIVERSE 8 lat = 1 pitch = 1 1 0.5 scope = 1 1 10  fill =
      1 * 10

  UNIVERSE 1 move = 0.63 0.63 0 // Fuel rod
  cell 3 -1 mat = 1             // Fuel
  cell 4 1 & -2 mat = 3         // Air
  cell 5 2 & -3 mat = 4         // Zr
  cell 6 3 mat = 5              // water

  SURFACE
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 6 px 0 bc = 1
  surf 7 px 1.26 bc = 1
  surf 8 py 0 bc = 1
  surf 9 py 1.26 bc = 1
  surf 10 pz 0 bc = 1
  surf 11 pz 5 bc = 1

  MATERIAL
  mat 1 -10.196
        92235.30c 6.9100E-03
        92238.30c 2.2062E-01
        8016.30c 4.5510E-01
  mat 3 -0.001
        8016.30c 3.76622E-5
  mat 4 -6.550
        40000.60c -98.2
  mat 5 9.9977E-02
        1001.30c 6.6643E-02
        8016.30c 3.3334E-02
  sab 5 lwtr.60t
  CeAce ErgBinHash = 0 pTable = 0

  CRITICALITY
  PowerIter population = 1000 30 200 // keff0 = 1.0
  InitSrc point = 0.63 0.63 2.75

    Tally
    CellTally 1 type = 1 energy = 0 6.25E-7 20
                     cell = 1 > 1: 10 > 3
                       1 > 1: 10 > 6
    CellTally 2 type = 3 integral = 10
                     cell = 1 > 1: 10 > 3
    MeshTally 1 type = 1 energy = 0 6.25E-7 20
                     Scope = 1 1 100
                     Bound = 0 1.26 0 1.26 0 5
    CsTally 1 cell = 1 > 5 > 3
                     mat = 1
                     mt = -6 102 , -6 16 102, 102


Hoogenboom全堆基准题大规模计数器
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:numref:`hoogenboom_tally_input` 是一个压水堆全堆基准题。堆芯一共包含241个相同的
燃料组件，每个燃料组件包含
17×17个栅元，每个栅元的轴向分为100层。计数器模块中分别定义了五个栅元计数器和两个
截面计数器。第一个栅元计数器统计全堆燃料区域的通量，第二个栅元计数器统计三个不同
位置（0，0）、（3，2）、（-3，2）的燃料组件的通量。第三个栅元计数器统计三个不同
位置（0，0）、（3，2）、（-3，2）的燃料组件的燃料区域的功率。第四个栅元计数器统
计两根不同的燃料棒的裂变反应率。第五个栅元计数器统计某根燃料棒三个不同的轴向节块
的分能群吸收反应率。第一个截面计数器统计某个轴向节块的各核素的单群截面：H1的弹性
散射截面（-3），O16的总截面（-1）和吸收截面（-2），B10的弹性散射截面（-3）和B11
和辐射俘获截面（102）。该材料为该问题实际用到的一种材料。第二个截面计数器统计某
个轴向节块的各核素的单群截面：N14的总截面（-1）、吸收截面（-2）、弹性散射截面
（-3）、裂变截面（-6）、n-2n截面（16）、辐射俘获截面（102）和n-a截面（107）。该
材料为“虚拟的”材料，临界计算实际没有用到这种材料。

|

.. code-block:: c
  :caption: Hoogenboom全堆基准题计数器输入
  :name: hoogenboom_tally_input

  ///// Tally of MC full-core benchmark. /////
  universe 0
  cell 1 -11 : 19 : 9       mat = 0  void = 1         // outside core
  cell 2 11 & -19 & 8 & -9  mat = 1  vol = 1.3575E+07 // reactor vessel
  cell 3 12 & -18 & 7 & -8  mat = 2  vol = 1.1393E+07 // downcomer
  cell 6 18 & -19 & -8      mat = 3  vol = 1.3180E+06 // upper core plate region
  cell 7 11 & -12 & -8      mat = 4  vol = 4.9424E+06 // lower core plate region
  cell 8 17 & -18 & -6      mat = 5  vol = 1.3268E+06 // top nozzle region
  cell 9 12 & -13 & -6      mat = 6  vol = 6.6339E+05 // bottom nozzle region
  cell 10 16 & -17 & -6     mat = 7  vol = 2.2113E+06 // top FA region
  cell 11 13 & -14 & -6     mat = 8  vol = 1.1056E+06 // bottom FA region
  cell 12 16 & -18 & 6 & -7 mat = 9  vol = 8.5323E+05 // radial hot water
  cell 13 12 & -14 & 6 & -7 mat = 10 vol = 4.2662E+05 // radial cold water
  cell 14 14 & -16 & -7    fill = 1  vol = 5.0225E+07

  // assembly zone
  universe 1 move = -224.91 -224.91 -183 lat = 1 pitch = 21.42 21.42 1 scope = 21 21 1 fill=
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 3 3 3 3 3 3 3 2 2 2 2 2 2 2
      2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2
      2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2
      2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2
      2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 2 2 2 2 2
      2 2 2 2 2 2 2 3 3 3 3 3 3 3 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
      2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2

  universe 2 fill = // single reflector lattice
  cell 21 16 mat=9 // upper radial reflector
  cell 22 -16 mat=10 // lower radial reflector

  universe 3 lat = 1 pitch = 1.26 1.26 1 scope = 17 17 1 fill =
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 5 4 4 5 4 4 5 4 4 4 4 4
      4 4 4 4 5 4 4 4 4 4 4 4 5 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 5 4 4 5 4 4 5 4 4 5 4 4 5 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 5 4 4 5 4 4 5 4 4 5 4 4 5 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 5 4 4 5 4 4 5 4 4 5 4 4 5 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 5 4 4 4 4 4 4 4 5 4 4 4 4
      4 4 4 4 4 5 4 4 5 4 4 5 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4
      4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4 4

  universe 4 lat=1 pitch = 1 1 3.66 scope = 1 1 100 fill =
           6*50 7*50

  universe 5 lat=1 pitch = 1 1 3.66 scope = 1 1 100 fill =
           8*50 9*50

  universe 6 move = 0.63 0.63 1.83
  cell 100 -1 mat=11
  cell 24 1 & -2 mat=12
  cell 25 2 mat=2

  universe 7 move = 0.63 0.63 1.83
  cell 101 -1 mat =11
  cell 27 1 & -2 mat =12
  cell 28 2 mat =22

  universe 8 move = 0.63 0.63 1.83
  cell 29 -3 mat =2
  cell 30 3 & -4 mat =12
  cell 31 4 mat =2

  universe 9 move = 0.63 0.63 1.83
  cell 32 -3 mat =22
  cell 33 3 & -4 mat =12
  cell 34 4 mat =22

  SURFACE
  surf 1 cz 0.41
  surf 2 cz 0.475
  surf 3 cz 0.56
  surf 4 cz 0.62
  surf 5 cz 1.26
  surf 6 cz 187.6
  surf 7 cz 209
  surf 8 cz 229
  surf 9 cz 249 bc =1 // radial boundary
  surf 11 pz -229 bc =1 // bottom boundary
  surf 12 pz -199
  surf 13 pz -193
  surf 14 pz -183
  surf 15 pz 0
  surf 16 pz 183
  surf 17 pz 203
  surf 18 pz 215
  surf 19 pz 223 bc =1 // upper boundary

  MATERIAL
  mat 1 -7.9 // reactor vessel
        26054.30c -5.4371E-02 26056.30c -8.8501E-01 26057.30c -2.0801E-02
        26058.30c -2.8216E-03 28058.30c -6.7198E-03 28060.30c -2.6776E-03
        28061.30c -1.1830E-04 28062.30c -3.8350E-04 28064.30c -1.0080E-04
        25055.30c -1.0000E-02 42000.60c -6.0000E-03 14028.30c -3.6746E-03
        14029.30c -1.9336E-04 14030.30c -1.3200E-04 24050.30c -1.0435E-04
        24052.30c -2.0925E-03 24053.30c -2.4185E-04 24054.30c -6.1325E-05
         6000.30c -2.5000E-03 29063.30c -1.3696E-03 29065.30c -6.3040E-04
  mat 2 -0.74 // Borated water below midplane
        1001.30c 2.0000E+00 8016.30c 1.0000E+00 5010.30c 6.4900E-04
        5011.30c 2.6890E-03
  sab 2 lwtr.60t
  mat 22 -0.66 // Borated water above midplane
        1001.30c 2.0000E+00 8016.30c 1.0000E+00 5010.30c 6.4900E-04
        5011.30c 2.6890E-03
  sab 22 lwtr.60t
  mat 3 -4.28 // top core plate region
        1001.30c -8.6117E-03 8016.30c -6.8337E-02 5010.30c -2.7764E-05
        5011.30c -1.2648E-04 26054.30c -3.5954E-02 26056.30c -5.8522E-01
        26057.30c -1.3755E-02 26058.30c -1.8658E-03 28058.30c -5.5815E-02
        28060.30c -2.2240E-02 28061.30c -9.8261E-04 28062.30c -3.1854E-03
        28064.30c -8.3725E-04 25055.30c -1.8458E-02 28058.30c -8.4783E-03
        28060.30c -4.4613E-04 28061.30c -3.0456E-04 24050.30c -7.3191E-03
        24052.30c -1.4677E-01 24053.30c -1.6963E-02 24054.30c -4.3013E-03
  mat 4 -7.184 // bottom plate region
        1001.30c -1.1505E-03 8016.30c -9.1296E-03 5010.30c -3.7092E-06
        5011.30c -1.6897E-05 26054.30c -3.8556E-02 26056.30c -6.2759E-01
        26057.30c -1.4750E-02 26058.30c -2.0009E-03 28058.30c -5.9855E-02
        28060.30c -2.3850E-02 28061.30c -1.0537E-03 28062.30c -3.4159E-03
        28064.30c -8.9785E-04 25055.30c -1.9794E-02 28058.30c -9.0920E-03
        28060.30c -4.7842E-04 28061.30c -3.2660E-04 24050.30c -7.8489E-03
        24052.30c -1.5739E-01 24053.30c -1.8191E-02 24054.30c -4.6127E-03
  at 5 -1.746 // top nozzle region
        1001.30c -3.5887E-02 8016.30c -2.8478E-01 5010.30c -1.1570E-04
        5011.30c -5.2708E-04 26054.30c -2.6440E-02 26056.30c -4.3037E-01
        26057.30c -1.0115E-02 26058.30c -1.3721E-03 28058.30c -4.1046E-02
        28060.30c -1.6355E-02 28061.30c -7.2261E-04 28062.30c -2.3425E-03
        28064.30c -6.1571E-04 25055.30c -1.3574E-02 28058.30c -6.2349E-03
        28060.30c -3.2808E-04 28061.30c -2.2397E-04 24050.30c -5.3825E-03
        24052.30c -1.0793E-01 24053.30c -1.2475E-02 24054.30c -3.1632E-03
  mat 6 -2.53 // bottom nozzle region
        1001.30c -2.4501E-02 8016.30c -1.9443E-01 5010.30c -7.8992E-05
        5011.30c -3.5985E-04 26054.30c -3.0411E-02 26056.30c -4.9501E-01
        26057.30c -1.1635E-02 26058.30c -1.5782E-03 28058.30c -4.7211E-02
        28060.30c -1.8812E-02 28061.30c -8.3114E-04 28062.30c -2.6944E-03
        28064.30c -7.0819E-04 25055.30c -1.5613E-02 28058.30c -7.1713E-03
        28060.30c -3.7736E-04 28061.30c -2.5761E-04 24050.30c -6.1909E-03
        24052.30c -1.2414E-01 24053.30c -1.4348E-02 24054.30c -3.6383E-03
  mat 7 -1.762 // top FA region
        1001.30c -2.9286E-02 8016.30c -2.3239E-01 5010.30c -9.4416E-05
        5011.30c -4.3012E-04 40000.60c -7.3780E-01
  mat 8 -3.044 // bottom FA region
        1001.30c -1.6291E-02 8016.30c -1.2928E-01 5010.30c -5.2523E-05
        5011.30c -2.3927E-04 40000.60c -7.3780E-01
  mat 9 -4.28 // upper radial reflector
        1001.30c -8.6117E-03 8016.30c -6.8337E-02 5010.30c -2.7764E-05
        5011.30c -1.2648E-04 26054.30c -3.5954E-02 26056.30c -5.8522E-01
        26057.30c -1.3755E-02 26058.30c -1.8658E-03 28058.30c -5.5815E-02
        28060.30c -2.2240E-02 28061.30c -9.8261E-04 28062.30c -3.1854E-03
        28064.30c -8.3725E-04 25055.30c -1.8458E-02 28058.30c -8.4783E-03
        28060.30c -4.4613E-04 28061.30c -3.0456E-04 24050.30c -7.3191E-03
        24052.30c -1.4677E-01 24053.30c -1.6963E-02 24054.30c -4.3013E-03
  mat 10 -4.32 // lower radial reflector
        1001.30c -9.5661E-03 8016.30c -7.5911E-02 5010.30c -3.0841E-05
        5011.30c -1.4050E-04 26054.30c -3.5621E-02 26056.30c -5.7981E-01
        26057.30c -1.3628E-02 26058.30c -1.8485E-03 28058.30c -5.5298E-02
        28060.30c -2.2034E-02 28061.30c -9.7351E-04 28062.30c -3.1559E-03
        28064.30c -8.2950E-04 25055.30c -1.8287E-02 28058.30c -8.3998E-03
        28060.30c -4.4200E-04 28061.30c -3.0174E-04 24050.30c -7.2514E-03
        24052.30c -1.4541E-01
        24053.30c -1.6806E-02 24054.30c -4.2615E-03
  mat 11 -10.062 // fuel
        92234.30c 4.9476E-06 92235.30c 4.8218E-04 92236.30c 9.0402E-05
        92238.30c 2.1504E-02 93237.30c 7.3733E-06 94238.30c 1.5148E-06
        94239.30c 1.3955E-04 94240.30c 3.4405E-05 94241.30c 2.1439E-05
        94242.30c 3.7422E-06 95241.30c 4.5041E-07 95242.30c 9.2300E-09
        96243.30c 4.7878E-07 96242.30c 1.0485E-07 96243.30c 1.4300E-09
        96244.30c 8.8760E-08 96245.30c 3.5300E-09 42095.30c 2.6497E-05
        43099.30c 3.2772E-05 44101.30c 3.0742E-05 44103.30c 2.3505E-06
        47109.30c 2.0009E-06 54135.30c 1.0800E-08 55133.30c 3.4612E-05
        60143.30c 2.6078E-05 60145.30c 1.9898E-05 62147.30c 1.6128E-06
        62149.30c 1.1627E-07 62150.30c 7.1727E-06 62151.30c 5.4947E-07
        62152.30c 3.0221E-06 63153.30c 2.6209E-06 64155.30c 1.5400E-09
        8016.30c 4.5737E-02
  mat 12 -5.77 // cladding composition also the guide tube ma
        40000.60c -7.3780E-01
  mat 13 1.0 // a material which is not used in the problem
        7014.30c 1.0

  CRITICALITY
  PowerIter population = 100000 250 1250 // keff0 = 1.0
  InitSrc point = 1.26 0 0.1
  ParallelBank 1

    Tally
    celltally 1 Type = 1 filter = 1 0 0 0 1 integral = 2
                cell = 14 > 0 > 0 > 0 > 100:101
    celltally 2 Type = 1 filter = 1 1
                cell = 14 > 221
                       14 > 266
                       14 > 260
    celltally 3 Type = 2 filter = 1 1 0 0 1 integral = 2*3
                cell = 14 > 221 > 0 > 0 > 100:101
                       14 > 266 > 0 > 0 > 100:101
                       14 > 260 > 0 > 0 > 100:101
    celltally 4 Type = 3 filter = 1 1 1
                Cell = 14 > 266 > 1
                       14 > 266 > 164
    celltally 5 Type = 4 Energy=0 6.25E-07
                Cell = 14 > 266 > 164 > 1 > 100
                14 > 266 > 164 > 50 > 100
                14 > 266 > 164 > 100 > 101
    CsTally 6 Cell = 14 > 266 > 164 > 49 > 100
               Mat = 2 MT = -3, -1 -2, -3, 102
    csTally 7 Cell = 14 > 266 > 164 > 51 > 101
               Mat = 13 MT = -1 -2 -3 -6 16 17 102 103 107


|

.. _section_fsc:

源收敛诊断与加速
======================

蒙卡临界计算采用裂变源迭代法，裂变源分布的收敛速度取决于系统占优比。对于高占优比
的系统（如全堆、乏燃料池），裂变源收敛可能需要数百代甚至上千代，从而导致大量计算
时间耗费在对统计结果无直接贡献的非活跃代。

.. _section_fsc_semesh:

香农熵和渐进相对熵统计
------------------------

RMC源收敛模块提供香农熵（Shannon Entropy）统计功能，定性地反映裂变源分布的收敛
趋势，帮助用户选择合理的非活跃代中子数。

香农熵的定义为：

.. math::

    H(S) = - \sum_{i} S(i) \log _2 \left( S(i) \right)

其中，:math:`S(i)` 为第 :math:`i` 个网格的裂变源份额。

RMC源收敛模块也提供渐进相对熵（Progressive Relative Entropy, PRE）统计功能。与香农熵功能类似，
PRE可以定性地反映裂变源分布的收敛趋势，帮助用户选择合理的非活跃代中子数。

相对熵的定义为：

.. math::

    D(S||Y) = \sum_{i=1}^B S(i) \log _2 \left( \frac{S(i)}{Y(i)} \right)

其中， :math:`S` 和 :math:`Y` 都是裂变源分布，:math:`S(i)` 和 :math:`Y(i)` 是第 :math:`i` 个网格的裂变源份额。
:math:`D(S||Y)` 始终非负， 且当 :math:`S = Y` 时， :math:`D(S||Y) = 0` 。

香农熵能够表征源分布的无序程度，相对熵则表征两个源分布之间的偏离程度。相对熵越大，偏离程度越大，两个源分布间的相似度越小。
相对熵可能出现无穷大的情况，因此更好地表征两个源分布之间偏离程度的量是渐进相对熵PRE。PRE的定义为：

.. math::

    PRE(j) = D(S^{(1)} || 0.5 \times (S^{(1)} + S^{(j)})) + D(S^{(j)} || 0.5 \times (S^{(1)} + S^{(j)}))

其中，:math:`S^{(j)}` 为第 :math:`j` 个迭代步的裂变源分布。

香农熵或渐进相对熵通过以下输入卡定义：

.. code-block:: none

  SeMesh [Scope = < xNum yNum zNum >]
  [Bound = <xMin xMax yMin yMax zMin zMax>]
  [PRE = <flag>]
  [Output = <flag>]

其中，

-  **SeMesh**\ 为香农熵网格输入卡的关键词。

-  **Scope**\ 选项卡指定香农熵网格在x、y、z方向的网格划分数量。\ **xNum**\ 、
   \ **yNum**\ 、\ **zNum**\ 为正整数。

-  **Bound**\ 选项卡指定香农熵网格在x、y、z方向的边界范围。若在\ **Scope**\ 选项
   卡中指定某个方向的网格划分数量为-1，则默认网格边界为（-∞，+∞），此时
   \ **Bound**\ 选项卡中相应方向的边界不产生实际意义。\ *注意，用户应保证网格范
   围能够覆盖中子跟踪区域，否则会造成香农熵的统计结果错误。*

-  **PRE**\ 选项卡指定是否计算渐进相对熵。当\ **PRE = 1**\ 时，计算渐进相对熵；
   当\ **PRE = 0**\ 时，不计算渐进相对熵（默认值）。\ *注意，
   程序只能计算香农熵或渐进相对熵，不能同时既计算香浓熵，也计算渐进相对熵。*
   
-  **Output**\ 选项卡指定是否输出网格中的中子源份额。
   当\ **Output = 0**\ （默认值）时，不输出中子源份额；
   当\ **Output = 1**\ 时，输出每代的中子源份额到\ **.Info.h5**\ 文件中的
   \ **convergence/source**\ 数据组中，每代数据集以代数命名。

.. _section_fsc_fet:

裂变源分布泛函展开系数统计
----------------------------

RMC源收敛模块提供统计泛函展开系数以表征裂变源分布形状的功能，
定性地反映裂变源分布形状随迭代步的变化情况，
帮助用户选择合理的非活跃代中子数。

该功能通过以下输入卡定义：

.. code-block:: none

  FET [Axis = <x y z>]
  [Bound = <x_boundary_min x_boundary_max y_boundary_min y_boundary_max z_boundary_min z_boundary_max>]

其中，

-  **FET**\ 为该功能输入卡的关键词。

-  **Axis**\ 指定裂变源分布形状的坐标轴。程序只允许从笛卡尔坐标系的x、y、z
   三种坐标轴方向上分别使用泛函展开系数表征裂变源分布形状。
   例如，若需要x和z方向的泛函展开系数以表征裂变源分布形状，
   需要指定\ **Axis = 1 0 1**\ 。

-  **Bound**\ 选项卡指定裂变源分布形状在三个方向的边界范围。
   该边界范围需要大于所有中子可能发生裂变反应的位置，
   在此基础上越小越好。
   注意，\ **boundary_min < boundary_max**\ 。
   当不需要统计某个方向时，相关的数值可以任意。
   例如，若需要x和z方向的泛函展开系数以表征裂变源分布形状，
   可以指定\ **Bound = -300 300 0 0 0 300**\ 。

需要说明的是，该选项不兼容裂变源收敛加速方法（渐进维兰德、渐进超历史方法）。

.. _section_fsc_fmmesh:

裂变矩阵统计
----------------

RMC源收敛模块还提供裂变矩阵（Fission Matrix）统计功能。基于裂变矩阵，可以诊断蒙
卡低抽样（undersampling），并计算占优比。除了使用裂变矩阵计算占优比以外，RMC还支
持基于误差传递矩阵的占优比计算方法，目前版本暂不提供。

裂变矩阵的定义为：裂变矩阵\ *F*\ 中的每个元素 :math:`F_{ij}` 表示区域 :math:`j`
中出生的中子在区域 :math:`i` 中产生裂变中子的几率。

.. math::

    F_{ij} = \frac {\int _{Vi} dr \int _{Vj} dr' f(r'\rightarrow r) s_0 (r') }
    {\int _{Vj} dr' s_0 (r')}



裂变矩阵统计卡的输入方式与香农熵统计卡类似：

.. code-block:: none

  FmMesh [Scope = < xNum yNum zNum >]
  [Bound = <xMin xMax yMin yMax zMin zMax>]



其中，

-  **FmMesh**\ 为裂变矩阵网格输入卡的关键词。

-  **Scope**\ 选项卡指定香农熵网格在x、y、z方向的网格划分数量。\ **xNum**\ 、
   \ **yNum**\ 、\ **zNum**\ 为正整数。裂变矩阵规模为
   (**xNum**\ \*\ **yNum\*zNum**)\ :sup:`2`\ ，过细的网格划分可能降低计算效率。

-  **Bound**\ 选项卡指定香农熵网格在x、y、z方向的边界范围。若在\ **Scope**\ 选项
   卡中指定某个方向的网格划分数量为-1，则默认网格边界为（-∞，+∞），此时
   \ **Bound**\ 选项卡中相应方向的边界不产生实际意义。\ *注意，用户应保证网格
   范围能够覆盖中子跟踪区域，否则会造成裂变矩阵的统计结果错误。*

.. _section_fsc_accefsc:

源收敛加速
--------------

RMC使用渐近超历史方法和渐近维兰德方法加速源收敛，减少非活跃代代数。目前版
本只提供渐近超历史加速方法。

源收敛加速功能的输入卡为：

.. code-block:: none

  AcceFsc [Factor = <f(1) p(1) f(2) p(2) …f(n) p(n)>]
          [AutoFactor = <inactive_cycle>]



其中，

-  **AcceFsc**\ 为香农熵网格输入卡的关键词。

-  **Factor**\ 选项卡和\ **AutoFactor**\ 选项卡用来指定渐近超历史加速方法的参数，
   后面将单独予以讨论。

Factor选项卡
~~~~~~~~~~~~~~~~~~

**Factor**\ 选项卡用于自定义加速参数。输入卡中的f(i)称为加速因子，p(i)称为加速周期，
其含义是：在最初的p(1)代，使用加速因子f(1)；在接下来的p(2)代，使用加速因子
f(2)；依此类推。这里不详细介绍渐近超历史加速方法的原理，仅对加速因子和加速周期
这两个参数介绍如下：

加速因子f(i)越大，加速效果越明显，但统计涨落也可能越大。用户需要定义的是一组
渐近递减的加速因子{f(i)}，譬如“16 → 8 → 4 → 2”。\ *注意，加速因子不宜过大
（建议小于20），否则可能造成不稳定。*

加速周期p(i >1)一般设置为5-10代。第一个加速周期p(1)通常设置得较大，因为它所对
应的加速因子最大，起主要的加速效果。

渐近超历史加速方法作用于最初的个非活跃代，它所产生的加速效果大致相当于未使用加速
时的个非活跃代。例如，某个全堆临界计算在未使用加速时需要大约200个非活跃代，通过
使用“factor = 16 10 8 5 4 5 2 5”加速最初的10+5+5+5=25个非活跃代，即可达到基本相
当的收敛效果。

AutoFactor选项卡
~~~~~~~~~~~~~~~~~~~~~~

作为\ **Factor**\ 选项卡的替代功能，RMC程序提供了自动生成源收敛加速参数的
\ **AutoFactor**\ 选项卡。对于普通用户，推荐使用\ **AutoFactor**\ 选项卡来代替
\ **Factor**\ 选项卡中的自定义输入。在该选项卡中，用户指定未使用加速方法时的非
活跃代代数\ **inactive_cycle**\ ，程序内部将自动生成渐近超历史方法的参数序列。
假设未使用加速方法时的非活跃代代数为N，那么使用\ **AutoFactor**\ 选项卡后的所需
非活跃代数约为：

.. math::

    N' = \frac {N}{16} + 15

例如，某全堆计算需要300代收敛，那么使用自动源收敛加速之后，所需的非活跃代可设
置为：:math:`N' = \frac {300}{16} + 15 \approx 35`。若\ **AutoFactor**\ 选项卡中
指定的非活跃代代数N小于30，程序将关闭源收敛加速功能。

源收敛加速的注意事项
~~~~~~~~~~~~~~~~~~~~~~~~~~

使用源收敛加速方法，应当在临界计算模块的PowerIter输入卡中使用合理的配套参数，包括：

1）在\ **Keff0**\ 选项卡中指定合理的初始有效增殖系数，使其接近真实Keff。

2）在\ **Population**\ 选项卡中指定足够大的每代粒子数。对于全堆临界计算，建议每
代粒子数大于100,000。

3）在\ **Population**\ 选项卡中指定合理的非活跃代代数。非活跃代代数应当大于等于
源收敛加速代数。

.. _section_fsc_example:

源收敛模块输入示例
----------------------

OECD基准题源收敛加速
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. figure:: media/source_convergence.png
   :name: source_convergence_fig

   OECD蒙卡源收敛基准题

:numref:`source_convergence_fig` 描述的是OECD蒙卡源收敛问题研究的一个基准题。
该基准题是由3块1维平板组成的弱
耦合系统，两侧为20cm厚的燃料区，中间为30cm水层。初始源位置位于左侧燃料区中心，
常规源迭代收敛所需的非活跃代约为1000代。通过RMC源收敛加速方法，非活跃代可减少
至100代以内。在 :numref:`source_convergence_input` 的源收敛模块中，
指定了香农熵网格数量为70，宽度为1.0cm。
该算例需要模拟的粒子数较多，推荐使用并行机完成计算。

|

.. code-block:: c
  :caption: OECD蒙卡源收敛输入
  :name: source_convergence_input

  ///// OECD MC convergence benchmark 3 . SHE Ding 2012-09-12 /////
  UNIVERSE 0
  cell 1 1 & -2 mat = 1
  cell 2 2 & -3 mat = 2
  cell 3 3 & -4 mat = 1
  cell 4 -1 : 4 void = 1

  SURFACE
  surf 1 px 0
  surf 2 px 20
  surf 3 px 50
  surf 4 px 70

  MATERIAL
  mat 1 9.9487E-02
        92235.30c 7.6864E-05
        92238.30c 6.8303E-04
        8016.30c 3.7258E-02
        1001.30c 5.9347E-02
        7014.30c 2.1220E-03
  mat 2 1.0006E-01
        1001.30c 6.6706E-02
        8016.30c 3.3353E-02

  CRITICALITY
  PowerIter population = 500000 100 1000
  InitSrc point = 10 0 0

  Tally
  Celltally 1 type = 1 cell = 1 3

  CONVERGENCE
  SeMesh Scope = 70 -1 -1 Bound = 0 70 0 1 0 1
  FmMesh Scope = 70 -1 -1 Bound = 0 70 0 1 0 1
  AcceFsc Autofactor = 1000


Hoogenboom全堆基准题源收敛加速
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:numref:`fsc_hoogenboom_input` 描述的是Hoogenboom蒙卡全堆基准题。常规源迭代收敛所需的非活跃代约为250代，
通过使用自动源收敛加速参数，非活跃代代数设置为35代。在源收敛输入模块中，定义了
建立在组件上的香农熵网格（21×21），用于帮助用户诊断源收敛趋势。该算例需要模拟的
粒子数较多，推荐使用并行机完成计算。

|

.. code-block:: c
  :caption: Hoogenboom蒙卡全堆基准题输入
  :name: fsc_hoogenboom_input

  // same model as previous

  CONVERGENCE
  SeMesh Scope = 21 21 1 Bound = -224.91 224.91 -224.91 224.91 -229 223
  AcceFsc Autofactor = 250


|

.. _section_burnup:

燃耗计算
==============

.. _section_burn_intro:

蒙卡燃耗计算概述
--------------------

蒙卡燃耗计算是蒙卡临界计算和点燃耗计算的相互耦合。传统的蒙卡燃耗程序（如MCBurn、
MCODE）一般采用第三方接口，通过外耦合的方式，循环调用蒙卡输运程序（如MCNP）和点
燃耗程序（如ORIGEN-2）。

在RMC程序当中，内嵌有自主开发的点燃耗计算模块DEPTH。DEPTH采用矩阵指数法，能够精
确、高效地处理含约1500种核素的精细燃耗链。RMC燃耗计算的基本流程是，首先通过临界
计算（连续能量）模块，得到中子通量、单群反应截面等数据，传递给点燃耗模块DEPTH；
DEPTH完成点燃耗计算，得到新的核素密度，传递给RMC临界计算模块。通过数据的往返传
递，从而完成燃耗计算的全过程。

与传统的蒙卡燃耗程序（如MCBurn，MCODE）相比，RMC燃耗计算功能的基本特点包括：

（1）含内耦合燃耗计算模块，能够处理含约1500种核素的精细燃耗链；整合了ORIGEN-S和
ORIGEN-2的最新点燃耗数据库。

（2）支持含重复结构的燃耗计算，无需用户为每个燃耗区指定不同的初始材料，大大减
少了用户输入。

（3）支持对大规模燃耗区的“并行临界+并行点燃耗”计算。在并行点燃耗计算模式中，燃耗
区被平均分配到各个进程，各自独立地完成点燃耗计算。

.. _section_burn_cards:

燃耗模块输入卡
------------------

燃耗模块的输入卡包括：

.. code-block:: none

    BURNUP
    BurnCell < cell_1 cell_2 cell_3 … >
    TimeStep <time_1 time_2 … time_n>
    BurnupStep <burnup_1 burnup_2 … burnup_n>
    Power <power_1 power_2 … power_n>
    PowerDen <powerden_1 powerden_2 … powerden_n>
    SubStep <sub_num>
    Inherent <fraction>
    AceLib <lib_type>
    Strategy <flag>
    Solver <flag>
    Parallel <flag>
    Xeequilibrium [Skip = <params>] [Batchsize = <params>] [Powermode = <params>] [Minratio = <params>]
    OutputCell <cell_vector>
    VaryMat <step = s1 mat = m1_1 m1_2 ... m1_n newmat = new1_1 new1_2 ... new1_n
             step = s2 mat = m2_1 m2_2 ... m2_n newmat = new2_1 new2_2 ... new2_n
             ...>
    VarySurf <step = s1 surf = s1_1 s1_2 ... s1_n newsurf = news1_1 news1_2 ... news1_n
             step = s2 surf = s2_1 s2_2 ... s2_n newsurf = news2_1 news2_2 ... news2_n
             ...>
    MERGE <level> <universe>
    SUCCESSION [Singlestep = <flag>] [ReadNuc = <flag>] [WriteNuc = <flag>] 
               [FMF = <param>] [CumulativeTime = <param>] [CumulativeBurnup = <param>]
               [CellCmltvBurnup = <flag>]
    NAECF <energy>
    IMPNUC < nuc_1 nuc_2 ... nuc_n>
    FIXEDNUC <nuc_num>


其中，

-  **BURNUP**\ 为燃耗计算模块的关键词。

-  **BurnCell**\ 输入卡指定可燃耗的栅元，
   \ *输入的参数为简单栅元编号cell_i（而非层级栅元的向量形式）*\ 。程序将自动
   搜索所有底层栅元为cell_i的栅元向量，将它们视为独立的燃耗区。即每个燃耗栅元
   将自动展开生成独立的填充材料，即使它们的初始材料相同。自动展开独立燃耗区的
   功能，对于含重复结构的燃耗计算十分重要，大大减少了用户的输入负担。

-  **TimeStep**\ 输入卡指定各个燃耗步的时间步长（天）。注意这里输入的是分步时间
   ，而非累积时间。

-  **BurnupStep**\ 输入卡指定各个燃耗步的燃耗深度（MWd/tU）。注意这里输入的是
   每个燃耗步的燃耗深度而非累积燃耗深度。注意燃耗深度步长选项与时间步长选项卡不能
   同时使用。

-  **Power**\ 输入卡指定各个燃耗步的总功率（MW）。注意Power选项卡不能与PowerDen
   选项卡同时使用。

-  **PowerDen**\ 输入卡指定各个燃耗步的总功率密度（W/gHM）。程序将根据初始重金属的
   总质量得到实际总功率，并在每个燃耗步当中根据各燃耗区的功率分布得到每个燃耗区的实际功
   率。为计算初始重金属总质量和功率分布，用户应为燃耗栅元指定正确的体积。

-  **SubStep**\ 输入卡指定点燃耗计算的步数（范围1 - 9999），缺省值为10步。对
   于一般用户，不推荐使用该输入卡修改默认参数。

-  **Inherent**\ 输入卡指定用于继承重要核素的吸收份额和质量份额，缺省值分别为
   0.9999和0.999。点燃耗计算需要处理约1500种核素，临界计算显然只能（也只需）
   继承其中的一部分重要核素。继承的方式是：首先，材料卡中输入的核素始终被继承；
   然后根据其余核素在总吸收率和总质量当中所占的份额，从高到低继承，直至继承核
   素的总份额达到用户指定的份额。若用户需要特别关注某些重要核素，建议将其写在
   材料卡中，保证这些核素始终被继承。继承的核素越多，计算结果越准确，但时间和内
   存消耗也越大。注意，若只输入了一个数字，则认为输入的是吸收份额。输入值应当处于
   0.9和1.0之间。

-  **AceLib**\ 输入卡指定继承的核素所采用的数据库，例如“AceLib = .30c”。对于在材
   料卡中输入的核素，继承其原来的数据库。为保证燃耗计算的精度，用户应当根据栅
   元温度指定与之匹配的ACE数据库，且该温度点的数据库应尽量包含完整的核素清单。
   在实际的计算中，只有当燃耗生成的新的核素在ACE数据库中有相应的数据，核素才会
   被添加到栅元材料中并进行下一步的输运计算，否则会被筛选掉。在含多个温度值的燃耗计算中，
   RMC能够根据栅元温度自动匹配数据库，但目前版本暂不提供该功能。

-  **Strategy**\ 输入卡指定燃耗步策略。\ **Strategy =
   0**\ （默认值）表示使用起点近似燃耗策略，\ **Strategy =
   1**\ 表示使用预估-修正燃耗步策略，\ **Strategy =
   2**\ 表示使用中点近似燃耗策略。通常只要设置合理的燃耗步长，起点燃耗策略能满足
   大多数燃耗计算需求。

-  **Solver**\ 输入卡指定点燃耗方程求解方法。\ **Solver =
   1**\ 表示线性子链法，\ **Solver =
   2**\ （默认值）表示切比雪夫有理近似法，\ **Solver =
   3**\ 表示样条有理近似法，\ **Solver =
   4**\ 表示拉盖尔多项式近似法。对于一般用户，建议使用缺省参数。

-  **Parallel**\ 输入卡指定在并行临界计算时是否使用并行燃耗计算，该选项仅对RMC并
   行版本生效。\ **Parallel = 0**\ （默认值）表示不使用并行燃耗计算，
   \ **Parallel = 1**\ 表示使用并行燃耗计算。在并行燃耗计算模式下，
   燃耗区被平均分配到各个进程，各自独立地完成点燃耗计算。对于大规模燃耗
   （含大量燃耗区）计算，使用并行燃耗计算能显著减少计算时间。

-  **Xeequilibrium**\ 为氙平衡输入卡的关键词。

   -  **Skip**\ 输入卡指定开始更新氙浓度的代数。

   -  **Batchsize**\ 输入卡指定更新氙浓度的代数周期\ *L*\，即每隔\ *L*\ 代更新一次氙浓度，
      默认值是1，目前程序内可以自动调节。

   -  **Powermode**\ 输入卡指定功率模式。\ **Powermode = 1**\ （默认值）表示是
      常功率，\ **Powermode = 2**\ 表示是变功率。

   -  **Minratio**\ 输入卡指定平衡氙计算中平衡氙相关计数器非0计数的最低比例,
      根据该比例自动调整平衡氙batchsize,默认值是0.96（0.96是根据经验设置的）。

-  **Outputcell**\ 卡用于输出指定栅元的核素密度，存于后缀名为“.den”的文件中。
   此外，程序还将默认输出总原子密度，存于后缀名为“.den_tot”的文件中。

-  **VaryMat**\ 卡用于在燃耗计算中替换指定燃耗步的材料。
   
   -  **step**\ 选项指定要替换材料的燃耗步编号，从0开始。

   -  **mat**\ 选项指定被替换的材料编号。用户可以输入多个材料编号。

   -  **newmat**\ 选项指定替换成的新材料的编号。用户可以输入多个材料编号，
      新材料的数量需要与\ **mat**\ 选项中输入的材料数量一致。
   
   用户可按照上述选项，输入多组数据，从而实现指定多个燃耗步需要替换的材料。例如，

   .. code-block:: c
      
       VaryMat step = 1 mat = 4 5 newmat = 21 31
               step = 2 mat = 4 5 newmat = 22 32
               step = 3 mat = 4 5 newmat = 23 33
               step = 4 mat = 4 5 newmat = 24 34

   表示在第一步（燃耗步从0开始）将4、5号材料分别替换成21、31号材料，
   在第二步将4、5号材料分别替换成22、32号材料，
   在第三步将4、5号材料分别替换成23、33号材料，
   在第四步将4、5号材料分别替换成23、33号材料。
   注意，被替换后，原有材料的信息将完全丢失。

-  **VarySurf**\ 卡用于在燃耗计算中在指定燃耗步计算之前替换面。
    如step=1, 程序会在第一次燃耗计算结束后变换面。需要注意的是，需要谨慎使用变表面功能，
    用户需要确认更换的新的面仍然在所在模型内，避免出现模型表面不闭合导致粒子缺失的情况。
   
   -  **step**\ 选项指定要替换面的燃耗步编号，从0开始。

   -  **surf**\ 选项指定被替换的面编号。用户可以输入多个面编号。

   -  **newsurf**\ 选项指定替换成的新面的编号。用户可以输入多个面编号，
      新面的数量需要与\ **surf**\ 选项中输入的面数量一致。同时，需要注意
      的是，新面和被替换的面的类型等参数需要保持一致。
   
   用户可按照上述选项，输入多组数据，从而实现指定多个燃耗步需要替换的面。例如，

   .. code-block:: c
      
       VarySurf step = 1 surf = 4 5 newsurf = 21 31
               step = 2 surf = 4 5 newsurf = 22 32
               step = 3 surf = 4 5 newsurf = 23 33
               step = 4 surf = 4 5 newsurf = 24 34

   表示在第一步（燃耗步从0开始）将4、5号面分别替换成21、31号面，
   在第二步将4、5号面分别替换成22、32号面，
   在第三步将4、5号面分别替换成23、33号面，
   在第四步将4、5号面分别替换成23、33号面。
   注意，被替换后，原有面的信息将完全丢失。

-  **MERGE**\ 卡用于指定进行燃耗区合并的空间<universe>的几何层级<level>，
   以及指定进行燃耗区合并的空间号<universe>。
   注意：“Universe 0” 空间对应的几何层级level = 0，以此类推。燃耗区合并功能可以
   针对普通压水堆和随机介质模型。MERGE功能只能合并同一层级的多个Universe。

-  **SUCCESSION**\ 此关键词下的所有选项全部为控制燃耗接续计算的高级选项，由RMC程序自动生成，
   或由脚本自动处理，不建议用户手动输入。

   - **Singlestep**\ 表示是否仅完成一次\ **临界+燃耗**\ 计算。该选项用于燃耗
     接续计算中，开启后，即便用户输入了多个燃耗步，RMC也仅完成第0步的临界和点燃耗计算。

   - **ReadNuc**\ 用于读取上个燃耗步计算所生成的点燃耗计算的核素密度。
     0表示不读取（默认值），1表示读取。在当前版本中，只有上个燃耗步的点燃耗计算向
     **.State.h5**\ 文件输出了点燃耗计算的核素密度后（通过\ **Print**\ 
     中\ **inpfile**\ 开启）即上一步开启了**WriteNuc**功能，当前燃耗步才可以
     读取相关信息。

   - **WriteNuc**\ 用于输出当前燃耗步计算所生成的的核素（燃耗数据库中所有的核素）密度
     到.State.h5文件中。0表示不输出（默认值），1表示输出。该功能仅在用户需要使用燃耗接
     续计算功能，同时需要读取所有燃耗核素时建议开启。需要注意的是，目前的点燃耗核素接续功
     能与换料计算不兼容。

   - **FMF**\ 通量（功率）倍增因子，等于实际功率/蒙卡统计释热。用于开启氙平衡模型时的燃耗接续计算，
     该值由RMC程序在生成接续计算输入卡时计算得到。

   - **CUMULATIVETIME**\ 用于开启氙平衡模型时的燃耗接续计算，表示当前燃耗步之前已经燃耗的总时间。
     该值由RMC程序在生成接续计算输入卡时计算得到。

   - **CUMULATIVEBURNUP**\ 用于单步燃耗接续计算，表示当前燃耗步之前已经燃耗的燃耗深度。
     该值由RMC程序在生成接续计算输入卡时计算得到。

   - **CELLCMLTVBURNUP**\ 用于单步燃耗接续计算，控制读取inp.State.h5文件中前一个燃耗步输出的
     栅元燃耗信息。0（默认值）表示不读取，1（表示读取）。在单循环接续计算中，该功能由程序自动控制。
     需要注意的是，栅元燃耗深度接续与换料计算存在兼容性问题，用户在换料计算中，需要手动将接续文件中的
     该选项卡置0。

-  **NAECF**\ 卡用于指定所有燃耗栅元的中子平均能量。0(默认值)表示所有燃耗栅元的中子平均能量采用
   临界计算tally的结果。-1表示所有燃耗栅元中子平均能量强制为0.0253eV，-2表示所有燃耗栅元中子平均
   能量强制为2MeV,-3表示所有燃耗栅元中子平均能量为14MeV。如果用户输入的值大于0,表示所有燃耗栅元的
   中子平均能量为用户指定的输入。注：中子平均能量主要用于调整裂变产物产额。

-  **IMPNUC**\ 卡用于在点燃耗计算和临界计算耦合过程中对于燃耗计算的核素进行筛选，核素ID为燃耗计算
   中的核素ID，如922350。位于该卡中的所有核素将被强制筛选至临界计算的材料中去。

-  **FIXEDNUC**\ 卡用于在点燃耗计算和临界计算耦合过程中控制被筛选进入临界计算的栅元核素的数目。在
   筛选过程中，程序会根据吸收反应率或核素密度（参考**Inherent**卡）对核素进行筛选，该卡会在达到
   指定数量后，抛弃剩下的核素，用于提高临界计算的速度。

RMC燃耗计算时间项支持燃耗深度步长、时间步长输入，功率项支持总功率、功率密度输入各两种方式，
时间项和功率项可以互相配合使用（但燃耗深度和时间步长，总功率和功率密度不能同时使用）。从
实际的应用上来说，燃耗深度+总功率的输入方式更适用于反应堆全堆多循环计算。

需要指出的是，对于燃耗计算，蒙卡临界计算过程中统计大量的反应率，耗时较长；对于
大规模燃耗计算（燃耗区多达上千甚至上万），点燃耗计算本身的耗时也很长。因此，
推荐用户采用并行版本RMC计算燃耗问题，并在必要时开启并行燃耗模式
（\ **Parallel = 1**\ ）。

理论上，RMC燃耗计算支持任意数量的燃耗区，但实际上受限于计算机硬件。实测表明，
含10000个燃耗区的燃耗计算大约需要耗费1.5G内存，在此基础上每增加10000个燃耗区约
增加1G内存。

.. _section_burn_example:

燃耗模块输入示例
--------------------

PWR栅元燃耗算例
~~~~~~~~~~~~~~~~~~~~~

PWR栅元燃耗算例只包含一个燃耗区，即栅元3，温度为293.6K。燃耗历史总计包括72个燃
耗步，每个燃耗步的功率密度为30W/gHM，燃耗步长分别
为“3.333333 13.333333 16.666667 33.333333\*69”天，对应的累积燃耗深度
为“0.1 0.5 1.0 2.0 … 70.0”MWD/KgHM。

|

.. code-block:: c
  :caption: PWR栅元燃耗输入
  :name: pwrpin_burn_input

  ////// Burnup calculation of PWR pin. SHE Ding 2012-07-01 //////
  UNIVERSE 0
  cell 3 -1 mat = 1 vol = 1.0        // Fuel
  cell 4 1 & -2 mat = 3              // Air
  cell 5 2 & -3 mat = 4              // Zr
  cell 6 3 & 4 & -5 & 6 & -7 mat = 5 // water

  SURFACE
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 4 px -0.63 bc = 1
  surf 5 px 0.63  bc = 1
  surf 6 py -0.63 bc = 1
  surf 7 py 0.63  bc = 1

  MATERIAL
  mat 1 -10.196
      92235.30c 6.9100E-03
      92238.30c 2.2062E-01
      8016.30c 4.5510E-01
      34079.30c 1.0E-25 36083.30c 1.0E-25 36085.30c 1.0E-25
      38089.30c 1.0E-25 38090.30c 1.0E-25 39091.30c 1.0E-25
      40093.30c 1.0E-25 40094.30c 1.0E-25 40095.30c 1.0E-25
      40096.30c 1.0E-25 42095.30c 1.0E-25 42098.30c 1.0E-25
      42099.30c 1.0E-25 42100.30c 1.0E-25 43099.30c 1.0E-25
      44101.30c 1.0E-25 44102.30c 1.0E-25 44103.30c 1.0E-25
      44105.30c 1.0E-25 44106.30c 1.0E-25 45103.30c 1.0E-25
      45105.30c 1.0E-25 47109.30c 1.0E-25 47510.30c 1.0E-25
      47111.30c 1.0E-25 50126.30c 1.0E-25 51125.30c 1.0E-25
      51126.30c 1.0E-25 52527.30c 1.0E-25 52529.30c 1.0E-25
      53127.30c 1.0E-25 53129.30c 1.0E-25 53131.30c 1.0E-25
      53135.30c 1.0E-25 54131.30c 1.0E-25 54133.30c 1.0E-25
      54134.30c 1.0E-25 54135.30c 1.0E-25 54136.30c 1.0E-25
      55133.30c 1.0E-25 55134.30c 1.0E-25 55135.30c 1.0E-25
      55136.30c 1.0E-25 55137.30c 1.0E-25 56138.30c 1.0E-25
      56140.30c 1.0E-25 57139.30c 1.0E-25 57140.30c 1.0E-25
      58141.30c 1.0E-25 58142.30c 1.0E-25 58143.30c 1.0E-25
      58144.30c 1.0E-25 59143.30c 1.0E-25 60143.30c 1.0E-25
      60144.30c 1.0E-25 60145.30c 1.0E-25 60147.30c 1.0E-25
      60148.30c 1.0E-25 61147.30c 1.0E-25 61148.30c 1.0E-25
      61548.30c 1.0E-25 61149.30c 1.0E-25 62147.30c 1.0E-25
      62148.30c 1.0E-25 62149.30c 1.0E-25 62150.30c 1.0E-25
      62151.30c 1.0E-25 62152.30c 1.0E-25 63153.30c 1.0E-25
      63154.30c 1.0E-25 63155.30c 1.0E-25 63156.30c 1.0E-25
      64155.30c 1.0E-25 64157.30c 1.0E-25 92234.30c 1.0E-25
      92236.30c 1.0E-25 92237.30c 1.0E-25 92239.30c 1.0E-25
      92240.30c 1.0E-25 93236.30c 1.0E-25 93237.30c 1.0E-25
      93238.30c 1.0E-25 93239.30c 1.0E-25 94238.30c 1.0E-25
      94239.30c 1.0E-25 94240.30c 1.0E-25 94241.30c 1.0E-25
      94242.30c 1.0E-25 94243.30c 1.0E-25 94244.30c 1.0E-25
      95241.30c 1.0E-25 95242.30c 1.0E-25 95642.30c 1.0E-25
      95243.30c 1.0E-25 95244.30c 1.0E-25 96242.30c 1.0E-25
      96243.30c 1.0E-25 96244.30c 1.0E-25 96245.30c 1.0E-25
      96246.30c 1.0E-25 96247.30c 1.0E-25 96248.30c 1.0E-25
      96249.30c 1.0E-25 97249.30c 1.0E-25 97250.30c 1.0E-25
      98249.30c 1.0E-25 98250.30c 1.0E-25 98251.30c 1.0E-25
  mat 3 -0.001
      8016.30c 3.76622E-5
  mat 4 -6.550
      40000.60c -98.2
      50000.42c -1.5
      26000.55c -0.12
      24000.50c -0.1
      28000.50c -0.05
      8016.30c -0.13
  mat 5 9.9977E-02
      1001.30c 6.6643E-02
      8016.30c 3.3334E-02
  sab 5 lwtr.60t

  CRITICALITY
  PowerIter population = 5000 30 230 // keff0 = 1.0
  InitSrc point = 0 0 0

  BURNUP
  BurnCell 3
  TimeStep 3.333333 13.333333 16.666667 33.333333*69
  PowerDen 30*72
  Substep 10
  Inherent 0.9999
  AceLib .30c
  outputcell 3



PWR组件燃耗算例
~~~~~~~~~~~~~~~~~~~~~

:numref:`pwrassem_burn_input` 是PWR17×17组件燃耗算例，包含264个燃耗区，
采用并行燃耗计算模式（在并行调用
情况下生效）。输出四个角点位置的燃料栅元内的核素密度。该算例需要的计算量较大，推
荐使用并行机完成计算。

|

.. code-block:: c
  :caption: PWR组件燃耗输入
  :name: pwrassem_burn_input

  ////// Burnup calculation of PWR 17\*17 assembly. SHE Ding 2012-07-01 //////
  UNIVERSE 0
  CELL 1 6 & -7 & 8 & -9 mat = 0 Fill = 8 // Assembly inside
  CELL 2 -6 : 7 : -8 : 9 mat = 0 void = 1 // Assembly outside

  UNIVERSE 8 lat = 1 pitch = 1.26 1.26 1 scope = 17 17 1 fill =
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 1 1 5 1 1 5 1 1 5 1 1 1 1 1
             1 1 1 5 1 1 1 1 1 1 1 1 1 5 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 5 1 1 5 1 1 5 1 1 5 1 1 5 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 5 1 1 5 1 1 5 1 1 5 1 1 5 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 5 1 1 5 1 1 5 1 1 5 1 1 5 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 5 1 1 1 1 1 1 1 1 1 5 1 1 1
             1 1 1 1 1 5 1 1 5 1 1 5 1 1 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
             1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

  UNIVERSE 1 move = 0.63 0.63 0 // Fuel rod
  cell 3 -1 mat = 1 inner = 1 tmp = 300 // Fuel
  cell 4 1 & -2 mat = 3 inner = 1 // Air
  cell 5 2 & -3 mat = 4 inner = 1 // Zr
  cell 6 3 mat = 5 // water

  UNIVERSE 5 move = 0.63 0.63 0 // Guide tube
  cell 7 -4 mat = 5 inner = 1 // water
  cell 8 4 & -5 mat = 4 inner = 1 // Air
  cell 9 5 mat = 5 // water

  SURFACE
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 4 cz 0.5690
  surf 5 cz 0.6147
  surf 6 px 0 bc = 1
  surf 7 px 21.42 bc = 1
  surf 8 py 0 bc = 1
  surf 9 py 21.42 bc = 1

  MATERIAL
  mat 1 -10.196
      92235.30c 6.9100E-03
      92238.30c 2.2062E-01
      8016.30c 4.5510E-01
      34079.30c 1.0E-25 36083.30c 1.0E-25 36085.30c 1.0E-25
      38089.30c 1.0E-25 38090.30c 1.0E-25 39091.30c 1.0E-25
      40093.30c 1.0E-25 40094.30c 1.0E-25 40095.30c 1.0E-25
      40096.30c 1.0E-25 42095.30c 1.0E-25 42098.30c 1.0E-25
      42099.30c 1.0E-25 42100.30c 1.0E-25 43099.30c 1.0E-25
      44101.30c 1.0E-25 44102.30c 1.0E-25 44103.30c 1.0E-25
      44105.30c 1.0E-25 44106.30c 1.0E-25 45103.30c 1.0E-25
      45105.30c 1.0E-25 47109.30c 1.0E-25 47510.30c 1.0E-25
      47111.30c 1.0E-25 50126.30c 1.0E-25 51125.30c 1.0E-25
      51126.30c 1.0E-25 52527.30c 1.0E-25 52529.30c 1.0E-25
      53127.30c 1.0E-25 53129.30c 1.0E-25 53131.30c 1.0E-25
      53135.30c 1.0E-25 54131.30c 1.0E-25 54133.30c 1.0E-25
      54134.30c 1.0E-25 54135.30c 1.0E-25 54136.30c 1.0E-25
      55133.30c 1.0E-25 55134.30c 1.0E-25 55135.30c 1.0E-25
      55136.30c 1.0E-25 55137.30c 1.0E-25 56138.30c 1.0E-25
      56140.30c 1.0E-25 57139.30c 1.0E-25 57140.30c 1.0E-25
      58141.30c 1.0E-25 58142.30c 1.0E-25 58143.30c 1.0E-25
      58144.30c 1.0E-25 59143.30c 1.0E-25 60143.30c 1.0E-25
      60144.30c 1.0E-25 60145.30c 1.0E-25 60147.30c 1.0E-25
      60148.30c 1.0E-25 61147.30c 1.0E-25 61148.30c 1.0E-25
      61548.30c 1.0E-25 61149.30c 1.0E-25 62147.30c 1.0E-25
      62148.30c 1.0E-25 62149.30c 1.0E-25 62150.30c 1.0E-25
      62151.30c 1.0E-25 62152.30c 1.0E-25 63153.30c 1.0E-25
      63154.30c 1.0E-25 63155.30c 1.0E-25 63156.30c 1.0E-25
      64155.30c 1.0E-25 64157.30c 1.0E-25 92234.30c 1.0E-25
      92236.30c 1.0E-25 92237.30c 1.0E-25 92239.30c 1.0E-25
      92240.30c 1.0E-25 93236.30c 1.0E-25 93237.30c 1.0E-25
      93238.30c 1.0E-25 93239.30c 1.0E-25 94238.30c 1.0E-25
      94239.30c 1.0E-25 94240.30c 1.0E-25 94241.30c 1.0E-25
      94242.30c 1.0E-25 94243.30c 1.0E-25 94244.30c 1.0E-25
      95241.30c 1.0E-25 95242.30c 1.0E-25 95642.30c 1.0E-25
      95243.30c 1.0E-25 95244.30c 1.0E-25 96242.30c 1.0E-25
      96243.30c 1.0E-25 96244.30c 1.0E-25 96245.30c 1.0E-25
      96246.30c 1.0E-25 96247.30c 1.0E-25 96248.30c 1.0E-25
      96249.30c 1.0E-25 97249.30c 1.0E-25 97250.30c 1.0E-25
      98249.30c 1.0E-25 98250.30c 1.0E-25 98251.30c 1.0E-25
  mat 3 -0.001
      8016.30c 3.76622E-5
  mat 4 -6.550
      40000.60c -98.2
  mat 5 9.9977E-02
      1001.30c 6.6643E-02
      8016.30c 3.3334E-02
  sab 5 lwtr.60t

  CRITICALITY
  PowerIter population = 2000 50 300 // keff0 = 1.0
  InitSrc point = 0.63 0.63 0

  BURNUP
  BurnCell 3
  TimeStep 3.333333 13.333333 16.666667 33.333333*69
  PowerDen 30*72
  Substep 10
  Inherent 0.9999
  AceLib .30c
  Strategy 0
  Parallel 1
  Solver 2
  outputcell 1 > 1 > 3
             1 > 17 > 3
             1 > 273 > 3
             1 > 289 > 3

  PRINT
  mat 0
  csTally 0



PWR堆芯燃耗算例
~~~~~~~~~~~~~~~~~~~~~

.. figure:: media/burnup_core.png
   :name: burnup_core_fig

   PWR堆芯布置图

压水堆二维堆芯包括193个燃料组件，组件外围为水反射层，堆芯半径（含反射层）为187.6
cm。燃料组件为17×17结构，含264根燃料棒和25个水通道。根据UO\ :sub:`2`\ 燃料富集度
的不同，燃料组件分为3.1%、2.6%和2.1%三种不同类型。堆芯内的燃料组件按照
对称方式布置，如 :numref:`burnup_core_fig` 所示。燃耗历史总计包括41个燃耗步，
每个燃耗步的功率密度
为30W/gHM，累积燃耗深度为20 MWD/KgHM。

|

.. code-block:: c
  :caption: PWR堆芯燃耗输入
  :name: pwr_core_burn_input

  /////// PWR core burnup calculation SHE Ding 2013-07-01 /////////////
  Universe 0
  cell 1 -9 fill = 11 //core inside
  cell 2 9 mat=0 void = 1 //core outside

  UNIVERSE 11 move= -224.91 -224.91 0 lat=1 pitch=21.42 21.42 1 scope=21 21 1 fill=
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 1 1 1 1 1 1 1 8 8 8 8 8 8 8
      8 8 8 8 8 1 1 1 3 1 3 1 3 1 1 1 8 8 8 8 8
      8 8 8 8 1 1 2 3 2 3 2 3 2 3 2 1 1 8 8 8 8
      8 8 8 8 1 2 2 2 3 2 3 2 3 2 2 2 1 8 8 8 8
      8 8 8 1 1 3 2 3 2 3 2 3 2 3 2 3 1 1 8 8 8
      8 8 8 1 3 2 3 2 3 2 3 2 3 2 3 2 3 1 8 8 8
      8 8 8 1 1 3 2 3 2 3 2 3 2 3 2 3 1 1 8 8 8
      8 8 8 1 3 2 3 2 3 2 3 2 3 2 3 2 3 1 8 8 8
      8 8 8 1 1 3 2 3 2 3 2 3 2 3 2 3 1 1 8 8 8
      8 8 8 1 3 2 3 2 3 2 3 2 3 2 3 2 3 1 8 8 8
      8 8 8 1 1 3 2 3 2 3 2 3 2 3 2 3 1 1 8 8 8
      8 8 8 8 1 2 2 2 3 2 3 2 3 2 2 2 1 8 8 8 8
      8 8 8 8 1 1 2 3 2 3 2 3 2 3 2 1 1 8 8 8 8
      8 8 8 8 8 1 1 1 3 1 3 1 3 1 1 1 8 8 8 8 8
      8 8 8 8 8 8 8 1 1 1 1 1 1 1 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8
      8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8 8

  UNIVERSE 1 lat=1 pitch=1.26 1.26 1 scope=17 17 1 fill=
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 10 10 40 10 10 40 10 10 40 10 10 10 10 10
      10 10 10 40 10 10 10 10 10 10 10 10 10 40 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 40 10 10 40 10 10 40 10 10 40 10 10 40 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 40 10 10 40 10 10 40 10 10 40 10 10 40 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 40 10 10 40 10 10 40 10 10 40 10 10 40 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 40 10 10 10 10 10 10 10 10 10 40 10 10 10
      10 10 10 10 10 40 10 10 40 10 10 40 10 10 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10
      10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10 10

  UNIVERSE 2 lat=1 pitch=1.26 1.26 1 scope=17 17 1 fill=
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 20 20 40 20 20 40 20 20 40 20 20 20 20 20
      20 20 20 40 20 20 20 20 20 20 20 20 20 40 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 40 20 20 40 20 20 40 20 20 40 20 20 40 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 40 20 20 40 20 20 40 20 20 40 20 20 40 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 40 20 20 40 20 20 40 20 20 40 20 20 40 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 40 20 20 20 20 20 20 20 20 20 40 20 20 20
      20 20 20 20 20 40 20 20 40 20 20 40 20 20 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20
      20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20 20

  UNIVERSE 3 lat=1 pitch=1.26 1.26 1 scope=17 17 1 fill=
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 30 30 40 30 30 40 30 30 40 30 30 30 30 30
      30 30 30 40 30 30 30 30 30 30 30 30 30 40 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 40 30 30 40 30 30 40 30 30 40 30 30 40 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 40 30 30 40 30 30 40 30 30 40 30 30 40 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 40 30 30 40 30 30 40 30 30 40 30 30 40 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 40 30 30 30 30 30 30 30 30 30 40 30 30 30
      30 30 30 30 30 40 30 30 40 30 30 40 30 30 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30
      30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30 30

  UNIVERSE 8
  cell 3 -6 mat = 5 tmp = 300
  cell 4 6 mat = 5 tmp = 300

  UNIVERSE 10 move = 0.63 0.63 0          // 3.1% Fuel rod
  cell 13 -1 mat = 10 inner = 1 tmp = 300 // Fuel
  cell 14 1 & -2 mat = 3 inner = 1        // Air
  cell 15 2 & -3 mat = 4 inner = 1        // Zr
  cell 16 3 mat = 5 tmp = 300             // water

  UNIVERSE 20 move = 0.63 0.63 0          // 2.6% Fuel rod
  cell 23 -1 mat = 20 inner = 1 tmp = 300 // Fuel
  cell 24 1 & -2 mat = 3 inner = 1        // Air
  cell 25 2 & -3 mat = 4 inner = 1        // Zr
  cell 26 3 mat = 5 tmp = 300             // water

  UNIVERSE 30 move = 0.63 0.63 0          // 2.1% Fuel rod
  cell 33 -1 mat = 30 inner = 1 tmp = 300 // Fuel
  cell 34 1 & -2 mat = 3 inner = 1        // Air
  cell 35 2 & -3 mat = 4 inner = 1        // Zr
  cell 36 3 mat = 5 tmp = 300             // water

  UNIVERSE 40 move = 0.63 0.63 0          // Guide tube
  cell 7 -4 mat = 5 inner = 1 tmp = 300   // water
  cell 8 4 & -5 mat = 4 inner = 1         // Air
  cell 9 5 mat = 5 tmp = 300              // water

  Surface
  surf 1 cz 0.4096
  surf 2 cz 0.4178
  surf 3 cz 0.4750
  surf 4 cz 0.5690
  surf 5 cz 0.6147
  surf 6 cz 900
  surf 9 cz 187.6 bc = 1

  Material
  mat 10 -10.2                            // 3.1%
      92235.30c 7.1421E-04
      92238.30c 2.2044E-02
      8016.30c 4.5515E-02
      54134.30c 1.0E-25
      54135.30c 1.0E-25
      54136.30c 1.0E-25
  mat 20 -10.2                            // 2.6%
      92235.30c 5.9902E-04
      92238.30c 2.2157E-02
      8016.30c 4.5513E-02
      54134.30c 1.0E-25
      54135.30c 1.0E-25
      54136.30c 1.0E-25
  mat 30 -10.2                            // 2.1 %
      92235.30c 4.8383E-04
      92238.30c 2.2271E-02
      8016.30c 4.5510E-02
      54134.30c 1.0E-25
      54135.30c 1.0E-25
      54136.30c 1.0E-25
  mat 3 -0.001
      8016.30c 3.76622E-5
  mat 4 -6.550
      40000.60c -98.2
  mat 5 -1.0034
      1001.30c 6.66E-02
      8016.30c 3.33E-02
  sab 5 lwtr.60t

  Criticality
  poweriter keff0=1.0 population = 500000 200 500 batch = 10
  initsrc cyl/z = 0 0 166 -1 1

  BURNUP
  BurnCell 13 23 33
  TimeStep 3.333333 13.333333 16.666667*39
  PowerDen 30 *41
  Substep 2
  Inherent 0.999 0.999
  AceLib .30c
  Strategy 1
  Parallel 1
  Solver 2

  PRINT
  cstally 0
  mat 0


|


随机介质栅元燃耗算例
~~~~~~~~~~~~~~~~~~~~~~~~~~~

随机介质栅元燃耗算例是在 :numref:`explicit_model` 的基础上进一步计算燃耗。
需要添加的燃耗部分输入卡如下：



.. code-block:: c
  :caption: 随机介质栅元燃耗算例
  :name: implicit_model

    ///////////// Array15 Implicit Model PF=0.32 /////////////
    BURNUP
    BurnCell    60
    TimeStep    1 4 5 10*4 30*5 50*4 150*6
    PowerDen       31.9713*22
    Substep     10
    Inherent    0.9999
    AceLib      .30c
    Strategy    0
    Parallel    1
    Solver      2
    MERGE       2 5


|

.. _section_pointburnup:

点燃耗计算
==============

.. _section_pointburnup_intro:

点燃耗计算概述
-----------------------

RMC的点燃耗模块是基于自主开发的适用于复杂燃耗系统的模块化程序DEPTH。DEPTH程序
在数据库、算法和功能方面具有以下特点：

（1）数据库方面，有机整合了ORIGEN-2和ORIGEN-S的燃耗数据库，具有较为全面的燃耗
链信息。

（2）算法方面，DEPTH包含线性子链方法（TTA）、切比雪夫有理逼近方法（CRAM）
、求积组有理逼近法（QRAM）和拉盖尔多项式逼近法（LPAM）四种求解器。同时在程序实现
上，充分利用燃耗矩阵的稀疏性，采用基于行列混合压缩存储稀疏矩阵的高斯消去法，大大优
化了燃耗求解速度。

（3）功能方面，支持衰变、定通量和定功率三种燃耗模式，可计算核密度、衰变热、放射性
活度、反应率等物理量。同时，还支持计算某物理量的瞬时值和在燃耗步长内对时间的积分值。

.. _section_pointburnup_cards:

点燃耗模块输入卡
------------------

点燃耗模块的输入卡包括

.. code-block:: none

   Depletion
   Convertlib <lib_type> <xs_data> <yield_data> <main_lib>
   Decay <time>
   Flux <flux> <time>
   Power <power> <time>
   Density <nuc_id> <nuc_den>
   Solver <solver_type>
   TTA <cutofffrac>
   QRAM <qrad_n>
   LPAM <Laguerre_a> <Laguerre_tao> <Laguerre_N>
   Print <flag>
   Radioactivity <flag>
   AbsorpRate <flag>
   FissionRate <flag>
   DecayHeat <flag>
   FluxPower <power_flag> <flux_flag>
   Energy <neu_erg>

   

其中，

-  **Depletion**\ 为点燃耗计算模块关键词。

-  **Convertlib**\ 为数据库转换选项。 \ **Convertlib = 1**\ 表示\ **ORIGI
   N-S**\ 数据库，\ **Convertlib = 1**\ 表示\ **ORIGIN-2**\ 数据库，后续
   分别为\ **ORIGIN**\ 数据库的衰变数据库、产额数据库以及\ **RMC**\ 使用燃耗数
   据库名称。鉴于RMC点燃耗功能使用自主的DepthMainLib燃耗数据库，无特殊需求，默认
   不使用。

-  **Decay/Flux/Power**\ 为点燃耗计算的模式，分别为衰变、定通量、定功率模式。

   - **Decay**\ 表示进行衰变计算，默认0功率计算，因此不需要输入功率或通量。直接输入
     衰变时间即可。

   - **Flux**\ 表示进行定通量计算，用户需要先输入目标中子通量，后跟点燃耗计算的时间。
     如，1e+24 10d * 10
   
   - **Power**\ 表示进行定功率计算，用户需要先输入目标功率(单位W)，后跟点燃耗计算的时间。
     如，1000000 10d * 10
   
   需要注意的是，用户可以指定输入的点燃耗时间的单位，分别为 \ **y, d, h, m, 
   s**\ 分别代表年、日、时、分、秒。时间输入示例: \ **4y*10**\ 。意味着分10个时
   间步，每个时间步4年进行计算。注：不支持使用不同的时间单位，如\ **1y2d3h**\ ,
   同时也不支持不同时间步的输入， 如\ **1y*10 5d*5**\ 。同时，点燃耗目前不支持变
   功率或变通量的点燃耗计算。

-  **Density**\ 为所需计算的核素的信息，包括核素ID以及核素的密度。其中\ **nuc_den >
   0**\ 表示原子密度，单位为10\ :sup:`24`\ 原子/cm\ :sup:`3`\ ；\ **nuc_den
   < 0**\ 表示质量密度，单位为g/cm\ :sup:`3`\ 。注：核素ID请使用燃耗数据库中的
   ID格式，如\ **10010 922350 922351**\ 其中最后一位表示是否是激发态。

-  **Solver**\ 为燃耗方程求解方法， **Solver =
   1**\ 表示线性子链法，\ **Solver =
   2**\ （默认值）表示切比雪夫有理近似法，\ **Solver =
   3**\ 表示求积组有理近似法，\ **Solver =
   4**\ 表示拉盖尔多项式近似法。对于一般用户，建议使用缺省参数。

   -  **TTA**\ 仅当\ **Solver = 1**\ 时使用，表示\ **TTA**\ 方法的阶段误差。

   -  **QRAM**\ 仅当\ **Solver = 3**\ 时使用，为\ **QRAM**\ 方法的逼近阶数。

   -  **LPAM**\ 仅当\ **Solver = 4**\ 时使用，为\ **LPAM**\ 方法的初始参数。

-  **Print**\ 为点燃耗输出选项。 \ **Print = 0**\ 输出最后燃耗步的物理量值，
   \ **Print = 1**\ 输出所有燃耗步的物理量的值。

   -  **Radioactivity**\ 放射性活度，单位\ **Curi**\ ，\ **Radioactivity = 
      0**\ （默认值）为不输出放射性活度，\ **Radioactivity = 1**\ 表示输出瞬态浓度，
      \ **Radioactivity = 2**\ 表示输出燃耗步内的积分浓度。

   -  **AbsorpRate**\ 中子吸收率，单位\ **n/s**\ ，\ **AbsorpRate = 
      0**\ （默认值）为不输出中子吸收率，\ **AbsorpRate = 1**\ 表示输出瞬态浓度，
      \ **AbsorpRate = 2**\ 表示输出燃耗步内的积分浓度。

   -  **FissionRate**\ 裂变率，单位\ **fission/s**\ ，\ **FissionRate = 
      0**\ （默认值）为不输出裂变率，\ **FissionRate = 1**\ 表示输出瞬态浓度，
      \ **FissionRate = 2**\ 表示输出燃耗步内的积分浓度。

   -  **DecayHeat**\ 衰变热，单位\ **Watt**\ ，\ **DecayHeat = 0**\ （默认值）
      为不输出衰变热，\ **DecayHeat = 1**\ 表示输出瞬态浓度， \ **DecayHeat 
      = 2**\ 表示输出燃耗步内的积分浓度。

   注：瞬态浓度表示点燃耗计算结束时刻的浓度，积分浓度是对燃耗步长时间积分的浓度。

-  **FluxPower**\ 表示是否使用通量、功率的平均值，\ **flux/power_flag = 0**\ 
   （默认值）表示使用瞬时值，\ **flux/power_flag = 1**\ 表示使用平均值。

-  **Energy**\ 表示中子能量。单位 \ **eV**\ 。 


需要指出的是，在计算模式、求解器参数、输出选项等在使用时视需要而定，不需要可以不写。

.. _section_pointburnup_example:

点燃耗模块输入示例
--------------------

镎\ **Np**\ 点燃耗算例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

镎\ **Np**\ 点燃耗算例中为衰变模式，燃耗时长为10\ :sup:`6`\ 年，初始核素密度为
1*10\ :sup:`24`\ 原子/cm\ :sup:`3`\ ，使用\ **CRAM**\ 方法进行求解。

｜

.. code-block:: c
  :caption: 镎\ **Np**\ 点燃耗输入
  :name: Np_pointburnup_input

  /// Np point burnup input file  ////
  Depletion
  Decay        100000y * 10
  Density   932370  1         
  SOLVER 2              
  print  0                
  Radioactivity   1        
  AbsorpRate      1        
  FissionRate     1       
  DecayHeat       1    


|

.. _section_output:

输出控制
==============

RMC输出控制模块用来自定义输出内容。尤其是在大规模燃耗计算中，可能产生大量的输出
信息，通过输出控制模块可以有效地减小输出文件的体积。

9.1 输出控制模块输入卡

输出控制模块输入卡
----------------------

输出控制模块的输入方式为：

.. code-block:: none

  PRINT
  Mat <flag>
  Keff <flag>
  Source <flag>
  CellTally <flag>
  MeshTally <flag>
  CsTally <flag>
  Inpfile <flag>



其中，

-  **PRINT**\ 输出控制模块的关键词。

-  **Mat**\ 、\ **Keff**\ 等输入卡指定是否输出相关内容（见
   :numref:`outputcontrol_table` ）。\ **flag = 0**\
   表示不输出指定内容，\ **flag = 1**\ 表示输出指定内容。

.. table:: 输出控制模块的输入卡
  :name: outputcontrol_table

  +-----------------+-----------------------------------+--------------------+
  | 输入卡          | 输出内容                          | 默认选项           |
  +=================+===================================+====================+
  | **Mat**         | 所有材料的核素密度列表            | flag = 1，输出     |
  +-----------------+-----------------------------------+--------------------+
  | **Keff**        | 每代的Keff                        | flag = 1，输出     |
  +-----------------+-----------------------------------+--------------------+
  | **Source**      | 每代的裂变源信息                  | flag = 0，不输出   |
  +-----------------+-----------------------------------+--------------------+
  | **CellTally**   | 栅元计数器的结果                  | flag = 1，输出     |
  +-----------------+-----------------------------------+--------------------+
  | **MeshTally**   | 网格计数器的结果                  | flag = 1，输出     |
  +-----------------+-----------------------------------+--------------------+
  | **CsTally**     | 截面计数器的结果，包括燃耗        | flag = 1，输出     |
  |                 | 计算过程中的单群截面统计结果。    |                    |
  +-----------------+-----------------------------------+--------------------+
  | **Inpfile**     | 接续文件输入卡                    | flag = 0，不输出   |
  +-----------------+-----------------------------------+--------------------+

.. _section_output_example:

输出控制模块输入示例
------------------------

对于含大量燃耗区的燃耗计算，建议通过以下输入卡屏蔽材料和单群截面的输出信息，以免
产生庞大的数据文件。

.. code-block:: c

  PRINT
  Mat 0
  CsTally 0


|

.. _section_plot:

画图
===========

RMC支持模型的二维及三维可视化显示——画图功能。二维画图指显示模型某一个切面的几何
/材料信息，程序根据用户指定的矩形位置/范围和图像尺寸，生成显示几何/材料信息的图
像（png格式，可由常用图像软件可以查看）。三维画图指显示指定长方体范围内的模型信
息（vti格式文件，可由VTK、ParaView、VisIt等三维可视化软件查看）。

两种画图模式均采用像素格式，将画图区域划分为均匀像素网格，每个网格的颜色由所在几
何位置的材料/栅元涂色。用户指定图像的像素尺寸，如二维图像包括长度和高度两个方向
的像素值，三维图像包括长、宽和高三个方向的像素值。像素尺寸越大，图像越精细，但图
像文件也越大。

对画图区域的指定采用顶点法，即由顶点确定画图范围。对于二维画图，指定左上角（P1）
、右上角（P2）及右下角（P3）顶点来确定矩形画图范围（\ **若图像垂直于坐标轴，可只
输入P1和P3两个顶点**\ ），如 :numref:`plot_2d_fig` 所示；而对于三维画图，由4个顶点确定
长方体画图范围，如 :numref:`plot_3d_fig` 所示，其中P1为参考点，P2、P3、P4分别
为沿长、宽、高三个向量方向延伸的顶点。

.. figure:: media/plot_2d.png
   :width: 4.0in
   :name: plot_2d_fig

   二维画图-三个顶点（P1、P2、P3，或两个顶点P1、P3）确定矩形画图范围

.. figure:: media/plot_3d.png
   :width: 3.0in
   :name: plot_3d_fig

   三维画图-四个顶点（P1、P2、P3、P4）确定长方体画图范围

.. _section_plot_cards:

画图模块输入卡
-------------------

画图模块的输入方式为：

.. code-block:: none

  PLOT
  [ColorScheme = <scheme number>] [Continue-calculation = <flag>]
  PlotID <id> Type=<type> Color=<color> Pixels= <pixel_sizes> Vertexes= <vertexes>



其中，

-  **PLOT** 画图模块的关键词。

-  **ColorScheme**\ 选项卡设置画图颜色方案（对彩色填充材料有效），\ **scheme
   number**\ 可为任意正整数，数值不同，则图像材料-色彩搭配随机变化。通过此卡可
   以调整图像颜色对比度。缺省值为\ **1**\ 。

-  **Continue-calculation**\ 选项卡用来控制画图后是否继续执行计算。\ **0**\ 表
   示跳过计算，画图后程序退出；\ **1**\ 表示画图后继续执行计算。缺省值为\ **0**\ 。

-  **PlotID**\ 选项卡指定画图参数，\ **<id>**\ 选项卡指定画图编号，用于图像标识，
   对应的输出图像文件名为\ *inputfilename*\ _plot_\ *id*\ （png或vti格式）。

-  **Type**\ 选项卡指定图像类型，可选值为\ **Slice**\ 、\ **Box**\ ，其中
   \ **Slice**\ 表示输出二维图像；\ **Box**\ 表示输出三维图像。该选项与
   \ **ColorType**\ 、**Pixels、Vertexes**\ 的一致性见 :numref:`plot_types_table` 。

-  **Color**\ 设置画图色彩样式，指对模型信息的涂色方式，包括对材料涂色及栅元涂色，
   以及根据是否画出栅元边界组合形成共五种样式：材料色彩样式（\ **Mat**\ ）、栅元
   色彩样式（\ **Cell**\ ）、边界面样式（\ **Surf**\ ）以及材料色彩栅元边界样式
   （\ **MatSurf**\ ）和栅元色彩栅元边界样式（\ **CellSurf**\ ）。其中材料/栅元色
   彩指同样栅元/材料填充相同颜色（色彩方案由\ **ColorScheme**\ 确定），
   \ **Surf**\ 指用黑色线条（1个像素宽度）画出栅元边界。

-  **Pixels**\ 指定图像像素尺寸，即对画图区域显示的分辨率。二维图
   像（\ **Slice**\ ）由长×宽两个像素值确定，三维图像（\ **Box**\ ）由长×宽×高
   三个像素值确定，像素值为正整数。像素尺寸越大，图像越精细，但同时占用内存越大。
   建议图像尺寸与画图矩形尺寸相对应，以免图像变形。

-  **Vertexes**\ 指定画图区域的顶点。每个顶点均由x/y/z三个浮点数值表示。对于二维
   图像（\ **Slice**\ ），需要两个顶点（\ **P1**\ 和\ **P3**\ ，所在面垂直于坐标
   轴，即\ **x1与x2、y1与y2、z1与z2**\ 必须有一组相同）或三个顶点（\ **P1**\ 、
   \ **P2**\ 、\ **P3**\ ，\ **P1→P2**\ 与\ **P2→P3**\ 垂直）。比
   如\ **Vertexes**\ = -15 70 20 65 10
   20表示矩形为垂直于z轴（在z=20平面上）。注意画图平面不应与用户定义的曲面重合，
   因为在平面处无法判断几何特征（程序具有一定的自动调整位置以避免与面重合的功能，
   但对于重复结构交界面等虚拟面无法判断，不能处理可能会出错）。

    对于三维图像（\ **Box**\ ），需要四个顶点（\ **P1**\ 、\ **P2**\ 、
    \ **P3、P4**\ ）确定画图区域，其中向量\ **P1→P2**\ 、\ **P2→P3、P3→P4**\ 必
    须两两垂直。如\ **Vertexes** = 0 0 0 10 0 0 10 5 0 10 5 8。

.. table:: 画图参数一致性关系
  :name: plot_types_table

  +---------+----------------------------------------+------------+--------------+
  |**Type** | **Color**                              | **Pixels** | **Vertexes** |
  +=========+========================================+============+==============+
  |**Slice**| Mat / Cell / Surf / MatSurf / CellSurf | 2 (int)    | 6 / 9 double |
  +---------+----------------------------------------+------------+--------------+
  |**Box**  | Mat / Cell / Surf*/ MatSurf*/ CellSurf*| 3 (int)    | 12 double    |
  +---------+----------------------------------------+------------+--------------+

\*注：暂不支持。


.. _section_plot_example:

画图模块输入示例
---------------------

一次运行可以画多幅图像，与图像一同输出的\ *inputfilename*.plot文件保存图像尺寸及
色彩等相关信息。

.. code-block:: c

  PLOT ColorScheme=9
  PlotID 1 Type = slice Color = Mat Pixels=900 900 Vertexes=0 20 0 20 0 0
  PlotID 2 Type = Slice Color = Cell Pixels= 1800 1265 Vertexes= 0 0 20 90 0 20 90 60 0
  PlotID 6 type = box color = Mat Pixels=100 100 200 vertexes = 0 0 0 10 0 0 10 10 0 10 10 20


|

.. _section_fixedsource:

固定源计算
=================

RMC支持固定源计算功能。固定源功能用于已知外中子源的情况下，计算系统内中子分布随
空间、能量和时间的变化。固定源计算可分为稳态计算和含时计算两种，目前的RMC版本仅
支持稳态计算功能。与此同时，RMC固定源功能可以使用多群和连续能量的ACE格式的中子
截面数据。需要注意的是，稳态固定源计算仅适用于不含裂变核素的系统或者次临界的增殖系统。

.. _section_fixedsource_particle:

模拟粒子总数目
---------------------

.. code-block:: none

    FixedSource
    PARTICLE population=<N>  fission=<fN fP>



其中，

-  **FixedSource**\ 为固定源模块的关键词；

-  **population**\ 指定固定源计算中使用的初始粒子数，N表示初始粒子数；

-  **fission**\ 指定是否关闭裂变中子和光子，如果fN为0则表示关闭裂变中子，
   如果fN为1则表示打开裂变中子，如果fP为0则表示关闭裂变光子，
   如果fP为1则表示关闭裂变光子。

.. _section_fixedsource_cutoff:

截断条件
----------------

.. code-block:: none

  FixedSource
  CutOff [MaxLost=<maxLost>]
         [MinWeight=<minWeightN minWeightP>]
         [MaxWeight=<maxWeightP>]

其中，

-  **CutOff**\  为截断条件输入卡的关键词。

-  **MaxLost**\ 选项卡指定程序允许丢失的最大粒子数，缺省值为 10。

-  **MinWeight**\ 选项卡指定输运过程中的权重下限，**minWeightN**\ 指定中子的
   权重下限，缺省值为0.25，**minWeightP**\ 指定光子的权重下限，缺省值为0.6。
   - 在权窗减方差功能开启后，此处输入无效

-  **MaxWeightP**\ 选项卡指定光子在输运过程中的权重上限，缺省值为1.4。

.. _section_fixedsource_example:

固定源模块输入示例
-----------------------

固定源释放10000个源中子。

.. code-block:: c

    UNIVERSE 0
    cell 1   -1      mat = 1           // sphere inside
    cell 2   1 & -2  mat = 1           // sphere middle
    cell 3   2 & -3  mat = 2           // sphere outside
    cell 4   3       mat = 0  void = 1

    SURFACE
    surf  1  so  10
    surf  2  so  20
    surf  3  so  30

    MATERIAL
    mat 1  -10.045   // Fuel
        92235.71c   6.89220E-03
        92238.71c   2.17104E-02
        8016.71c    4.48178E-02
    mat 2  -0.9     // Water
        1001.71c   2.0
        8016.71c   1.0
    sab 2  HH2O.71t

    FixedSource
    particle population = 10000

    EXTERNALSOURCE
    Source 1 particle = 1 energy = 0.1 sphere = 0 0 0 0 5
    
    Tally
    CellTally  5  type = 1  cell = 1 2  time=0 5.0e-8  1.0e-7  5.0e-7 1.0e-6
    CellTally  6  type = 2  cell = 1 2  energy = 0 6.25E-7 20 time=0 5.0e-8  1.0e-7  5.0e-7 1.0e-6


|

.. _section_dynamics:

时空动力学计算（仅限企业版本）
================================

RMC支持时空动力学计算功能，该功能用于模拟稳态反应堆在受到反应性扰动后，系统内中
子通量随时间和空间的变化情况。RMC时空动力学计算功能采用预估修正准静态方法，计算
过程中，将中子时空动力学方程拆解成具有刚性的关于幅度函数的点堆方程，以及关于预
估通量的形状函数方程。点堆方程采用常微分方程组的数值解法求解，形状函数方程采用蒙
卡方法求解，其中点堆方程中的点堆参数由蒙卡方法直接统计得到。RMC时空动力学计算模
块可使用多群和连续能量的中子核反应截面。

.. _section_dynamics_cards:

时空动力学模块输入卡
-------------------------

由于时空动力学计算的对象包含反应堆的两种状态，即扰动前的稳态和扰动后的瞬态，因此
相应地需要两种输入文件来描述反应堆的状态。第一种输入文件对应于反应堆稳态，其中的
动力学模块输入卡用于引导RMC进行相应动力学稳态计算；第二种输入文件对应于反应堆瞬
态，其中的动力学模块输入卡用于引导RMC进行相应的动力学瞬态计算。需要注意的是，稳
态计算输入卡与瞬态计算输入卡中的population参数应保持一致。时空动力学计算模块支持
并行计算功能，但是目前输入文件中不可指定并行计算模式，其强制采用主从并行模式。

时空动力学模块稳态计算输入卡
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

  QUASISTATIC_S
  PowerIter Population = <N Mi Mt>
  InitSrc type=<params>
  Timestep deltat=<data>
  Adjoint <flag>
  WriteSourceCount <data>
  WriteKineticsSrc <flag>


其中，

-  **QUASISTATIC_S**\ 为稳态时空动力学计算关键词，后缀S表示Static；

-  **PowerIter**\ 指定源迭代参数；

-  **InitSrc**\ 指定初始裂变源；

-  **Timestep**\ 指定瞬态第一个形状时间步的步长，单位为秒；

-  **Adjoint**\ 指定动力学计算过程中是否使用伴随通量加权，**0**\ 表示使用常数加权
   ，**1**\ 表示使用伴随通量加权。注意，当使用伴随通量加权时，除输入卡外，还需要准备
   伴随通量文件，该文件可由反复裂变几率法生成，需命名为*Adjoint*\ 。

-  **WriteSourceCount**\ 指定在动力学计算中，生成的缓发中子源与时间吸收源的数目，
   默认与源迭代参数中的每代中子数保持一致。由于在准静态计算中，每个时间步生成的源都会
   输出到.source文件中，因此减少该选项的数目，可以减小.source文件的体积。

-  **WriteKineticsSrc**\ 指定是否输出直接模拟法初始临界源分布,0为不输出,1为输出,默认为0。生成源中子的数目默认与源迭代参数中的每代中子数保持一致,若指定了WriteSourceCount参数,则与WriteSourceCount参数一致。


时空动力学模块瞬态计算输入卡
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

  QUASISTATIC_D
  PowerIter Population = <N Mi Mt>
  Timestep deltat=<data>
  Adjoint <flag>
  WriteSourceCount <data>
  Substep number=<data> interpolate=<flag>



其中，

-  **QUASISTATIC_D**\ 为瞬态时空动力学计算关键词，后缀D表示Dynamic；

-  **PowerIter**\ 指定源迭代参数，参数population应与稳态计算输入卡保持一致；

-  **Timestep**\ 指定瞬态下一个形状时间步的步长，单位为秒。RMC支持变步长计算。

-  **Adjoint**\ 指定动力学计算过程中是否使用伴随通量加权，**0**\ 表示使用常数加权
   ，**1**\ 表示使用伴随通量加权。注意，当使用伴随通量加权时，除输入卡外，还需要准备
   伴随通量文件，该文件可由反复裂变几率法生成，需命名为*Adjoint*\ 。由准静态方法的
   理论可知，该文件应与稳态计算所用的伴随通量文件一致。

-  **WriteSourceCount**\ 指定在动力学计算中，生成的缓发中子源与时间吸收源的数目，
   默认与源迭代参数中的每代中子数保持一致。由于在准静态计算中，每个时间步生成的源都会
   输出到.source文件中，因此减少该选项的数目，可以减小.source文件的体积。

-  **Substep**\ 指定动力学计算中，当前形状时间步与上一个形状时间步之间，用于求解点堆方程的动态参数
   的插值数。其中，**number**\ 指定插值的数量，**interpolate**\ 指定是否进行
   线性插值。例如，**number = 50 interpolate = 1**\ 表示在两个形状时间步之间进行
   动态参数插值，插值后的子步数量为50。使用该选项可以提高点堆方程的求解精度。

注意，在计算瞬态时间步时，需要将上一个时间步生成的.source保存，并将其前缀改为
当前时间步的输入卡文件名。例如，假设稳态时间步的输入卡名为"static"，第一个
瞬态时间步的输入卡名为"step1"，那么就需要在完成稳态时间步的计算后，
将"static.source"重命名为"step1.source"，然后再执行第一个瞬态时间步的计算。
用户可以自行编写shell、python等脚本文件，来方便、灵活地完成整个瞬态计算。


.. _section_dynamics_example:

时空动力学模块输入示例
---------------------------

时空动力学模块稳态计算输入示例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: c

  QUASISTATIC_S
  PowerIter population=500000 200 800 Keff0=1.0
  InitSrc point=12.5 5.5 6.5 11.5 5.5 6.5
  Timestep deltat=2.0E+00
  Adjoint 1
  WriteSourceCount 500000

时空动力学模块瞬态计算输入示例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: c

  QUASISTATIC_D
  PowerIter population=500000 200 800 Keff0=1.0
  Timestep deltat=2.0E+00
  Adjoint 1
  WriteSourceCount 500000
  Substep number=200 interpolate=1

输出文件说明
-----------------

RMC时空动力学计算产生两类重要的结果输出文件，用户只需关心此两类输出文件。第一类
结果输出文件包含各个时间步对应的反应堆功率、通量幅度、点堆参数以及若干中间结果等
信息；第二类结果输出文件包含各个时间步对应的未经过归一化处理的通量形状或者功率空
间分布信息。第一类文件以".innerproduct"命名，第二类文件以".tally"命
名。

RMC一次时空动力学模拟会产生多个".innerproduct"和".tally"文
件，用户可以自行编写脚本文件，从这些文件中提取信息。

需要注意的是， “.innerproduct”、".tally"文件中的功率变化及功率空间分布（或中子通量形状）
是未经过归一化的。

|

.. _section_appendix:

临界搜索（仅限企业版本）
===========================


RMC支持在临界和燃耗模式下临界搜索，包括材料的核素密度搜索和几何的面位置搜索。

材料搜索模块输入卡
-----------------------

.. code-block:: none

    CriticalitySearch
    Materialsearch target=<param> error=<param> max=<maximum> perb=<differentialoperator id>
    Differentialoperator <id> [cell=<cell_vector>] material=<mat id> nuclide=<nuc>
        [estimator=<param>] [order=<param>] [sourceperb=<param>] [batchcycle=<param>]  [outputbycycle=<param>]


其中，

-  **CriticalitySearch**\ 为临界搜索模块关键词；

-  **materialsearch**\ 为材料搜索输入卡，由于为单参数搜索，该输入卡使用次数不超过1；

-  **target**\ 为搜索的目标keff值；

-  **error**\ 为搜索的阈值，当target-error < keff+-keff_std < target+error时认为搜索完成；

-  **max**\ 为最大搜索次数。在一次临界计算结束后，程序将进行参数搜索计算；
   随后将使用搜索得到的参数继续进行临界计算-参数搜索-临界计算...循环直至满足收敛条件。
   设置该参数是为了防止在极端情形下，程序无法收敛而陷入死循环的情况发生。
   需要注意的是，在参数满足收敛条件之前，程序会关闭Tally计数。如果用户使用了Tally（计数器）功能，
   程序将在参数收敛之后，重新打开Tally计数并再次执行临界计算（仅活跃代）。
   因而，若\ **max = 1**\ 且没有开启Tally，则程序的计算过程为：临界计算-参数搜索-临界计算。
   若\ **max = 1**\ 且开启了Tally，则程序的计算过程为：临界计算-参数搜索-临界计算-活跃代临界计算。
   特别地，当用户指定\ **max = 0**\ 时，程序将仅做一次临界计算和一次搜索，且不会关闭Tally计数。

-  **perb**\ 为搜索使用的微分算符法的id，对应于differentialoperator输入卡；

-  **differentialoperator**\ 为微分算符法输入卡，支持多个同时使用，其后紧跟的id须不同；

-  **cell**\ 为扰动栅元向量，层级输入格式和celltally中一致，缺省时仅material定位，否则cell和material采用与关系共同定位；

-  **material**\ 为扰动材料在material卡中的id，不可缺省；

-  **nuclide**\ 为扰动核素的zaid；

-  **estimator**\ 扰动的keff估计器，0-碰撞估计器，1-吸收估计器，2-径迹长度估计器；注意:TMS模式下只能使用吸收估计器；估计器编号随版本有变动

-  **order**\ 为扰动的最高阶数，1-一阶，2-二阶；

-  **sourceperb**\ 是否使用源扰动，0-不使用（默认值），1-使用。使用源扰动计算更加精确，但同时耗时增加；

-  **batchcycle**\ 为使用源扰动时batch中的代数，默认值为5；

-  **outputbycycle**\ 是否每代输出微扰系数，0-仅最后一代输出（默认值），1-每代输出。

材料搜索模块输入示例
--------------------------

以下算例为对栅元2材料2中第一个核素密度进行搜索，目标值为1，阈值为0.01，最大迭代次数为3，
搜索方法为利用二阶微分算符法对keff碰撞估计器的微扰系数进行类牛顿迭代法，
同时使用源扰动，batch代数为5，仅最后一代输出。

.. code-block:: none

    CRITICALITYSEARCH
    materialsearch
    max = 3
    target = 1
    error = 0.0
    perb = 1
    differentialoperator 1
    cell = 2
    material = 2
    nuclide = 92235
    estimator = 2
    order = 2
    sourceperb = 1
    batchcycle = 5
    outputbycycle = 0

材料搜索输出文件
----------------------

材料搜索的信息在.critisearch文件中，包含各个微分算符法的一、二阶微扰系数及其相对标准偏差，
临界迭代时当前keff和标准差，搜索核素原子密度在迭代前后的值，
用-->分割。

.. code-block:: none

    Cycle  Perb   First_Ave   First_Re    Second_Ave  Second_Re
    100    0      2.94622E-01 1.77817E-01 4.65745E-02 7.85989E+00
    Iter   Nuc    keff                    Atom Density
    0      1      0.968321 +- 0.007071    9.88665E-03 --> 1.09408E-02

    Cycle  Perb   First_Ave   First_Re    Second_Ave  Second_Re
    100    0      4.44978E-01 1.35197E-01 3.32123E-02 8.53374E+00
    Iter   Nuc    keff                    Atom Density
    1      1      0.987481 +- 0.009976    1.09408E-02 --> 1.12483E-02

    Cycle  Perb   First_Ave   First_Re    Second_Ave  Second_Re
    100    0      2.53745E-01 2.90857E-01 -4.64625E-02 3.47310E+00
    Iter   Nuc    keff                    Atom Density
    2      1      0.968038 +- 0.009095    1.12483E-02 --> 1.26652E-02

    Cycle  Perb   First_Ave   First_Re    Second_Ave  Second_Re
    100    0      3.13533E-01 1.80227E-01 -1.35241E-03 1.64309E+02
    Iter   Nuc    keff                    Atom Density
    3      1      0.973322 +- 0.010536    1.26652E-02 --> 1.37428E-02

    Cycle  Perb   First_Ave   First_Re    Second_Ave  Second_Re
    100    0      2.69473E-01 2.54405E-01 1.06923E-02 9.01484E+00

几何搜索模块输入卡
-----------------------

.. code-block:: none

    CriticalitySearch
    Geometrysearch surface=<surf id> target=<param> error=<param> max=<maximum> method=<param> adaptive=<param>
           leftbound=<param> rightbound=<param> adjointtally=<param>


其中，

-  **CriticalitySearch**\ 为临界搜索模块关键词；

-  **geometrysearch**\ 为几何搜索输入卡，由于为单参数搜索，该输入卡使用次数不超过1；

-  **surface**\ 为搜索面的编号；

-  **target**\ 为搜索的目标keff值；

-  **error**\ 为搜索的阈值，当target-error < keff+-keff_std < target+error时认为搜索完成；

-  **max**\ 为最大迭代次数，防止极端情形下无法收敛而陷入死循环；

-  **method**\ 为搜索的数值迭代方法，0-利用反复裂变几率法（第13章）计算得到几何微扰系数进行牛顿法迭代，1-二分法，2-试位法，3-Ridder方法；

-  **adaptive**\ 是否自适应调整活跃代代数，0-不使用，1使用；

-  **leftbound**\ 为搜索面位置的左初值，搜索过程中小于该值即停止搜索；

-  **rightbound**\ 为搜索面位置的右初值，搜索过程中大于该值即停止搜索，目标值应预估在左初值和右初值之间。

-  **adjointtally**\ 为利用反复裂变几率法（第13章）计算得到几何微扰系数进行牛顿法迭代时，对应的几何微扰计数器的编号

几何搜索模块输入输出示例
------------------------------

几何搜索结果在.critisearch文件中，包含每次迭代步keff和标准差，Parameter为下一迭代步的搜索面位置，Cycle为当前迭代步所使用的总代数。

以下示例中，搜索面1的位置在5cm到10cm之间，搜索目标值在0.99到1.01之间，使用自适应调整代数的Ridder迭代法。最后搜索面位置为8.74888cm，此时keff为1.001257+-0.001635。

.. code-block:: none

    Geometrysearch
    surface=1
    target=1
    error=0.01
    method=3
    adaptive=1
    leftbound=5
    right=10

.. code-block:: none

    Final Keff: 1.001257      Standard Deviation: 0.001635

    Iter   SurfId  keff                    Parameter      Cycle
    0      1       0.602600 +- 0.000280    1.00000E+01    300
    Iter   SurfId  keff                    Parameter      Cycle
    1      1       1.115286 +- 0.000489    7.50000E+00    300
    Iter   SurfId  keff                    Parameter      Cycle
    2      1       0.876570 +- 0.001635    8.74888E+00    110


|

.. _section_ifp:

反复裂变几率法计算
================================

RMC反复裂变法可以在临界和燃耗计算模式下计算动态参数和几何微扰系数，其中几何微扰
系数仅用于连续能量截面，动态参数除此之外还可应用于多群截面。

反复裂变几率法模块输入卡
-----------------------------

.. code-block:: none

    Adjoint
    blocksize=<param>
    fisbranch=<param>
    OUTPUTINTERVAL=<param>
    kinetic
    AdjointFluxMesh [Energy=<enenrgy>]  [Scope=<scope>] [Bound=<bound>]
    [GeoAdjointTally <param> surf=<param> type=<param> parameters=<param> constraint=<param> universe=<param> cellmat=<param> cutoffcos=<param>]

其中，

-  **Adjoint**\ 为反复裂变几率法模块关键词；

-  **blocksize**\ 指定多少活跃代为一个块，默认为10；

-  **fisbranch**\ 指定每次裂变能产生几个裂变中子，默认为1，数值越大，反复裂变
   几率法初始分配内存越大；

-  **OUTPUTINTERVAL**\ 指定每多少代输出伴随计算结果，默认所有活跃代结束才输出；

-  **kinetic**\ 计算动态参数关键词；

-  **AdjointFluxMesh**\ 为反复裂变几率法求解临界伴随通量输入卡的关键词。

   -  **Energy**\ 选项卡指定伴随通量的能量分界点。

   -  **Scope**\ 选项卡指定网格在x，y，z方向的数量。特别地，参数为“-1”表示该方向上
      只有一层无限大网格 (注意：在Universe重复几何中的Scope选项卡当中，参数为1表示
      该方向上只有一层无限大网格)。

   -  **Bound**\ 选项卡指定网格在x，y，z方向的边界范围，形如“Bound = x_min
      x_max y_min y_max z_min z_max”。若某方向只有一层网格，
      \ **Bound**\ 选项卡中对应的参数没有实际意义。
      
   **AdjointFluxMesh**\ 为几何微扰输入卡的关键词。

   -  **surf**\ 计算几何微扰系数对应面在Surf卡中编号；

   -  **type**\ 几何形变类型。1：平移，2：均匀扩张，3：单向扩张，4：旋转；

   -  **parameters**\.描述几何形变的参数。平移需要三个参数，即指向平移方向的归一化向量；均匀扩张不需要参数；单向扩张需要三个参数，即指向扩张方向的归一化向量；旋转需要7个参数，分别是旋转轴的归一化方向向量，旋转不动点的坐标，和旋转方向（符合右手定则为正1，不符合为负1）。

   -  **constraint**\ 约束栅元。仅对约束栅元内的曲面进行扰动。输入格式通cell输入卡相同。

   -  **universe**\ 约束栅元所在的空间。

   -  **cellmat**\ 用于限制面的扰动部分，正数表示栅元，负数表示材料。均为程序内部编号。

   -  **cutoffcos**\ 穿面余弦的截断值。

动态参数输出文件
---------------------

输出结果给出以下动态参数结果的平均值和标准差：有效中子代时间，单位为微秒；rossi-alpha，
单位为1/微秒；有效缓发中子份额，单位为1。

.. code-block:: none

    ------------------ Current Cycle Number = 50 ------------------

    ------------------ kinetic parameters, gen. time, rossi-alpha, beta-eff  ------------------
                              Ave          std. dev.
    gen. time    (us)    2.39916E+01     1.23582E+00
    rossi-alpha (us-1)  -3.32090E-04     1.19101E-04
    beta-eff             8.47770E-03     3.27803E-03

几何微扰系数输出文件
-------------------------

输出结果给出几何微扰系数结果的平均值和相对标准偏差：输运项；散射和裂变项。
总结果为两者之和，如实例中几何微扰系数为0.013019。

.. code-block:: none

    ------------------ Current Cycle Number = 300 ------------------

    ------------------ geometrical perturbation parameters ------------------
                              Ave          Re
    transport:          2.74153E-04     5.18707E-01
    scatter + fission:  1.27445E-02     8.43237E-01


|


.. _section_domain_decomp:

区域分解（仅限企业版本）
==================================


RMC支持区域分解并行模型。

注意：模块输入卡必须定义在燃耗模块输入卡之后，并行计算使用的 **MPI进程数必须是区域数目的倍数**\ 。


区域分解输入卡
---------------------


目前RMC支持两种区域分解的输入方式。

.. code-block:: none

    DomainDecomposition
    Expand <flag>


其中，

-   **DomainDecomposition**\ 为区域分解模块的关键词；

-  **Expand**\ 为判断使用哪种输入方式的关键词, **0**\ 为默认值，由用户自行指定各个区域，而 **1**\ 为简化输入的方法，更简化
   的方式是，没有\ **Expand** \关键词时，为用户自行指定，有\ **Expand** \时为简化输入方法；

第一种方法的输入格式为：

.. code-block:: none

    DomainDecomposition
    Expand 0  Domain <id>  cell = < cell_1  cell_2 ... cell_n>

或直接写为：

.. code-block:: none

    DomainDecomposition
    Domain <id_1>  cell = < cell_11  cell_12 ... cell_1n>
    Domain <id_2>  cell = < cell_21  cell_22 ... cell_2n>


其中，

-   **DomainDecomposition**\ 为区域分解模块的关键词；

-   **Expand**\ 为判断使用哪种输入方式的关键词， **0**\（默认值）表示使用第一种输入方式；

-   **Domain**\ 为每个区域序号及包含栅元的关键词，**id**\ 为区域的序号；

-   **Cell**\ 为区域包含的栅元号，输入格式和CellTally中Cell一致。


第二种的简化输入的输入格式为：

.. code-block:: none

    DomainDecomposition
    Expand 1  AxialLevel = <level>  RadialLevel = <level>
              AxialUniv  = <univ>   RadialUniv  = <univ>
              AxialDomain = < id_1 id_2 ... id_n>  RadialDomain = < id_1 id_2 ... id_n >

或直接写为：

.. code-block:: none

    DomainDecomposition
    Expand  AxialLevel = <level>  RadialLevel = <level>
            AxialUniv  = <univ>   RadialUniv  = <univ>
            AxialDomain = < id_1 id_2 ... id_n>  RadialDomain = < id_1 id_2 ... id_n >

其中，
-   **DomainDecomposition**\ 为区域分解模块的关键词；

-   **Expand**\ 为判断使用哪种输入方式的关键词，**1**\ 表示使用第二种输入方式，即简化输入方法；

-   **AxialLevel**\ 为轴向区域划分的Universe所在的几何层级的关键词，**level**\ 为几何层级的序号；

-   **RadialLevel**\ 为径向区域划分的Universe所在的几何层级的关键词，**level**\ 为几何层级的序号；

-   **AxialUniv**\ 为轴向区域划分的Universe，**univ**\ 为被划分的重复结构Universe的序号；

-   **RadialUniv**\ 为径向区域划分的Universe，**univ**\ 为被划分的重复结构Universe的序号；

-   **AxialDomain**\ 为轴向Universe中划分的区域号，**id**\ 为区域的序号，0为公共区域；

-   **RadialDomain**\ 为径向Universe中划分的区域号，**id**\ 为区域的序号，0为公共区域；

需要注意，区域分解目前仅对燃耗区进行区域分解，其他区域均设置为公共区域。\ **区域分解需要放在计数器卡之前** \，这样，
每个区域产生的输出文件将只包含所在区域的计数，以及公共区域的计数，但`MeshTally`的计数结果仅在主核输出。



区域分解示例
-------------------

第一种方法的输入示例：

.. code-block:: none

    DomainDecomposition
    Domain 1  cell = 1 >   1: 136 > 3
    Domain 2  cell = 1 >  137:289 > 3


第二种方法（简化输入）的输入示例：


.. code-block:: none

    DomainDecomposition
    Expand AXIALLEVEL=0 RADIALLEVEL=1 AXIALUNIV=0 RADIALUNIV=8 AXIALDOMAIN=1 RADIALDOMAIN=
           1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
           1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
           1 1 1 1 1 0 1 1 0 1 1 0 1 1 1 1 1
           1 1 1 0 1 1 1 1 1 1 1 1 1 0 1 1 1
           1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
           1 1 0 1 1 0 1 1 0 1 1 0 1 1 0 1 1
           1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
           1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
           2 2 0 2 2 0 2 2 0 2 2 0 2 2 0 2 2
           2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
           2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
           2 2 0 2 2 0 2 2 0 2 2 0 2 2 0 2 2
           2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
           2 2 2 0 2 2 2 2 2 2 2 2 2 0 2 2 2
           2 2 2 2 2 0 2 2 0 2 2 0 2 2 2 2 2
           2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
           2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2


.. _section_su:

敏感性和不确定度分析（仅限企业版本）
======================================

三明治法敏感性和不确定度计算
----------------------------------

keff敏感性分析采用反复裂变几率法，可以用在传统的幂迭代方法以及超历史方法。广义敏感性分析采用碰撞历史法。如果需要进行不确定度计算，需要先执行敏感性计算。需要协方差索引文件“covdir”，以及covdir目录中指向的协方差数据库。

敏感性分析
~~~~~~~~~~~~~~~~~~~

keff敏感性分析的输入示例：

.. code-block:: none

    Adjoint
    method <flag>
    KEFF
    BlockSize <Number>
    Nuclide  <zaid.xxx>   ……
    Reaction= <reaction_list_1, reaction _list_2, …>   ……
    Constrain <flag_1, flag_2, flag_3,…>
    groupoption <Number>
    Uncertainty
    OUTPUTINTERVAL <Number>
    OUTPUTTOTALSEN <flag>


广义敏感性分析的输入示例：


.. code-block:: none

    Adjoint
    GENERAL
	BlockSize <Number>
	ResponseNu <zaid.xxx> 	<zaid.xxx>
    ResponseMT = <reaction_list_1, reaction _list_2>
    Ratio = <ratio_list_1, ratio _list_2>
    Nuclide  <zaid.xxx>   ……
    Reaction= <reaction_list_1, reaction _list_2, …>   ……
    groupoption <Number>
    Uncertainty
    OUTPUTINTERVAL <Number>
    Cell = <Number>

随机抽样法扰动单一核素的输入示例：


.. code-block:: none

    Sampling
    SAMPLESIZE=<Number>
    Nuclide <zaid.xxx>
    Reaction= <reaction_list_1, reaction _list_2>
    GROUPOPTION <Number>



随机抽样法扰动所有核素的输入示例：


.. code-block:: none

    Sampling
    SAMPLESIZE = <Number>
    All
    GROUPOPTION <Number>


其中，

-   **Keff**\ 为keff敏感性分析方法输入卡的关键词。默认情况下，该选项卡关闭。

.. code-block:: none

   Method   <flag>

其中，

-   **Method**\ 为keff敏感性分析方法输入卡的关键词。


-   **flag**\ 指定keff敏感性分析方法。\ **flag = 0**\ （缺省值）为传统的幂迭代方法，\ **flag = 1**\ 为超历史方法，其中超历史方法不支持OpenMP计算，广义敏感性分析无需开启此选项卡，几何微扰不支持超历史方法。


.. code-block:: none

   BlockSize   <Number>

其中，

-   **BlockSize**\ 为指定伴随通量（反复裂变几率）或广义伴随通量收敛代数的关键词，\ **Number**\ 为相应参数，建议一般取10。

.. code-block:: none

   Nuclide
          <zaid.xxx>
          <zaid.xxx>   ……

其中，

-   **Nuclide**\ 为敏感性分析的核素输入卡关键词。

-   **zaid.xxx**\ 指定核素所对应的ACE截面数据库，其中\ **zaid**\ 为核素ID，后缀\ **.xxx**\ 指定了截面数据库的类型。

.. code-block:: none

   ResponseNu
            <zaid.xxx>
            <zaid.xxx>

其中，


-   **ResponseNu**\ 为定义广义敏感性分析第一类响应函数涉及的核素的输入卡关键词。


-   **zaid.xxx**\ 指定核素所对应的ACE截面数据库，其中\ **zaid**\ 为核素ID，后缀\ **.xxx**\ 指定了截面数据库的类型。

.. code-block:: none

   Reaction
           <reaction_list_1, reaction _list_2, …>

-   **Reaction**\ 选项卡指定敏感性分析的各个核素的反应类型。每个核素可以对应多个反应类型，核素之间以逗号间隔，例如“Reaction= 16 17 , 102, -6, 107”。反应类型与编号的对应关系可查阅ENDF/B手册，表7-1给出常见的一些反应类型编号。需要注意的是，\ **Reaction**\ 所对应的核素是和\ **Nuclide**\ 选项卡保持一致的。另外，Reaction选项卡不能和Uncertainty选项卡同时使用。

.. code-block:: none

   ResponseMT
             <reaction_list_1, reaction _list_2>


-	**ResponseMT**\ 选项卡指定广义敏感性分析第一类响应函数涉及的各个核素的反应类型。每个核素可以对应多个反应类型，核素之间以逗号间隔，例如“Reaction= 16 17 , 102, -6, 107”。反应类型与编号的对应关系可查阅ENDF/B手册，表15-1给出常见的一些反应类型编号。需要注意的是，\ **ResponseMT**\ 所对应的核素是和\ **RespnseNu**\ 选项卡保持一致的。


.. table:: 反应类型与编号的对应关系（仅列出部分ENDF反应类型）
  :name: reaction_mts

  +-----------+---------------------+---------------------------------------------------------------+
  | MT编号    | 反应类型            | 备注                                                          |
  +===========+=====================+===============================================================+
  | **1**     | 总截面              | 对于连续能量ACE截面，当截面温度与栅元温度不匹配时，采取多普勒 |
  |           |                     | 展调整弹性散射截面和总截面。这里统计的是调整后的截面。        |
  +-----------+---------------------+---------------------------------------------------------------+
  | **-2**    | 吸收                | 不包含裂变                                                    |
  +-----------+---------------------+---------------------------------------------------------------+
  | **2**     | 弹性散射            |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **4**     | 非弹性散射          |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **18**    | 总裂变              |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **16**    | （n，2n）           | 仅限连续能量ACE截面                                           |
  +-----------+---------------------+                                                               +
  | **17**    | （n，3n）           |                                                               |
  +-----------+---------------------+                                                               +
  | **102**   | （n，γ）            |                                                               |
  +-----------+---------------------+                                                               +
  | **103**   | （n，p）            |                                                               |
  +-----------+---------------------+                                                               +
  | **107**   | （n，α）            |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **452**   | 总平均裂变中子数    |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **455**   | 瞬发平均裂变中子数  |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **456**   | 缓发平均裂变中子数  |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **-1018** | 总裂变中子谱        |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **-1455** | 瞬发裂变中子谱      |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+
  | **-1456** | 缓发裂变中子谱      |                                                               |
  +-----------+---------------------+---------------------------------------------------------------+

.. code-block:: none

   Ratio
        <ratio_list_1, ratio _list_2>

-   **\ Ratio**\ 选项卡指定广义敏感性分析第一类响应函数的构成。该选项卡需要与\ **RespnseNu**\ 以及\ **ResponseMT**\ 结合使用。例如

.. code-block:: none

   ResponseNu
     92235.60c
     92238.60c
   ResponseMT =
     18,
     18
   Ratio =
     2 1

其中，ResponseNu 定义了两个核素92235和92238，ResponseMT定义了它们的反应类型均为MT=18，即总裂变。其中，根据两个核素出现的顺序，92235的总裂变序号为1，92238的总裂变序号为2，则Ratio=2 1表示，序号2除以序号1，从而构成一个第一类响应函数。即，U-238的裂变反应率除以U-235的裂变反应率。当前版本中，Ratio只能定义一个响应。

.. code-block:: none

   GENERAL

其中，

-   **GENERAL**\ 为广义敏感性分析方法输入卡的关键词。默认情况下，该选项卡关闭。


.. code-block:: none

   Constrain   <flag_1, flag_2, flag_3,…>

其中，

-   **Constrain**\ 为计算束缚的裂变中子谱输入卡的关键词。

-   **flag**\ 指定是否计算束缚的裂变中子谱。\ **flag = 0**\ （缺省值）为不计算束缚的裂变中子谱，\ **flag = 1**\ 为计算束缚的裂变中子谱。执行不确定度计算时，建议对所分析的核素计算束缚的裂变中子谱，以得到正确的结果。

-    广义敏感性分析无需开启此选项卡

.. code-block:: none

   Cell = Cell_vector

其中，


-	**Cell**\ 是栅元输入卡关键词。该选项卡用于定义广义响应函数的几何作用域。具体参见计数器的Cell选项卡。


.. code-block:: none

   GroupOption   <flag>


-   **GroupOption**\ 选项卡指定敏感性系数输出的能群数目。\ **flag = 0**\ 为用户自定义能量框架，具体能量点通过Energybin选项卡指定，\ **flag = 1**\ （缺省值）为计算能量积分敏感性系数，\ **flag = 252**\ 为程序内嵌的252能量网格，\ **flag=44**\ 为程序内嵌的44群能量网格，\ **flag=56**\ 为程序内嵌的56群能量网格。


.. code-block:: none

   Energybin   <energy_1 energy_2 energy_3 …>


-	**Energybin**\ 选项卡指定敏感性系数输出的能量区间，参数为能量间隔点（Mev）。例如，“\ **Energybin 6.25E-7  20**\ ”表示计数区间为0.625ev到20Mev，20Mev到正无穷。\ **Energybin**\ 选项卡只可在\ **GroupOption**\选项卡的\ **flag=0**\ 情况下使用。



不确定性分析
~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   Uncertainty


-	**Uncertainty**\ 为不确定性分析输入卡的关键词，加入该选项表示执行不确定度分析。执行不确定度计算时，先执行敏感性系数计算。敏感性分析所涉及的核素通过Nuclide选项卡指定，而所涉及的每个核素的反应类型将通过读取协方差索引文件“covdir”来确定，而不是通过Reaction选项卡。\ **Uncerainty**\ 选项卡开启时 \ **GroupOption**\选项卡的\ **flag**\ 会在程序内部置为44，即采用44群协方差数据库计算不确定度。


输出选项卡
~~~~~~~~~~~~~~~~~~~

.. code-block:: none

   OUTPUTINTERVAL   <Number>

其中，


-	**OUTPUTINTERVAL**\ 为指定每隔多少代输出结果的关键词。

-	**Number**\ 指定每间隔Number指定的代的数目输出一次计算结果。默认情况下，只有等到计算模拟结束才输出敏感性系数和不确定度的计算结果。


.. code-block:: none

   OutputTotalSen   <flag>

其中，

-   **OutputTotalSen**\ 为指定是否输出能量积分敏感性系数的关键词。

-   **Flag**\ 指定是否输出能量积分敏感性系数。\ **flag = 0**\ （缺省值）为不计算能量积分敏感性系数，\ **flag = 1**\ 为计算能量积分敏感性系数。该选项卡\ **flag=1**\ 仅能在GroupOption的flag不等于1的情况下使用。

 
随机抽样法不确定度计算
-----------------------------

采用随机抽样法进行不确定度分析，除需要协方差数据库索引文件“covdir”，以及covdir目录中指向的协方差数据库，还需要扰动数据库索引文件“samdir”，以及samdir目录中指向的扰动数据库。

.. code-block:: none

   Nuclide
          <zaid.xxx>
          <zaid.xxx> ……

其中，

-	**Nuclide**\ 为敏感性分析的核素输入卡关键词。
-   **zaid.xxx**\ 指定核素所对应的ACE截面数据库，其中\ **zaid**\ 为核素ID，后缀\ **.xxx**\ 指定了截面数据库的类型。

.. code-block:: none

   Reaction
           <reaction_list_1, reaction _list_2>


-	**Reaction**\ 选项卡指定所需扰动的核素的反应类型。一次计算每个核素只可分析一对反应类型，核素之间以逗号间隔。反应类型与编号的对应关系可查阅ENDF/B手册，表15-1给出常见的一些反应类型编号。需要注意的是，\ **Reaction**\ 所对应的核素是和\ **Nuclide**\ 选项卡保持一致的。另外，对于所分析的核素如输入的反应对在扰动因子数据库中不存在，则程序内部不对其进行扰动，故使用该选项卡前建议先查看对应的扰动因子数据库是否有对应的反应对。

.. code-block:: none

   SampleSize  <Number>

其中，

-	**SampleSize**\ 为指定扰动样本的关键词，\ **Number**\ 为相应参数，目前支持的最大\ **Number**\ 为300。

.. code-block:: none

   All

其中，


-	**All**\ 为扰动所有核素所有反应类型（取决于协方差数据库）的关键词。目前，协方差数据库的不确定度包括散射截面，吸收截面，裂变截面，平均裂变中子数以及裂变中子谱的不确定度。当前版本的随机抽样法不包含裂变中子谱的不确定度。如选择ALL模式则无需填写Nuclide和reaction选项卡。

.. code-block:: none

   GroupOption <EnergySize>

其中，

-	**GroupOption**\ 为指定采用的能群数目（该能群数与使用的扰动因子数据库能群数目一致）的关键词。EnergySize为相应参数。目前，EnergySize只支持44、56和252三种参数选择。



|

源描述
=================

RMC支持用户对源粒子的信息如粒子种类、初始位置、初始能量和初始飞行方向等进行灵活地描述。

按照粒子种类，用户可以定义中子源、光子源、中子和光子混合源；按照计算用途，
可以分为临界源和屏蔽源；按照源粒子的起始位置分布，用户可以定义点源、线源、平面源、
球面源、长方体体积源、圆柱体包含（圆柱筒）体积源和球体（包含球壳体积源）等；
不仅能够支持特定的粒子初始飞行方向和能量，还支持通过概率表分布（包括离散分布
和分段均匀分布）和内置幂函数、指数函数来定义初始粒子飞行方向和能量，其中，
还内置了麦克斯韦裂变谱、瓦特裂变谱、高斯聚变谱、蒸发谱等专门描述能量。
在定义源粒子的方向或能量信息时，可以使用偏倚抽样，使更多的粒子飞向用户感兴趣的方向，
可以减小用户关注区域的统计方差。

源描述模块输入卡
-------------------------

.. code-block:: none

     EXTERNALSOURCE
     Source <id>  Fraction=<fraction>  [Particle=<particle_type>]
            [<Simple type>={params}] [Surface=<surface_id>]  [X=<x>  Y=<y>  Z=<z>]
            [Position=<position>]  [Radius=<radius>] [Axis=<axis>]
            [Polar=<polar_base_vector>]  [PolarTheta=<polar_theta>]  [Extent=<extent>]
            [Height=<height>]  [Norm=<norm>]  [Vector=<direction_basis_vector>
            [DirecMiu=<direction_miu>]  [FaiVector=<fai_basis_vector>]
            [DirecFai=<direction_fai>]  [Energy=<energy>]  [Cell=<cell_vector>]
            [SampEff=<efficiency>] [Biasfrac=<biasfrac>] [Weight=<weight>]
            [Transform=<transform_id>]
     SurfSrcRead  OldSurf=< S1 S2 S3……Sn >  NewSurf = < S11 S21 S31…Sm1…Smn >
                  Cell=<cell_vector_group>  Party=<params>  Coli=<coli>
                  Wtm=<wtm> Axis=<x1 x2 x3>   Extent=<id>  Posace=<posace> Tr=<id>
     Distribution  <id>  [Depend = <id>]  Type = <flag>  Value= <params>
                   Probability = <params>  [Bias = <params>]
     Transformation  <id>  [Move=<x1 x2 x3>]  [Rotate=<a11 a12 a12 a21……a33>]



其中，

-  **EXTERNALSOURCE**\ 为源描述关键词。\ **Source**\ 卡定义通用源描述,
   \ **SurfSrcRead**\ 卡定义接续面源，\ **Source**\ 卡和\ **SurfSrcRead**\ 卡不能
   同时定义；\ **Distribution**\ 卡用于定义\ **Source**\ 卡和\ **SurfSrcRead**\
   卡中使用到的分布，\ **Transformation**\ 卡用于定义\ **Source**\ 卡和\ **SurfSrcRead**\
   卡中使用到的坐标变换，\ **Distribution**\ 卡和\ **Transformation**\卡与S\ **Source**\
   卡或\ **SurfSrcRead**\配套使用，如\ **Source**\ 卡或\ **SurfSrcRead**\ 卡中
   没有用到分布和坐标变换，也可不定义；除\ **SurfSrcRead**\ 卡只能定义一个外，
   其他三种卡可以定义一个或多个，且没有先后顺序。下面分别介绍四个卡的使用方法。

Source 选项卡
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Source卡指定源粒子的基本参数。

-  **ID**\ 指定\ **Source**\ 的编号，方便用户进行区别。需为正整数，且不能重复。

-  **Fraction**\ 指定该源的比例权重，必须大于0。当用户定义多个源时，该比例权重
   才有意义。该比例权重反映各个源的相对大小，用户不需要进行归一化处理。

-  **Particle**\ 指定源粒子的种类，参数必须为正整数1、正整数2或D+正整数。1代表
   中子，2代表光子，D+正整数表示粒子的种类通过一个分布来描述（该模块中分布均采
   用这种形式），该分布需要在\ **Distribution**\ 卡中进行定义，该正整数为对应
   的分布序号（\ **Distribution**\ 卡的ID）。该变量缺省值为1，表示默认粒子类型为中子。

-  **Simple type**\ 可便捷定义常用的均匀体积源：均匀分布的点源、均匀球（壳）体
   积源、轴线平行于坐标轴的圆柱体（壳）均匀体积源。详细参数见 \ 。

.. table:: **Simple type**\支持的初始源分布
  :name: source_types

  +-----------+-----------------------------+-----------------------+
  |关键词     |说明                         |参数                   |
  +===========+=============================+=======================+
  | **Point** |孤立点源                     |x1 y1 z1 x2 y2 z2 …    |
  +-----------+-----------------------------+-----------------------+
  |**Sphere** |球体（壳）均匀源             |x y z Rmin Rmax        |
  +-----------+-----------------------------+-----------------------+
  |**Cyl/x**  |平行于x轴的圆柱体（壳）均匀源|y z Rmin Rmax xmin xmax|
  +-----------+-----------------------------+-----------------------+
  |**Cyl/y**  |平行于y轴的圆柱体（壳）均匀源|x z Rmin Rmax ymin ymax|
  +-----------+-----------------------------+-----------------------+
  |**Cyl/z**  |平行于z轴的圆柱体（壳）均匀源|x y Rmin Rmax zmin zmax|
  +-----------+-----------------------------+-----------------------+

-  **Surface**\ 指定一个在\ **Surface**\ 模块中定义的曲面（仅限球面或者平面）。
   该变量用于定义曲面源。参数为\ **Surface**\ 模块中定义的曲面编号（正整数）或者
   D+正整数。D+正整数表示曲面编号通过\ **Distribution**\ 卡中ID为该正整数的分布来描述。
-  **X**\ 指定坐标x的值，有两种定义形式：
   1. \ **X**\ =x表示\ **X**\ 取固定值x；
   2. \ **X**\ = D+正整数，表示\ **X**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   \ **X**\ 需要和\ **Y、Z**\ 同时使用。
-  **Y**\ 指定坐标y的值，有两种定义形式：
   1. \ **Y**\ =y表示\ **Y**\ 取固定值y；
   2. \ **Y**\ = D+正整数，表示\ **Y**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   \ **Y**\ 需要和\ **X 、Z**\ 同时使用。
-  **Z**\ 指定坐标z的值，有两种定义形式：
   1. \ **Z**\ =z表示\ **Z**\ 取固定值z；
   2. \ **Z**\ = D+正整数，表示\ **Z**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   \ **Z**\ 需要和\ **X、Y**\ 同时使用。
-  **Position**\ 指定直角坐标系下的参考位置坐标，有两种定义形式：
   1. \ **Position**\ =x y z；
   2. \ **Position**\ = D+正整数，表示\ **Position**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   且该分布必须满足\ **type**\ =2（表示该分布描述的对象为坐标或者向量）。
-  **Radius**\ 指定以\ **Position**\ 为球心或者圆心的半径，有两种定义形式：
   1. \ **Radius**\ =非负浮点数，表示半径为该非负浮点数；
   2. \ **Radius**\ = D+正整数，表示\ **Radius**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   该变量在定义球体（壳）体积源或圆柱体（壳）体积源时使用。缺省值为0。
-  **Axis**\ 指定一个位置描述的参考方向，有两种定义形式：
   1. \ **Axis**\ =u v w；
   2. \ **Axis**\ = D+正整数，表示\ **Axis**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   且该分布必须满足\ **type**\ =2（表示该分布描述的对象为坐标或者向量）。该变量在定义
   球面源或者圆柱体（壳）体积源时使用
-  **Extent**\ 指定球面源的抽样位置和球心的连线与\ **AXIS**\ 夹角的余弦值，有两种定义形式：
   1. \ **Extent**\ =浮点数，该浮点数的范围为[0,1]。
   2. \ **Extent**\ = D+正整数，表示\ **Extent**\ 由\ **Distribution**\ 卡中ID为该负整数的分布来描述，
   该分布的取值范围也必须为[0,1]。该变量在定义球体积源或球面源时使用。
-  **Polar**\ 指定位置描述时极向的参考方向，有两种定义形式：
   1. \ **Axis**\ =u v w；
   2. \ **Axis**\ = D+正整数，表示\ **Axis**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   且该分布必须满足\ **type**\ =2（表示该分布描述的对象为坐标或者向量）。该变量在定义
   球面源或者圆柱体（壳）体积源时使用。
-  **PolarTheta**\ 指定抽样位置投影到与\ **Axis**\ 垂直的平面上时，与极向参考方向（\ **Polar**\ ）
   的夹角。有两种定义形式：
   1. \ **PolarTheta**\ =浮点数，该浮点数为弧度制下的角度大小。
   2. \ **PolarTheta**\ = D+正整数，表示\ **PolarTheta**\ 由\ **Distribution**\ 卡中ID为该正整数的分
   布来描述。该变量与**Polar**搭配使用。
-  **Height**\ 指定圆柱体（壳）体积源沿轴线\ **AXIS**\ 的高度，有两种定义形式：
   1. \ **Height**\ =浮点数表示\ **Height**\ 取值为该浮点数；
   2. \ **Height**\ = D+正整数，表示\ **Height**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   该变量在定义圆柱体（壳）体积源时使用。
-  **Norm**\ 指定参考飞行方向\ **Vector**\ 或表面法线的标志，只能为1或-1。1表示与参考飞行方向
   \ **Vector**\ 一致或沿表面法线向外，-1表示与参考飞行方向\ **Vector**\ 相反或沿表面法线向内。缺省值为+1。
-  **Vector**\ 指定粒子飞行的参考方向，有两种定义形式：
   1. \ **Vector**\ =u v w；
   2. \ **Vector**\ = D+正整数，表示\ **Vector**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   且该分布必须满足\ **type**\ =2（表示该分布描述的对象为坐标或者向量）。
-  **DirecMiu**\ 指定粒子飞行方向与参考方向\ **Vector**\ 的夹角的余弦值，有两种定义形式：
   1. \ **DirecMiu**\ =浮点数，该浮点数的范围为[-1.0,1.0]。
   2. \ **DirecMiu**\ = D+正整数，表示\ **DirecMiu**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   该分布的取值范围也必须为[-1.0,1.0]。\ **DirecMiu**\ 必须与\ **Vector**\ 结合使用，不能单独使用。
-  **FaiVector**\ 指定与粒子飞行的参考方向（\ **Vector**\ ）垂直的一个方向，有两种定义形式：
   1. \ **FaiVector**\ =u v w；
   2. \ **FaiVector**\ = D+正整数，表示\ **FaiVector**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，
   且该分布必须满足\ **type**\ =2（表示该分布描述的对象为坐标或者向量）。\ **FaiVector**\ 必须与
   \ **Vector**\ 配合使用，且必须互相垂直。
-  **DirecFai**\ 指定抽样的飞行方向投影到与\ **Vector**\ 垂直的平面上时，与极向参考方向（\ **Polar**\ ）
   的夹角。有两种定义形式：
   1. \ **DirecFai**\ =浮点数，该浮点数为弧度制下的角度大小。
   2. \ **DirecFai**\  = D+正整数，表示\ **DirecFai**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   该变量与\ **FaiVector**\ 搭配使用。
-  **Energy**\ 指定粒子的初始能量，中子允许的能量范围为10-11MeV到20MeV，光子允许的能量范围为1keV到1GeV，
   有两种定义形式：
   1. \ **Energy**\ =能量值（浮点数），该浮点数必须在上述范围内。
   2. \ **Energy**\ = D+正整数，表示\ **Energy**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，该分布
   的取值范围也必须与上述中子或者光子的能量范围一致。缺省值为4MeV。
-  **Cell**\ 指定粒子抽样位置所在的栅元号，有两种定义形式：
   1. \ **Cell**\ =c_0>c_1>...>c_n，c_0>c_1>...>c_n为栅元向量，具体含义会在下面的使用说明中进一步解释。
   2. \ **Cell**\ = D+正整数，表示\ **Cell**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述，此时分布的类
   型必须满足\ **type**\ =3（表示该分布描述的对象为栅元向量）。
-  **SampEff**\ 指定粒子抽样的最低效率，取值必须为（0,1.0）的一个浮点数。当某一次的抽样效率
   低于该值时，程序会报错并自动退出。
-  **Biasfrac**\ 指定每个源的偏倚参数。
-  **Weight**\ 指定源粒子的初始权重，不支持分布描述，只支持单值。
-  **Transform**\ 卡指定源粒子位置、飞行方向的坐标变换（旋转和平移）。坐标变换的参数在\ **Transform**\ 卡中定义。

使用说明：

除了源的份额（Fraction）、粒子的类型（Particle）和粒子的能量（Energy）外，剩下的
变量可分为位置变量（Simple type、Surface、X Y Z、Position、Radius、Axis、Extent、
Polar、PolarTheta、Height）和方向变量（Norm、Vector、DirecMiu、FaiVector、DirecFai）两类，
分别用来定义粒子的初始位置和初始方向；Cell变量指定粒子初始位置所在的栅元，通过栅元向量或分布来定义。

1.位置变量。可通过不同的变量组合来定义具有不同位置分布的初始源。

\ **Simple type**\ 是为了方便用户定义一些简单的均匀体积源，使用起来方便，但是功能相对有限。
\ **Simple type**\ 与其他位置变量是互斥的，不能同时使用。

\ **长方体体积源**\ ：X、Y和Z一起使用，可以用来定义线源、和跟坐标轴平行的平面源以及
长方体体积源。X、Y和Z变量与其他位置变量互斥，不能同时使用。

.. figure:: media/rectangular_source.png
   :name: rectangular_source

   长方体体积源

\ **球体体积源**\ ：Position、Radius、Axis、Extent、Polar、PolarTheta六个变量结合
可以定义球体（壳）体积源，如 :numref:`sphere_source` 所示，Position指定球心的位置，Radius指定半径，
此时Radius需为单值（球面）或用二次函数分布（分布见下文）来描述。Radius的缺省值为0，
此时为点源。Axis定义一个参考方向，Extent指定抽样位置点与球心的连线跟参考方向Axis夹角
的余弦值。Polar定义一个跟Axis垂直的方向，PolarTheta为粒子抽样位置与圆心的连线在与Axis
垂直的平面上的投影，和Polar方向的夹角，即方位角（弧度制表示）。如果Polar和PolarTheta
缺省，则方位角在0到2π上均匀抽样。如果Axis、Extent、Polar、PolarTheta同时缺省，则为
在Surface指定的球面上均匀抽样。

.. figure:: media/sphere_source.png
   :name: sphere_source

   球体体积源

\ **圆柱体体积源**\ ：Position、Radius、Axis、Polar、PolarTheta、Height六个变量结合
可以定义圆柱体（壳）体积源。如 :numref:`cylinder_source` 所示，Position定义在圆柱体（壳）轴向上的参考点，
Radius定义圆柱体（壳）横截面的半径，此时需为单值（圆柱面）或用一次函数分布来描述，
Axis定义圆柱体（壳）轴向的方向向量（不需要单位化），Polar定义一个跟Axis垂直的方向，
PolarTheta为粒子抽样位置所在的横截面上与圆心的连线和Polar的夹角（弧度制表示）。
Height定义沿Axis方向圆柱体（壳）距离点Position的距离，与Axis方向相同为正，相反为负。

.. figure:: media/cylinder_source.png
   :name: cylinder_source

   圆柱体（壳）体积源

\ **平面源**\ ：Surface、Position、Radius三个变量结合可以定义平面源。Surface指定一个
平面（预先在Surface模块中定义），Position指定一个在该平面上的参考点（必须在该平面上），
Radius指定在该平面上以Position为圆心的半径，此时Radius需为单值或一次函数分布。

\ **球面源**\ ：Surface、Axis、Extent、Polar、PolarTheta五个变量结合可以定义球面源。
Surface指定一个球面（预先在Surface模块中定义），Axis定义一个参考方向，Extent指定
球面上的抽样位置点与球心的连线跟参考方向Axis夹角的余弦值。Polar定义一个跟Axis垂直的方向，
PolarTheta为粒子抽样位置与圆心的连线在与Axis垂直的平面上的投影，和Polar方向的夹角，
即方位角（弧度制表示）。如果Polar和PolarTheta缺省，则方位角在0到2π上均匀抽样。
如果Axis、Extent、Polar、PolarTheta同时缺省，则为在Surface指定的球面上均匀抽样。

2.方向变量。

Norm、Vector、DirecMiu、FaiVector、DirecFai五个变量结合来定义粒子的初始飞行方向。
如 :numref:`flying_direction` 所示，Vector 指定一个参考方向，DirecMiu指定与Vector夹角的余弦值，两个变量
结合使用。FaiVector 指定与Vector垂直的参考方向，DirecFai为飞行方向投影到与Vector垂直
的平面上时，与FaiVector的夹角即方位角（弧度制）。FaiVector和DirecFai缺省时，方位角φ
在（0,2π）上均匀抽样。Vector、DirecMiu、FaiVector、DirecFai同时缺省的情况下，如果位置
变量Surface没有定义，则默认飞行方向为各向同性；如果位置变量Surface被定义，则飞行方向
跟抽样位置点所在曲面的法线方向的夹角在（0,π/2）上成余弦分布（p(θ)=cos(θ)或p(μ)= μ），
方位角φ在（0,2π）上均匀抽样。

.. figure:: media/flying_direction.png
   :name: flying_direction

   飞行方向

3.Cell变量。

Cell变量用来指定粒子初始位置所在的栅元，通过栅元向量c_0>c_1>...>c_n或者分布来描述
（此时分布必须使用对应的分布类型）。c_0为基准空间（Universe 0）中的一个栅元，
c_1为填充栅元c_0的空间（Universe）中的一个栅元，依次向下填充，且c_n不一定为最
底层栅元（即c_n依旧可以被其他空间填充）。

需要注意的是，如果未定义Cell变量，则定义的粒子位置和方向为绝对坐标。如果定义了Cell变量，
则定义的粒子位置和方向变为相对坐标，定义的粒子的位置和方向如果在栅元c_n内（此处指
Cell选项卡中直接定义的栅元c_n的范围），则接受该抽样位置和飞行方向，否则，拒绝该抽样
位置和飞行方向，需要重新抽样；之后，接受的抽样位置和飞行方向会随着几何构建时的填充方式
进行旋转和平移，得到最终的粒子位置和飞行方向。

如果填充栅元c_i的空间（Universe I）是重复几何结构，则c_(i+1)应替换为该空间（Universe I）
中重复几何的排列位置坐标。如果该空间为四边形重复几何结构，则该排列位置坐标的形式为（xNum,yNum,zNum），
坐标中的三个元素都必须为正整数，表示从原点开始到目标位置在x,y和z方向的次序；如果该空间为
六边形重复几何结构，则该排列位置坐标的形式为（xNum,yNum）；如果该空间（Universe I）为
重复几何结构，排列位置坐标直接写为0，则表示在空间的重复几何结构中均匀抽取每个单元结构。

例如：四边形重复几何结构中，如果Cell=4>(3 4 1)>8，则4为在基本空间（Universe 0）中的栅元，
栅元4被一个四边形重复几何结构的空间填充，（3 4 1）表示在该四边形重复几何空间中，从坐标
原点数，x方向第三个，y方向第四个，z方向第五个的重复单元所在的填充空间，8表示在重复几何
栅元（3 4 1）处的填充空间中的栅元8。如果抽取的粒子在栅元8的曲面布尔运算所得到的区域内，
则接受该粒子的位置和方向，之后再跟随栅元8所在的空间进行旋转或平移（如果旋转和平移同时存在，
则先以原点为中心进行旋转，再进行平移），填充到重复几何空间中，最后填充到基本空间（Universe 0）中
的栅元4中，得到最终的抽样粒子位置和飞行方向等信息。



Distribution选项卡
~~~~~~~~~~~~~~~~~~~~~~~~~~

\ **Distribution**\ 卡指定\ **Source**\ 卡中描述变量用的所有分布，分布编号要与\ **Source**\ 卡中一致，
分布之间没有先后顺序。每个分布分别用\ **ID、Depend**\ （可缺省）、\ **Type 、Value、Probability**\
（从属于其他分布时可缺省）、\ **Bias**\ （可缺省）来描述，且先后顺序不可改变。

-  **ID**\ 指定分布的编号，与\ **Source**\ 卡中描述变量用的分布编号一致。所有的分布编号相互之间不能重复。

-  **Depend**\ 指定该分布所从属（依赖）的分布（即该分布的值由所从属的分布的抽样值决定，
   不再独立进行抽样）的编号，可支持多层从属关系，但不能出现死锁。独立分布可缺省该变量。
   当定义了该变量时，\ **Probability**\ 和\ **Bias**\ 的定义便没有意义，这两个可缺省。
   关于从属分布，后面会有更多解释。

-  **Type**\ 指定分布的类型，用不同的整数代表不同的反应类型。可取的分布类型见 :numref:`distribution_cards` 。

-  **Value**\ 指定分布的取值范围，参数要求见 :numref:`distribution_cards` 。

-  **Probability**\ 指定分布的概率分布参数，具体要求见 :numref:`distribution_cards` 。

-  **Bias**\ 指定分布的偏倚抽样概率分布参数，具体要求见 :numref:`distribution_cards` 。

.. table:: Distribution卡支持的分布类型及参数
  :name: distribution_cards

  +--------+-----------------+------------------+-----------------+-----------------+
  |Type    |Value            |Probability       |Bias             |说明             |
  +========+=================+==================+=================+=================+
  |0       |n\ :sub:`1`\     |p\ :sub:`1`\      |b\ :sub:`1`\     |子分布           |
  |        |n\ :sub:`2`\     |p\ :sub:`2`\      |b\ :sub:`2`\     |                 |
  |        |n\ :sub:`3`\  …  |p\ :sub:`3`\  …   |b\ :sub:`3`\  …  |                 |
  |        |n\ :sub:`i`\  …  |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示子分布，Value的每一个值（正整数）是一个分布编号，该分布编号不能是自身,要避免 |
  |出现死锁。p\ :sub:`i`\ 和b\ :sub:`i`\ 分别是n\ :sub:`i`\ 出现的真实概率和偏倚抽样|
  |概率。Probability、Bias的取值个数必须和Value的取值个数一致。                     |
  +--------+-----------------+------------------+-----------------+-----------------+
  |1       |a\ :sub:`1`\     |p\ :sub:`1`\      |b\ :sub:`1`\     |离散值分布       |
  |        |a\ :sub:`2`\     |p\ :sub:`2`\      |b\ :sub:`2`\     |                 |
  |        |a\ :sub:`3`\  …  |p\ :sub:`3`\  …   |b\ :sub:`3`\  …  |                 |
  |        |a\ :sub:`i`\  …  |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示离散值分布，Value变量定义可取的离散值（浮点数类型）。p\ :sub:`i`\ 和         |
  |b\ :sub:`i`\ 分别是a\ :sub:`i`\ 出现的真实概率和偏倚抽样概率。Probability、Bias的|
  |取值个数必须和Value的取值个数一致。                                              |
  +--------+-----------------+------------------+-----------------+-----------------+
  |2       |x\ :sub:`1`\     |p\ :sub:`1`\      |b\ :sub:`1`\     |位置或矢量离散值 |
  |        |y\ :sub:`1`\     |p\ :sub:`2`\      |b\ :sub:`2`\     |分布             |
  |        |z\ :sub:`1`\  …  |p\ :sub:`3`\  …   |b\ :sub:`3`\  …  |                 |
  |        |x\ :sub:`i`\  …  |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  |        |y\ :sub:`i`\  …  |                  |                 |                 |
  |        |z\ :sub:`i`\  …  |                  |                 |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示位置或矢量离散值分布，Value变量定义可取位置或矢量的离散值（浮点数类型）。    |
  |p\ :sub:`i`\ 和b\ :sub:`i`\分别是（x\ :sub:`i`\ ,y\ :sub:`i`\ ,z\ :sub:`i`\ ）出 |
  |现的真实概率和偏倚抽样概率。Value的取值个数必须是3的整数倍，Probability、Bias的取|
  |值个数必须和Value的取值个数的1/3一致。                                           |
  +--------+-----------------+------------------+-----------------+-----------------+
  |3       |Cell_vector1     |p\ :sub:`1`\      |b\ :sub:`1`\     |栅元向量离散值分 |
  |        |Cell_vector2 …   |p\ :sub:`2`\  …   |b\ :sub:`2`\  …  |布               |
  |        |Cell_vectori …   |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示栅元向量离散值分布，Value变量定义可取的栅元向量（上文已介绍）。p\ :sub:`i`\  |
  |和b\ :sub:`i`\分别是a\ :sub:`i`\ 出现的真实概率和偏倚抽样概率。Probability、Bias |
  |的取值个数必须和Value的取值个数一致。                                            |
  +--------+-----------------+------------------+-----------------+-----------------+
  |4       |a\ :sub:`0`\     |p\ :sub:`1`\      |b\ :sub:`1`\     |区间均匀分布     |
  |        |a\ :sub:`1`\     |p\ :sub:`2`\      |b\ :sub:`2`\     |                 |
  |        |a\ :sub:`2`\     |p\ :sub:`3`\  …   |b\ :sub:`3`\  …  |                 |
  |        |a\ :sub:`3`\  …  |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  |        |a\ :sub:`i`\  …  |                  |                 |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示区间均匀分布，Value变量定义每个区间的边界值（浮点数类型）。p\ :sub:`i`\ 和   |
  |b\ :sub:`i`\分别是区间（a\ :sub:`i-1`\,a\ :sub:`i`\）的真实概率和偏倚抽样概率。  |
  |Probability、Bias的取值个数必须比Value的取值个数少1。                            |
  +--------+-----------------+------------------+-----------------+-----------------+
  |5       |a\ :sub:`1`\     |p\ :sub:`1`\      |b\ :sub:`1`\     |分段线性插值分布 |
  |        |a\ :sub:`2`\     |p\ :sub:`2`\      |b\ :sub:`2`\     |                 |
  |        |a\ :sub:`3`\  …  |p\ :sub:`3`\  …   |b\ :sub:`3`\  …  |                 |
  |        |a\ :sub:`i`\  …  |p\ :sub:`i`\  …   |b\ :sub:`i`\  …  |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |表示线性插值分布，Value变量定义插值点（浮点数类型）。p\ :sub:`i`\ 和b\ :sub:`i`\ |
  |分别是插值点a\ :sub:`i`\ 的真实概率和偏倚抽样概率。Probability、Bias的取值个数必 |
  |须比Value的取值个数一致。在两个插值点之间，真实概率和偏倚抽样概率分别满足线性插值|
  +--------+-----------------+------------------+-----------------+-----------------+
  |-1      |x\ :sub:`0`\     |a\ :sub:`p`\      |a\ :sub:`b`\     |幂函数分布       |
  |        |x\ :sub:`1`\     |                  |                 |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |幂函数分布p(x)=c|x|\ :sup:`a`\ ，分布的取值范围为（x\ :sub:`0`\，x\ :sub:`1`\ ） |
  |（一定要满足x\ :sub:`0`\<x\ :sub:`1`\），a\ :sub:`p`\ 和a\ :sub:`b`\ 分别为真实幂|
  |函数和偏倚抽样幂函数的指数，如果x\ :sub:`0`\ •x\ :sub:`1`\ ≤0，则必须满足a>-1。系|
  |数c会由程序自动进行归一化处理，用户不需要输入。当a=0时，为（x\ :sub:`0`\，       |
  |x\ :sub:`1`\ ）上的均匀分布。                                                    |
  +--------+-----------------+------------------+-----------------+-----------------+
  |-2      |x\ :sub:`0`\     |a\ :sub:`p`\      |a\ :sub:`b`\     |指数函数分布     |
  |        |x\ :sub:`1`\     |                  |                 |                 |
  +--------+-----------------+------------------+-----------------+-----------------+
  |指数函数分布p(x)=ce\ :sup:`ax`\ ，分布的取值范围为（x\ :sub:`0`\，x\ :sub:`1`\） |
  |（一定要满足x\ :sub:`0`\<x\ :sub:`1`\ ），a\ :sub:`p`\ 和a\ :sub:`b`\ 分别为真实 |
  |指数函数和偏倚抽样指数函数的指数系数。系数c会由程序自动进行归一化处理，用户不需要|
  |输入。当a=0时，为（x\ :sub:`0`\，x\ :sub:`1`\ ）上的均匀分布。                   |
  +--------+-----------------+------------------+-----------------+-----------------+
  |-3      |                 |a                 |                 |麦克斯韦裂变谱   |
  +--------+-----------------+------------------+-----------------+-----------------+
  |麦克斯韦裂变能量谱分布p(E)=CE\ :sup:`1/2`\ e\ :sup:`(-E/a)`\ ，其中a是温度，单位 |
  |是MeV，a的缺省值为1.2895MeV。暂不支持偏倚抽样。                                  |
  +--------+-----------------+------------------+-----------------+-----------------+
  |-4      |                 |a b               |                 |瓦特裂变谱       |
  +--------+-----------------+------------------+-----------------+-----------------+
  |麦克斯韦裂变能量谱分布 :math:`p(E)=Ce^(-E/a)\sinh \sqrt{bE}`，其中a单位是MeV,缺省|
  |值为0.965MeV，b单位是MeV-1，缺省值为2.29 MeV-1。暂不支持偏倚抽样。               |
  +--------+-----------------+------------------+-----------------+-----------------+
  |-5      |                 |a b               |                 |高斯聚变谱       |
  +--------+-----------------+------------------+-----------------+-----------------+
  |高斯聚变能量谱分布 :math:`p(E)=Ce^(-((E-b)/a)^2)`，其中a是能谱宽度，b是平均能量，|
  |单位均是MeV，这里能谱宽度的定义是当E比b大ΔE时，指数函数项等于e\ :sup:`-1`\ 。如果|
  |a<0，则认为是以MeV为单位表示的温度，此时b也必须为负值。如果b=-1，则计算D-T聚变反 |
  |应能量作为b的值。如果b=-2，则计算D-D聚变反应能量作为b的值。请注意：a并不是半高宽 |
  |（FWHM,full-width-at-half-maximum），a和半高宽的计算公式为FWHM=a(ln2)\ :sup:`1/2`|
  |。暂不支持偏倚抽样。缺省值：a=-0.01，b=-1（在10keV下发生的DT聚变反应能谱）。     |
  +--------+-----------------+------------------+-----------------+-----------------+
  |-6      |                 |a                 |                 |蒸发能量谱       |
  +--------+-----------------+------------------+-----------------+-----------------+
  |蒸发能量谱 :math:`p(x)=CEe^(-E/a)`，a的单位为MeV，缺省值为1.2895MeV。暂不支持偏倚|
  |抽样。                                                                           |
  +--------+-----------------+------------------+-----------------+-----------------+

-  需要指出的是，只有\ **Type**\ =0,1,2,3,4的分布之间才可以相互依赖。从属的分布抽样值由
   被从属的分布的抽样位置决定，二者具有相同的抽样位置，因此从属的分布\ **Porbability**\ 和\ **Bias**\
   的定义是没有实际意义的，可以缺省不定义。这里被从属的分布的抽样位置分为两类：
   1. 当\ **Type**\ =0,1,2时，如果抽样值为ni，ai或者xi,yi,zi），则抽样位置为i。
   2. 当\ **Type**\ =3时，抽样值落在区间（a\ :sub:`i-1`\ ,a\ :sub:`i`\ ），则抽样位置为i。
   在定义从属分布时，用户需要保证从属分布和被从属的分布的抽样位置总数必须相等，否则程序会报错。


SurfSrcRead选项卡
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

     SurfSrcRead  OldSurf=< S1 S2 S3……Sn >  NewSurf = < S11 S21 S31…Sm1…Smn >
                  Cell=<cell_vector_group>  Partype=<params>   Coli=<coli>  Wtm=<wtm>
                  Axis=<x1 x2 x3>   Extent=<id>  Posace=<posace>  Tr=<id>


其中，

-  **OldSurf**\ 通过指定原来计算中的面，来表示使用穿过这些面的粒子径迹。
   缺省表示使用原来计算中所有的面
-  **NewSurf**\ 指定原来的面在新的计算中所对应的面。其中一个面可以对应多个面即
   该输入卡中的面的个数，必须是\ **OldSurf**\ 卡中的面个数的整数倍。当缺省时，默认使用
   \ **oldsurf**\ 中的面；如果一个面对应多个面，必须在TR中定义对应的关系，两个面大小应当相同。
-  **Cell**\ 通过指定原来计算中的栅元，来表示使用这些栅元中的径迹。
-  **Partype**\ 指定使用的径迹粒子类型，0代表中子，1代表光子。默认包含接续
   面源文件中包含的径迹类型。
-  **Coli**\ 是指定使用的径迹的碰撞类型，-1表示仅选择没有经历碰撞的径迹，0表示任意径迹都记录，
   1表示仅记录经历碰撞的径迹。缺省值为0；
-  **Wtm**\ 指定选择的径迹的权重所乘以的倍数。
-  **Axis，Extent，Posace**\ 仅能在输出接续计算文件相应计算\ **SYMM**\ =0情况下使用。
   \ **Axis**\ 代表定义的轴向，\ **Extent**\ 对指定沿轴向的粒子的偏倚操作，具体在\ **Distribution**\ 卡中定义；
   其都有两种定义形式：
   1. \ **Axis**\ =u v w；
   2. \ **Axis**\ = D+正整数，表示\ **Axis**\ 由\ **Distribution**\ 卡中ID为该正整数的分布来描述。
   \ **Posace**\ 选择与\ **Axis**\ 对应轴向指定余弦内的粒子。
-  **Tr**\ 指定面面对应关系。当输入为正时，表示相应的对应关系，即空间变换关系。
   如果是D+正整数，则表示相应的偏倚操作：其定义为D+正整数时，正整数的值表示对应的\ **Distribution**\ 卡中定义的用户索引号，
   其仅支持离散值的分布，而后会根据相应的\ **Distribution**\ 卡内Type=1内的离散值 定义来进行相应的偏移操作。



Transform选项卡
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: none

     Transform  ID  Rotate=<a11 a12 a12 a21……a33>  Move=<x1 x2 x3>


Transforma卡定义源定义的坐标变换。ID为坐标变换的编号和Source卡或SurfSrcRead卡定义
的Transform变量的序号一一对应。Rotate 定义坐标变换的旋转矩阵，Move定义坐标变换的平移向量。

旋转变换可以绕任意轴，其表达式为：

.. math::

    \mathbf{r'} = \mathbf{R} \cdot \mathbf{r}

其中， :math:`\mathbf{R}` 为旋转变换矩阵。

平移变换的表达式为：

.. math::

    \mathbf{r'} = \mathbf{r} + \mathbf{m}

其中， :math:`\mathbf{r}=(r_x,r_y,r_z)` 和 :math:`\mathbf{r}=(r_x',r_y',r_z')` 分
别为变换前和变换后的空间任意一点的位置坐标， :math:`\mathbf{m}=(m_x,m_y,m_z)` 为
平移变换向量。


源描述模块输入示例
-----------------------

-  **Simple type**\ 定义均匀体积源

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =1  Particle = 1  Point=0 0 0 1 1 0  Vector = 1 0 0
             DirecMiu = 0  FaiVector = 0 1 0  DirecFai = 0  Energy = 4


该示例定义了一个点源，粒子类型为中子。点源的位置从（0,0,0）和（1,1,0）两个位置中
均匀抽样；参考飞行方向为（1,0,0,），粒子飞行方向与该参考方向夹角的余弦值为0，
方位角参考方向为（0,1,0），飞行方向在与Vector垂直且与方位角参考方向（0,1,0）平行
的平面上的投影与方位角参考方向（0,1,0）夹角为0，即粒子飞行方向为（0,1,0）；粒子的
初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =1  Particle = 2  Sphere=0 0 0 1 2  Energy = 4


该示例定义了一个球壳均匀分布源，粒子类型为光子，球心为（0,0,0），半径为（1,2），
源粒子的位置从该球壳中按照体积均匀抽样。粒子初始飞行方向为各向同性，粒子的初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  Cyl/x=1 2 0 1 -5 5  Vector = 1 0 0  DirecMiu = 0  Energy = 4


该示例定义了一个平行于x轴的圆柱体体积源，粒子类型为中子，圆柱体的轴线沿x方向，
轴线在yz平面上的位置为（1,2），横截面的半径为（0,1），圆柱体x坐标的取值范围为（-5,5），
参考飞行方向为（1,0,0,），粒子飞行方向与该参考方向夹角的余弦值为0，即粒子的飞行方向
与参考方向（1,0,0）垂直，方位角在（0,2π）上均有抽样，粒子的初始能量为4MeV。


-  使用\ **X**，**Y**\ 和\ **Z**\ 变量定义长方体体积源

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  X=d1  Y=d2  Z=d3
    Distribution  1  type=4  value= -1 1  probability=1
    Distribution  2  type=4  value= 0 2  probability=1
    Distribution  3  type=4  value= 5 6  probability=1


该示例定义了一个长方体体积源，粒子类型为中子，x在（-1,1）上均匀抽样，y在（0,2）
上均匀抽样，z在（5,6）上均匀抽样，粒子的初始飞行方向为各向同性，初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  X=0  Y=d2  Z=5
    Distribution  2  type=4  value=0 2  probability=1


该示例定义了一个均匀线源，粒子类型为中子，x=0，y在（0,2）上均匀抽样，z=5，粒子的
初始飞行方向为各向同性，初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  X=d1  Y=d2  Z=5  Energy= d3
    Distribution  1  Type= 1  Value=0 1  Probability=1 2
    Distribution  2  Type= 4  Value=2 3  Probability=1
    Distribution  3  Type= -3


该示例定义了一个广义长方体体积源，粒子类型为中子，x取值为0或1，对应的抽样概率分别
为1/3和2/3，y在（2,3）上均匀抽样，z取值为5，粒子的初始飞行方向为各向同性，初始能量
分布服从麦克斯韦裂变谱（参数a取缺省值1.2895MeV）。


-  使用\ **Position、Radius、Axis、Extent、Polar**\ 和\ **PolarTheta**\ 六个变量定义球体体积源

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  Positioin=0 1 0  Radius=d1 Energy=d2
    Distribution  1  Type= -1  Value=0 5  Probability=2
    Distribution  2  Type= -4  Probability=1 2


该示例定义了一个均匀球体积源，粒子类型为中子，球心为（0,1,0），Radius在（0,5）上按二
次函数分布进行抽样（按体积进行均匀抽样），粒子的初始飞行方向为各向同性，初始能量分布
服从瓦特裂变谱（参数a为1MeV，b为2MeV-1）。

.. code-block:: c

    EXTERNALSOURCE
    Source 1  particle=1 fraction=0.5 position=0 0 0 radius=d1 axis=0 0 1 extent=d2
              polar=1 1 0  polartheta=d3  energy=4
    Distribution  1  type=-1  value=0 5  probability=2
    Distribution  2  type=4  value=0 1  probability=1
    Distribution  3  type=4  value=-0.7853981633974475  0.7853981633974475 probability=1


该示例定义了一个1/8均匀球体积源，粒子类型为中子，球心为（0,1,0），Radius在（0,5）上按二次
函数分布进行抽样（按体积进行均匀抽样）,粒子的抽样位置跟方向（0,0,1）的夹角的余弦值为（0,1）
上均匀分布，粒子抽样位置与球心的连线在与方向（0,0,1）垂直的平面上的投影和方向（1,1,0）的夹
角为（-π/4，π/4）上均匀分布，即1/8均匀球体积源;粒子的初始飞行方向为各向同性，初始能量为4MeV。


-  使用\ **Position、Radius、Axis、Polar、PolarTheta、Height**\ 六个变量结合定义圆柱体体积源

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  Positioin=0 1 0  Axis= 0 0 1 Radius=d1  Height=d2
    Distribution  1  Type= -1  Value=0 2  Probability=1
    Distribution  2  Type= 4  Value=-5 5  Probability=1


该示例定义了一个均匀圆柱体体积源，粒子类型为中子，轴向沿z轴方向，轴线上的参考点为（0,1,0），
Radius在（0,2）上按一次函数分布进行抽样，Height在（-5,5）上均匀抽样，上述即为按体积进行均匀
抽样，粒子的初始飞行方向为各向同性，初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source 1  particle=1  fraction=0.5  position=0 0 0  energy=4  axis=0 0 1
              polar=1 0 0  polartheta=d3  radius=d1  height=d2
    Distribution  1  type=-1 value=0 10  probability=1
    Distribution  2  type=4 value=-5 5  probability=1
    Distribution  3  type=4 value=0 1.570796326794895 probability=1


该示例定义了一个均匀1/4圆柱体体积源，粒子类型为中子，轴向沿z轴方向，轴线上的参
考点为（0,1,0），Radius在（0,2）上按一次函数分布进行抽样，在横截面上，参考方向
为（1,0,0），粒子抽样位置与圆心的连线和参考方向的夹角在（0，π/2）上均匀抽样，
Height在（-5,5）上均匀抽样，上述即为按1/4圆柱体积进行均匀抽样，粒子的初始飞行
方向为各向同性，初始能量为4MeV。


-  使用\ **Surface、Position、Radius**\ 三个变量结合可以定义平面源

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  Surf=5  Positioin=0 1 0 Radius=d1
    Distribution  1  Type= -1  Value=0 2  Probability=1


该示例定义了一个均匀圆形平面源（5号曲面是在几何模块中预先定义的平面），粒子类型
为中子，平面上的参考点为（0,1,0），Radius在（0,2）上按一次函数分布进行抽样，
粒子的初始飞行方向和平面法向的夹角在（0,π/2）内成余弦分布，初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source 1  particle=1  fraction=0.5  surface=1  energy=4


该示例定义了一个均匀球面源（1号曲面是在几何模块中预先定义的球面），粒子类型为
中子。初始能量为4MeV。

.. code-block:: c

    EXTERNALSOURCE
    Source 1  particle=1 fraction=0.5 surface=1 axis=0 0 1 extent=d1 polar=1 0 0 polartheta=d2  energy=4
    Distribution  1  type=4  value=0  1  probability=1
    Distribution  2  type=4  value=0  1.570796326794895  probability=1


该示例定义了一个1/8均匀球面源（1号曲面是在几何模块中预先定义的球面），粒子类型为
中子，参考方向为（0,0,1），粒子抽样位置与球心的连线和参考方向的夹角余弦值在（0,1）
上均匀分布，方位角的参考方向为（1,0,0），粒子抽样位置与球心的连线在与参考方向
（0,0,1）垂直的平面上的投影和参考方向（1,0,0）的夹角在（0,π/2）上均匀分布。初始能量为4MeV。


-  重复几何结构圆柱体体积源（Cell变量的使用）

.. code-block:: c

    UNIVERSE 0
    CELL 1   -1 : 2 : -3 : 4   mat = 0   imp:n=0   // rectangle outside
    CELL 2   1 & -2 & 3 & -4   fill = 1   imp:n=1      // rectangle inside

    UNIVERSE 1  lat =1 pitch=10 10 0  scope = 3 3 1 fill =
        2 2 2
        2 2 2
        2 2 2

    UNIVERSE 2  move = 5 5 0
    CELL 3   -5 : 6 : -7 : 8   mat = 0   imp:n=0   // rectangle outside
    CELL 4   5 & -6 & 7 & -8   mat = 1   vol=1   imp:n=1   // rectangle inside

    SURFACE
    surf  1  px    0
    surf  2  px   30
    surf  3  py    0
    surf  4  py   30
    surf  5  px   -5
    surf  6  px   5
    surf  7  py   -5
    surf  8  py   5
    surf  10  px   10

    MATERIAL
    mat 1  -2.52
           5010.60c   4
           5011.60c   16
           6000.60c   5

    FixedSource
    particle  population = 10000000

    ParticleMode n

    EXTERNALSOURCE
    Source 1 fraction=0.5 position=d1 energy=4 axis=0 0 1 radius=d2 height=d3
    distribution  1  type=2
    value=5 5 0 5 15 0 5 25 0 15 5 0 15 15 0 15 25 0 25 5 0 25 15 0 25 25 0
    probability=1 1 1 1 1 1 1 1 1
    Distribution  2  type=-1  value=0 3  probability=1
    Distribution  3  type=4  value=-5 5  probability=1


该示例定义了一个3×3网格内均匀排布的9个相同尺寸的圆柱体体积源。如果采用Cell
变量定义则更加简洁，如：

.. code-block:: c

    EXTERNALSOURCE
    Source 1 fraction=0.5 position=0 0 0 energy=4 axis=0 0 1 radius=d2 height=d3 cell=2>0>4
    distribution  2  type= -1  value=0 3  probability=1
    Distribution  3  type=4  value=-5 5  probability=1


或者Cell变量通过使用分布来描述：

.. code-block:: c

    EXTERNALSOURCE
    Source 1 fraction=0.5 position=0 0 0 energy=4 axis=0 0 1 radius=d2 height=d3 cell=d1
    distribution  1  type=3  value=2>(1 1 1)>4  2>(1 2 1)>4  2>(1 3 1)>4  2>(2 1 1)>4  2>(2 2 1)>4  2>(2 3 1)>4  2>(3 1 1)>4  2>(3 2 1)>4  2>(3 3 1)>4  probability=1 1 1 1 1 1 1 1 1
    Distribution  2  type= -1  value=0 3  probability=1
    Distribution  3  type= 4  value=-5 5  probability=1


-  从属分布和子分布使用示例

.. code-block:: c

    EXTERNALSOURCE
    Source 1 fraction=0.5 position=d1 energy=4 axis=0 0 1 radius=d2 height=d3
    distribution  1  type=2  value=5 5 0  5 15 0  probability=1 1
    Distribution  2  depend=1  type=0  value=4  5
    Distribution  3  type=3  value=-5 5  probability=1
    Distribution  4  type= -1  value=0 3  probability=1
    Distribution  5  type= -1  value=0 5  probability=1


该示例定义了两个尺寸相异的圆柱体体积源，半径分别为3厘米和5厘米。需要指出的是，
2号分布依赖于1号分布（指定圆柱轴线上的参考点），2号分布类型为子分布，两个子
分布（分别为4号和5号分布）的概率都为0.5（由1号分布决定）。


-  接续面源文件使用示例

.. code-block:: c

    SurfSrcRead  OldSurf=1 2 NewSurf = 1 2
    Cell= 3 Partype=0 Coli=1 Wtm=1.0


该示例使用原来面序号为12的面上的中子径迹，和栅元3中的中子径迹。权重乘子为1，且为碰撞后径迹。


-  坐标变换使用示例

.. code-block:: c

    EXTERNALSOURCE
    Source   1  Fraction =0.5  Particle = 1  Positioin=0 1 0  Axis= 0 0 1 Radius=d1  Height=d2  Transform=1
    Distribution  1  Type= -1  Value=0 2  Probability=1
    Distribution  2  Type= 4  Value=-5 5  Probability=1
    Transform   1   rotate= 0 0 -1 0 1 0 1 0 0  move=0.5 0.5 1


该示例对一个圆柱体体源进行了旋转和平移，先按照旋转矩阵 :math:`\begin{bmatrix} 0 &0 &-1 \\ 0
& 1 &0 \\ 1 & 0 &0 \end{bmatrix}` 进行旋转，再按照平移向量（0.5 0.5 1）进行平移。
注意：如果同时定义坐标旋转和坐标平移，则先进行坐标旋转，后进行坐标平移。


中子输运计算
====================

RMC目前支持中子-光子-电子耦合输运计算

中子输运计算物理开关
--------------------------

.. code-block:: none

    Physics
    ParticleMode < particle type >
    Neutron MinEnergy=<params>


其中，

-  **Physics**\ 为中子输运计算物理开关的关键词；

-  **ParticleMode**\ 表示粒子输运计算物理开关对应的粒子类型，N代表中子、P代表光子、E代表电子；

-  **Neutron**\ 为中子物理过程子选项卡的关键字。

-  **MinEnergy**\ 中子输运最低能量，单位为MeV，默认值1.0E-20。如果输运过程中中子能量低于MinEnergy，则中子被杀死。

|

光子输运计算
====================

RMC目前支持中子-光子-电子耦合输运计算

光子输运计算物理开关
--------------------------

.. code-block:: none

    Physics
    ParticleMode < particle type >
    Photon PPRODUCEE=<params> TTB=<params> ANNIHILATION=<params> COHERENT=<params> PHOTONNUCLEUS=<params> DOPPLER=<params> UPERERG=<params> ERGCUTGMA=<params> ELECMULTITIMES=<params>



其中，

-  **Physics**\ 为中子-光子-电子耦合输运计算物理开关的关键词；

-  **ParticleMode**\ 表示粒子输运计算物理开关对应的粒子类型，N代表中子、P代表光子、E代表电子；

-  **Photon**\ 指定粒子输运物理开关对应的光子输运的物理开关的标志；

-  **PPRODUCEE**\ 指定光子输运过程中是否生成电子，1表示生成电子、0表示不生成电子。默认等于0，即默认不开启；

-  **TTB**\ 指定光子输运过程中是否采用TTB模型处理电子，1表示采用TTB模型、0表示不采用TTB模型，默认等于0，即默认不开启；

-  **ANNIHILATION**\ 暂时不涉及，指定光子输运过程中是否采用ANNIHILATION模型处理电子，1表示采用ANNIHILATION模型、0表示不采用ANNIHILATION模型，默认等于0，即默认不开启；

-  **COHERENT**\ 指定光子输运过程中是否处理汤普逊散射，1表示处理汤普逊散射、0表示不处理汤普逊散射，默认等于1，即默认开启；

-  **PHOTONNUCLEUS**\ 指定光子输运过程中是否处理光核反应，1表示处理光核反应、0表示不处理光核反应，默认等于0，即默认不开启；

-  **DOPPLER**\ 指定光子输运过程中是否处理多普勒展宽，1表示处理多普勒展宽、0表示不处理多普勒展宽，默认等于0，即默认不开启；

-  **UPERERG**\ 指定光子输运过程中的能量分界值，大于能量分界值，则进行简易模式的光子输运，单位是MeV，默认值是100Mev；

-  **ERGCUTGMA**\ 指定光子输运过程中的能量下限，单位是MeV，默认值是1.0E-03Mev;

-  **ELECMULTITIMES**\ 指定光子输运过程中产生电子的倍增因子，默认为1.0。



光子输运计算物理开关输入示例
-----------------------------------

固定源释放10000个源中子，固定源为点源，位于坐标原点，源中子能量为0.1 MeV。
纯光子输运计算，光子输运过程不产生电子，也不采用TTB模型处理电子，处理汤普逊散射和光核反应，不进行多普勒展宽的操作，能量上限为100MeV，能量下限是1.0E-3，光子输运产生电子的倍增因子为1.0

.. code-block:: c

    Physics
    ParticleMode p
    Photon  PPRODUCEE = 0  TTB = 0  ANNIHILATION = 0  COHERENT = 1 PHOTONNUCLEUS =1  DOPPLER = 0  UPERERG = 100 ERGCUTGMA = 1.0E-3  ELECMULTITIMES = 1.0

|


电子输运计算
====================

电子输运计算物理开关
--------------------------

.. code-block:: none

    Physics
    ParticleMode < particle type >
    Electron MaxEnergy=<params> MinEnergy=<params> EPRODUCEP=<params>  ErgLossStraggle=<params> BREMS=<params> BREMSANGLE=<params>  BREMSEACHSUBTEP=<params> BREMSERGLOSSMETHOD=<params>  BREMSPHOTONMULTITIMES=<params> XRAYMULTITIMES=<params> KNOCKONMULTITIMES=<params>



其中，

-  **Physics**\ 为中子-光子-电子耦合输运计算物理开关的关键词；

-  **ParticleMode**\ 表示粒子输运计算物理开关对应的粒子类型，N代表中子、P代表光子、E代表电子；

-  **Electron**\ 为电子物理过程子选项卡的关键字。

-  **MaxEnergy**\ 电子输运最高能量，单位为MeV。默认值100。目前RMC数据库要求MaxEnergy不能大于100.如果输运过程中电子能量大于MaxEnergy，则会报错。

-  **MinEnergy**\ 电子输运最低能量，单位为MeV，默认值1.0E-3。如果输运过程中电子能量低于MinEnergy，则电子被杀死。

-  **ErgLossStraggle**\ 阻止本领是否波动。默认值为1，波动。若不波动，则在确定材料中确定能量电子的阻止本领为定值。

-  **BREMS**\ 是否考虑韧致辐射导致的电子。

-  **BREMSANGLE**\ 是否详细抽样次级韧致辐射光子的方向。默认为1，详细抽样。设置为0，则简单抽样。

-  **BREMSPHOTONMULTITIMES**\ 一次韧致辐射过程中，产生的次级韧致辐射光子的数量。应为大于等于0的实数，默认值1。次级韧致辐射光子的权重会相应除以BREMSPHOTONMULTITIMES。大于1时可减少次级韧致辐射光子的方差，小于1时可减少次级韧致辐射光子的模拟时间。

-  **BREMSEACHSUBTEP**\ 是否在每一个射程子步强制产生次级韧致辐射光子。可设置为0或者1。默认值为0。若设置为1，则要求BREMSPHOTONMULTITIMES=1，同时次级韧致辐射光子的权重会做等期望调整。

-  **BREMSERGLOSSMETHOD**\ 控制电子因韧致辐射导致的能量损失的计算方法，可设置为0,或者1。默认值1。1代表使用第一个韧致辐射光子的能量计算电子能量损失，0代表使用所有韧致辐射光子能量的平均值计算电子能量损失。

-  **XRAYMULTITIMES**\ 一次X射线荧光或者俄歇电子产生过程中，产生的次级X射线荧光或者俄歇电子的数量。应为大于等于0的实数，默认值1。次级X射线荧光或者俄歇电子的权重会相应除以XRAYMULTITIMES。大于1可减少次级X射线荧光或者俄歇电子的方差，小于1时可减少次级X射线荧光或者俄歇电子的模拟时间。

-  **KNOCKONMULTITIMES**\ 一次击出电子过程中，产生的次级击出电子的数量。应为大于等于0的实数，默认值1。次级击出电子的权重会相应除以XRAYMULTITIMES。可减少击出电子次级的方差。大于1可减少击出电子的方差，小于1时可减少击出电子的模拟时间。击出电子数量多，打开开关后输运时间增加大约两个小时。




电子输运计算物理开关输入示例
-----------------------------------

光电子耦合输运计算，电子能量上限100Mev，下限0.001Mev，电子输运过程产生光子，阻止本领波动，产生韧致辐射电子，详细抽样次级韧致辐射光子的方向，
不在每一个射程子步强制产生次级韧致辐射光子，使用第一个韧致辐射光子的能量计算电子能量损失，一次X射线荧光或者俄歇电子产生过程中产生1个次级X射线荧光或者俄歇电子，不产生击出电子

.. code-block:: c

    Physics
    ParticleMode P E
    Photon    PPRODUCEE=1  TTB=0  ANNIHILATION=0  COHERENT=1
              PHOTONNUCLEUS=0  DOPPLER=1  UPERERG=100  ERGCUTGMA=1.0E-3  ELECMULTITIMES=1.0
    Electron  MaxEnergy=100  MinEnergy=1.0E-3  EPRODUCEP=1  ErgLossStraggle=1  BREMS=1
              BREMSANGLE=1  BREMSEACHSUBTEP=0  BREMSERGLOSSMETHOD=1  BREMSPHOTONMULTITIMES=1.0
              XRAYMULTITIMES=1.0  KNOCKONMULTITIMES=0.0

|


均匀化群常数（仅限企业版本）
=================================

RMC具备群常数产生功能，可以进行组件或者栅元均匀化计算，为堆芯程序提供均匀化少群常数。

目前RMC均匀化功能包含少群常数产生模块、并群并区模块、B1修正模块、SPH等效修正模块以及堆芯耦合接口模块；
在随机介质输运的基础上具备随机几何均匀化少群常数产生功能。

群常数模块输入卡
-----------------------

.. code-block:: none

    GroupConstant
    Universe =<UnivIndexU>
    Energy=<ErgBin>
    Wims=<Params>
    Bone=<Params>
    Equivalence=<EquivalenceMethod> <Params>
    Hybrid=<Params>
    Angular=<Params>
    Volume=<Params>


其中，

-  **GroupConstant**\ 为均匀化群常数输入卡的关键词；

-  **Universe**\ 为均匀化计算目标对象的空间ID，与CSG几何中的空间编号保持一致；

-  **Energy**\ 为均匀化少群常数的能群结构，默认的能群结构为以0.625ev为分界能的2群结构，
   用户也可以输入具体的能量值作为分界能进行能群划分。需要指出的是能群分界能以升序方式输入；

-  **Wims**\ 关键词用来指示是否使用两步法来进行均匀化计算，默认开启，即Wims=1；
   Wims=0表示一步法计算少群常数。其中默认细群结构采用69群WIMS能群结构；

-  **Bone**\ 关键词表示是否进行B1修正处理。Bone=1表示开启，Bone=0表征不采用B1修正计算处理，B1修正针对单组件全反射模型，默认开启；

-  **Equivalence**\ 关键词表示是否进行等效修正计算，Equivalence=0表示不使用等效修正；Equivalence=1表示计算组件不连续因子，
   此时后面的<Paras>需要用户输入组件类型，1表示四边形组件，2表示六边形组件，目前软件仅支持四边形组件计算；Equivalence=2表示
   超级均匀化处理，此时后面的<Paras>需要用户输入SPH的迭代次数；
   注意: **SPH计算对单区域无效，单区域SPH因子为1。程序支持用户在Universe卡输入包含lattice结构的单个区域，此时程序在用户开启**
   **SPH时会自动搜索包含的最上层lattice，并对其展开分别为每一个cell统计群常数，该扩展区域采用一步法，不进行B1修正。**
   **若Universe卡输入多个区域，则SPH不会对这些区域进行展开。**
   **SPH功能同时也会输出 <输入文件名_SPH.h5> 文件，里面包含每个区域的通量以及体积，**
   **输入输出文件可以参考test目录下的 TwoFuelRod_SPH 以及 Assembly_SPH两个算例。**

-  **Hybrid**\ 关键词表示针对不同的堆芯多群程序提供相应的均匀化少群常数，
   当前仅支持\ **Hybrid=0**\ （默认值，表示不输出）
   和\ **Hybrid=1**\ （表示产生多群蒙卡堆芯程序需要的少群常数，ACE格式）两个选项。
   **注意：若该区域是开启SPH后扩展的均匀化子区域，则输出的多群文件为：<xs扩展区域用户空间编号_该区域在lattice的ID>；若是非扩展区域，则是：**
   **<xs_区域用户空间编号>。**

-  **Angular**\ 关键词与Hybrid=1相对应，表示角度信息，目前可以为多群蒙卡提供5阶角数据。Angular输入选项可以是：0,1,3,5。

-  **Volume**\ 关键词表示每个组件的体积，用户需要输入每个组件的体积参数。若开启不连续因子功能，
   此时volume内体积会用于组件体积计算，若没有给定体积，系统会自动计算组件体积。
   注意\ **由于组件计算可以按照二维处理，因此此时的体积即组件截面积。该卡可以多次定义，但需要与universe卡的输入个数一致。**



群常数模块输入示例
----------------------------

PWR燃料棒均匀化计算
~~~~~~~~~~~~~~~~~~~~~~~~~~~

:numref:`pwrcell_homo` 是一个PWR的燃料棒，对PWR燃料棒进行均匀化计算的基本功能。

该算例计算Universe=0的2群常数，将其输出到输出文件中。Energy=0.625E-06表示以0.625ev为分界能，
计算两群常数。Wims=0表示直接一步法计算2群常数，Bone=0表示不采用B1修正处理。

|

.. code-block:: c
  :caption: PWR燃料棒均匀化计算示例
  :name: pwrcell_homo

    ///////--- Pin definition : ////
    Universe 0
    cell 1      -1            mat=1  Tmp=600
    cell 3      1&3&-4&5&-6   mat=3  Tmp=600
    cell 4      -3:4:-5:6     mat=0 void=1  Tmp=600


    Surface
    surf 1 cz  0.412
    surf 3 px  -0.665    bc=1
    surf 4 px  0.665     bc=1
    surf 5 py  -0.665    bc=1
    surf 6 py  0.665     bc=1
    surf 7 px  -21.42     bc=1
    surf 8 px  21.42      bc=1
    surf 9 py  -21.42     bc=1
    surf 10 py 21.42      bc=1


    Material
    // --- Fuel (composition given in atomic densities):
    mat 1 -10.045
          92235.60c   6.89220E+20
          92238.60c   2.17103E+22
          8016.60c    4.48178E+22
    //  --- Water (composition given in atomic densities):
    mat 3  -0.7569   // moder lwtr 1001
           1001.60c   5.06153E+22
           8016.60c   2.53076E+22
    //sab 3  lwtr.01t


    Criticality
    PowerIter Keff0=1.0 Population = 100 10 30
    InitSrc Point = 0 0 0


    GroupConstant
    Universe = 0
    Energy =0.625E-06   //2群
    WIMS=0
    BONE=0


    Plot  ColorScheme=335   Continue-calculation=1
    PlotID 2  Type = Slice   Color = Cell  Pixels= 1800 1800  Vertexes= -1 1 0  1 -1 0


|

随机几何均匀化计算
~~~~~~~~~~~~~~~~~~~~~~~~~~

该算例是一个25*25的随机几何组件，每个栅元是一个随机介质芯块组成，其填充率为PF=5.068%。

计算Universe=0的2群均匀化少群常数，少群结构以4.0ev为分界能，Wims=1表示采用两步法框架来计算该少群常数，
细群结构为WIMS的69群能群结构。Bone=0表示该均匀化计算关闭B1修正功能，Hybrid=1表示产生多群蒙卡堆芯计算
所需的截面输入文件，该文件命名为xs1,Angular=1表示为多群蒙卡堆芯程序计算1阶角数据来表征各向异性，Equivalence=0
表示产生的2群常数不开启等效均匀化处理。

|

.. code-block:: c
  :caption: 随机几何组件均匀化计算示例
  :name: random_homo

    ///////////// Array15 /////////////
    Universe 0
    cell 3 9&-10&11&-12&21&-22&17&-18  fill=1                          // Inside the Assembly
    cell 4 -9:10:-11:12:-21:22:-17:18  mat=0  void=1

    Universe 1 move=-32.13 -18.55 0 lat=2 pitch=1.7850 1.7850 scope=25 25 sita=60 fill=
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 2 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 2 2 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 2 2 2 3 2 2 2 3 2 2 2 6 6 6 6 6
         6 6 6 6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 6 6 2 2 3 2 2 2 2 2 2 2 3 2 2 6 6 6 6 6
         6 6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 3 2 2 2 2 2 2 2 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6 6
         6 6 6 6 6 2 2 3 2 2 2 2 2 2 2 3 2 2 6 6 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6 6 6 6
         6 6 6 6 6 2 2 2 3 2 2 2 3 2 2 2 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 2 2 2 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 2 2 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 2 2 2 2 2 2 2 2 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6
         6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6 6

    Universe 3   // Guide Tubes
    cell 24 -33&17&-18          mat=4        //water
    cell 25 33&-34&17&-18       mat=3        // Cladding
    cell 26 34&17&-18           mat=4

    Universe 6
    cell 31 -35&17&-18  mat=4
    cell 32  35&17&-18  mat=4



    Universe 2                        //Fuel Rods
    cell 21 -30&17&-18    fill=10
    cell 22 30&-31&17&-18  mat=2        // Helium Fill
    cell 27 31&-32&17&-18  mat=3        // Cladding FeCrAl
    cell 23 32&17&-18      mat=4



    // TRISO Particles distribution using explicit model
    Universe 10   lat = 4  MATRIC = 7 move = -0.6461 -0.6461 -176.5
                        // PARTICLE = 12
                        // PF = 0.35
                        // RAD = 0.061
                         RSA = 0
                         TYPE = 2
                         SIZE = 0.6461 353
                        // BURNMESH=1 1 1


    Universe 7
    cell 66 -49    mat = 7

    Universe 12
    cell 60 -44 mat=1        tmp=900
    cell 61 44&-45 mat= 5    tmp=900
    cell 62 45&-46 mat= 6    tmp=900
    cell 63 46&-47 mat= 7    tmp=900
    cell 64 47&-48 mat= 8    tmp=900
    cell 65 48 mat=7         tmp=900



    GroupConstant
    Universe = 0
    Energy =4.0E-06
    WIMS=1    // two stage homogenization
    BONE=0    // basing on two-stage and using critical spectrum to rehomogenize the fine group XS
    Hybrid=1   // Output xsout for mcnp_mg
    Angular=1  // 1 for the default, as p1
    Equivalence=0   //2 for SPH,  1 for DF  and 3 for SPE




    Surface
    surf 30 cz 0.6461
    surf 31 cz 0.6546
    surf 32 cz 0.71158
    surf 33 cz 0.8043
    surf 34 cz 0.8613
    surf 35 cz 0.8925             // water reflector
    surf 9  px  -13.4  bc=1
    surf 10 px   13.4  bc=1
    surf 11 p  -.5773502692 -1 0 -15.4536   bc=1
    surf 12 p  -.5773502692 -1 0  15.4536   bc=1
    surf 21 p   .5773502692 -1 0 -15.4536   bc=1
    surf 22 p   .5773502692 -1 0  15.4536   bc=1
    surf 13 px  -13.4  bc=1
    surf 14 px   13.4  bc=1
    surf 15 p  -.5773502692 -1 0 -15.4536  bc=1
    surf 16 p  -.5773502692 -1 0  15.4536  bc=1
    surf 19 p   .5773502692 -1 0 -15.4536  bc=1
    surf 20 p   .5773502692 -1 0  15.4536  bc=1
    surf 17 pz -176.5 bc=1
    surf 18 pz  176.5 bc=1
    surf 44 so  0.0450
    surf 45 so  0.0525
    surf 46 so  0.0555
    surf 47 so  0.0590
    surf 48 so  0.0610
    surf 49 inf
    surf 50 cz  16  bc=1
    surf 61 py  -16
    surf 62 py  16
    surf 63 px  -16
    surf 64 px  16


    Material
    mat 1 -12.95                       //UC
      92235.30c 16.10097657
      92238.30c 83.89902343
    6000.30c  100
    mat 2 -0.0022                    // Helium
      2004.30c  1.0
    mat 3  1.7767103E-02            //FeCrAl
      26054.30c  7.99520E-04
      26056.30c  1.22593E-02
      26057.30c  2.66507E-04
      24052.30c  3.55342E-03
      13027.30c  8.88356E-04
    mat 4 -0.74    // Water
      8016.30c  1.0
      1001.30c  2.0
    //sab 4  lwtr.62t
    mat 5 -1.05
      6000.30c    1.0
    //sab 3 grph.65t
    mat 6 -1.9
      6000.30c    1.0
    //sab 4 grph.65t
    mat 7 9.55236E-02                   //SiC
      6000.30c     4.77618E-02
    // 14000.30c     4.77618E-02
    //sab 5 grph.65t
    mat 8 -1.1
      6000.30c    1.0
    //sab 4 grph.65t


    Criticality
    PowerIter keff0=1.0 population = 20 10 20
    InitSrc point=0 0 0

    PLOT  ColorScheme=3     Continue-calculation=1
    PlotID 1  Type = slice   Color = Mat  Pixels=9000 9000   Vertexes=-16 16 0  16 -16 0
    PlotID 2  Type = Slice   Color = Cell  Pixels= 1800 1800  Vertexes= -1 22 0  22 -1 0


|


压水堆组件不连续因子计算
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

该算例是一个17*17的压水堆几何组件。

计算Universe=0的2群均匀化少群常数，少群结构以4.0ev为分界能，Wims=1表示采用两步法框架来计算该少群常数，
细群结构为WIMS的69群能群结构。Bone=0表示该均匀化计算关闭B1修正功能，Hybrid=1表示产生多群蒙卡堆芯计算
所需的截面输入文件，该文件命名为xs1,Angular=1表示为多群蒙卡堆芯程序计算1阶角数据来表征各向异性，Equivalence=1
表示计算组件的边不连续因子和角不连续因子，组件类型为四边形。

|

.. code-block:: c
  :caption: 压水堆组件不连续因子计算示例
  :name: pwr_df

    ////////  PWR assembly ////////
    UNIVERSE 0
    CELL 1   -6 : 7 : -8 : 9   mat = 0   void = 1               // Assembly outside
    CELL 2   6 & -7 & 8 & -9   mat = 0   Fill = 8               // Assembly inside


    UNIVERSE 8  lat = 1  pitch = 1.26 1.26 1    scope = 17  17  1  fill =
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 3 1 1 3 1 1 3 1 1 1 1 1
      1 1 1 3 1 1 1 1 1 1 1 1 1 3 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 3 1 1 3 1 1 3 1 1 3 1 1 3 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 3 1 1 1 1 1 1 1 1 1 3 1 1 1
      1 1 1 1 1 3 1 1 3 1 1 3 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
      1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1

    UNIVERSE 1 move = 0.63 0.63 0                 // Fuel rod
    cell  3   -1       mat = 1      inner = 1     // Fuel
    cell  4   1 & -2   mat = 3      inner = 1     // Air
    cell  6   2        mat = 5                    // water

    UNIVERSE 3 move = 0.63 0.63 0                 // Guide tube
    cell  11  -5       mat = 5      inner = 1     // water
    cell  13  5        mat = 5                    // water

    SURFACE
    surf  1  cz   0.4096
    surf  2  cz   0.4178
    surf  3  cz   0.4750
    surf  4  cz   0.5690
    surf  5  cz   0.6147
    surf  6  px   0         bc = 1
    surf  7  px   21.42     bc = 1
    surf  8  py   0         bc = 1
    surf  9  py   21.42     bc = 1

    MATERIAL
    mat 1  -10.196
           92235.71c   6.9100E-03
           92238.71c   2.2062E-01
           8016.71c    4.5510E-01
    mat 3  -0.001
           8016.71c    3.76622E-5
    mat 5  9.9977E-02
           1001.71c    6.6643E-02
           8016.71c    3.3334E-02
    //sab 5  HH2O.90t

    CRITICALITY
    PowerIter   population = 2000 20 50  // keff0 = 1.0
    InitSrc point = 12 12 0


    TALLY
    SurfTally 1 type = 1  Surf = 6 area = 21.42 Energy = b1
    SurfTally 1 type = 1  Surf = 9 area = 21.42 Energy = b1

    GroupConstant
    Universe = 0
    Energy = 4E-06
    WIMS=1
    BONE=0
    Hybrid=1  // Output xsout for mcnp_mg
    Angular=1  //角分布变量阶数 1 for the default, as p1\n
    EQUIVALENCE = 1 1    ///1:DF calculation 1: RECT type assembly
    ///volume = 458.8164


|


截面参数化功能
================

截面参数化功能在群常数功能基础上开发，因此相关输入卡包含在群常数模块下。

截面参数化模块RMC输入卡
-----------------------

.. code-block:: none

    GroupConstant
    ISBURNUPLINE=<Param>
    ASSEMBINFO= <univ paras1> < univ paras2> … <univ parasi>
                univ parasi = <cell number> <level> <matrix> <rod cell level>
    SUBUNIVERSE <Universes>
    FORMATTYPE = <Param>
    MATINFO = <MatIndexes>

其中，

-  **ISBURNUPLINE**\ 统计截面参数化相关信息关键词，输入选项可以是0或1。
   0表示再启动计算中的某一个燃耗点，1表示一条完整的燃耗链（分支）计算。注意：
   **输入各个区域是否为燃耗区，因此后面参数个数需要和universe个数一致**。

-  **ASSEMBINFO**\ 统计截面参数化相关信息关键词，输入选项是一组数据，数据组数需要与群常数的universe卡定义区域个数一致。
   每组数据中包含4个数据：
   <cell number>为均匀化组件包含的栅元个数。
   <level>表示区域内的lattice所在层级。
   <matrix>表示组件形状，即行数（默认组件为方阵）。
   <rod cell level>定义棒所在cell层级（由于输入卡有轴向分层，需要对轴向的燃耗区进行累加，所以需要指明含有轴向分层的棒的层级）。
   注意：**使用 ASSEMBINFO 卡必须同时定义 ISBURNUPLINE 卡，否则会报错** 。

-  **SUBUNIVERSE**\ 是可选项。
   对于几何有截断的情况，需要输入每个区域的有截断的lattice的universe编号。
   对于几何没有截断的情况，输入-1。
   该卡可以重复定义，但个数需要与群常数的universe卡定义区域个数一致。

-  **FORMATTYPE**\ 控制参数化接口格式，1表示GAEA格式，2表示CORCA3D格式。
   注意：**FORMATTYPE卡不能放在输入模块最后，否则会有错** 。

-  **MATINFO**\ 需要依次输入硼浓度，氙浓度，慢化剂密度，燃料温度四个物理状态对应的材料编号。

截面参数化模块Python输入卡
---------------------------

截面参数化功能对应的PYTHON程序有两个模块，对于参数化模块，需要提供输入卡，文件名为inp_preprocess。
inp_preprocess用于生成多物理状态的输入文件，具体格式如下：

.. code-block:: none

    MPI=<para>  openmp=<para>  platform=<para>
    RESTARTBRANCH AUXILIARY
    INDEX=<para>  MATTEMP=<temperature material> burnuppoint=<para>

Python输入卡中：

-  **MPI/openmp/platform**\ 控制计算资源，MPI，openmp设定并行，默认关闭openmp，MPI=60。
   Platform设定计算平台，默认为1，计算方式为本地服务器，命令行为：mpiexec -n ...；
   也可以输入2，表示天河平台，命令行为：yhrun ...

-  **RESTARTBRANCH/ AUXILIARY_Line**\ 再启动/辅线关键词，二选一。

-  **INDEX**\ 表示分支序号。

-  **MATTEMP**\ 表示材料温度，后面给出具体数值(单位为K)，再之后给出需要对应修改的材料序号。若所有材料均修改，可以直接输入All。

-  **burnuppoint**\ 表示再启动计算计算的燃耗步（注意：燃耗步数字从0开始，而不是从1开始）。

以下给出一个简单例子：

|

.. code-block:: c
  :caption: 分支计算
  :name: 分支计算

    MPI=80  openmp=12  platform=2
    RESTARTBRANCH
    INDEX=1    MATTEMP=1000.0  All  burnuppoint=0 3 4 6 8 9
    INDEX=2 MATTEMP=800.0   All  burnuppoint=0 3 4 6 8 9


|

六边形组件的多区域模型算例
~~~~~~~~~~~~~~~~~~~~~~~~~~~


截面参数化的功能较为复杂，尤其是对于六边形组件这种有截断的几何。因此采用一个包含六边形组件的多区域模型进行实例说明。
该几何模型含有三个燃料组件，一个毒物棒组件以及边缘的反射层区域。燃料组件内部有24根燃料棒，每根棒轴向含有8个燃料芯块。
芯块内填充燃料颗粒，使用RSA方法，填充率为35%。注意：**目前暂不考虑RSA模型底层还有嵌套**。

.. figure:: media/multi_region.png
   :width: 4.5in
   :name: multi_region_fig
 
   
   六边形组件的多区域模型
   

上图为具体的几何模型。为了表示方便，我们对模型各个区域进行编号，如下图所示。

.. figure:: media/multi_region_index.png
   :width: 4.5in
   :name: multi_region_index_fig

   六边形组件的多区域模型编号

算例输入文件如下，几何模型中区域1到5分别对应universe 10，11，12，21，13：

|

.. code-block:: c
  :caption: 六边形组件的多区域模型
  :name: multi_region

    ////////////////////// GR5 ////////////////
    ////////////// sleeve : SiC
    ////////////// Block bottom graphite, top He(save for future)  
    /////////////  graphite & SiC matrix & sleeve: 1ppm   TRISO: 0.5ppm
    /////////////  top and bottom block, only channels for coolant and CR rod

    //注意：由于采用燃耗区合并，因此该处体积需要给出的是所有小球的总体积，燃耗应该不会有较大影响，但功率会受影响\n
    //各个cell均需要给定温度，这里截面参数化需要温度一致\n
    Universe 1 //move = 0.050319623 0.050319623 0.050319623    //triso 
    cell 1 -1           mat = 1  tmp = 1000  vol = 7.5313E-01 //kernel 8.5% 
    cell 2  1 & -2      mat = 2  tmp = 1000  vol = 1.0422E+00 //buffer      
    cell 3  2 & -3      mat = 3  tmp = 1000  vol = 6.5565E-01 //IPyC        
    cell 4  3 & -4      mat = 4  tmp = 1000  vol = 6.9737E-01 //SiC         
    cell 5  4 & -5      mat = 5  tmp = 1000  vol = 9.5248E-01 //OPyC        
    cell 6  5           mat = 6  tmp = 1000  vol = 1.0000E-30 //SiC matrix
                          
    Universe 2   lat = 4  MATRIC = 3  move = -1.1 -1.1 0.05
                PARTICLE = 1
                PF = 0.3//0.349631585
                RAD = 0.043981974  //PFCORRECT = 0
                RSA = 1
                TYPE = 2
                SIZE = 1.1 3.596
            //DEM = 1  TIME = 0.1

    Universe 3
    cell 14 -6    mat = 6  tmp = 1000 

    ///////// pellet /////
    Universe 4
    cell 11 -14 & 16 & -19 & !12   mat =  7  tmp = 1000 vol = 1.6864E+00 //sleeve  
    cell 12 -13 & 17 & -18         fill = 2     vol= 13.6696       //fuel compact
    cell 13 14 : -16 : 19          mat =  8  tmp = 1000 vol = 3.4914E-01  //He

    Universe 16  // bottom
    cell 7 -14  mat = 9  tmp = 1000 vol = 5.9496E+00 //graphite  
    cell 8 14   mat = 9  tmp = 1000 vol = 1.3527E-01 //graphite 

    Universe 17  // top 
    cell 9 -14  mat = 8  tmp = 1000 vol = 1.0000E-30  //He  
    cell 10 14   mat = 8 tmp = 1000 vol = 1.0000E-30  //He 

    // 8 pellets
    Universe 5 move = 0 0 -2.264 lat = 1   pitch = 1 1 3.696   scope = 1 1 10   fill = 16 4*8 17  

    Universe 6  // fuel rod
    cell 15  -15 fill = 5       vol=131.73      //fuel
    cell 16  15  mat =  9 tmp = 1000 vol = 2.9782E+02  //block graphite

    Universe 7   //graphite rod
    cell 17  -21 mat = 9  tmp = 1000 vol = 4.2955E+02
    cell 18  21  mat = 9  tmp = 1000 vol = 1.0000E-30

    Universe 8  //coolant rod
    cell 19  -20  mat = 8 tmp = 1000 vol = 6.2329E+01 // He
    cell 20   20  mat = 9 tmp = 1000 vol = 3.6722E+02 // graphite

    Universe 40 //BP1-1
    cell 100 -61 & 67 & -68        mat = 15  tmp = 1000  vol = 7.068583
    cell 101  61 & -62 & 67 & -68  mat = 15  tmp = 1000  vol = 7.068583
    cell 102  62 & -63 & 67 & -68  mat = 15  tmp = 1000  vol = 4.712389
    cell 103  63 & -64 & 67 & -68  mat = 15  tmp = 1000  vol = 3.534292
    cell 104  64 & -65 & 67 & -68  mat = 15  tmp = 1000  vol = 1.178097
    cell 105  ((65 & 67 & -68) : -67 : 68) & -66   mat = 8  tmp = 1000  vol = 5.898340 
    cell 106  66    mat = 9  tmp = 1000  vol = 185.314015

    Universe 41  rotate = -0.5 0.8660254 0 -0.8660254 -0.5 0 0 0 1 //BP1-2 r120
    cell 110 -61 & 67 & -68        mat = 15  tmp = 1000  vol = 7.068583
    cell 111  61 & -62 & 67 & -68  mat = 15  tmp = 1000  vol = 7.068583
    cell 112  62 & -63 & 67 & -68  mat = 15  tmp = 1000  vol = 4.712389
    cell 113  63 & -64 & 67 & -68  mat = 15  tmp = 1000  vol = 3.534292
    cell 114  64 & -65 & 67 & -68  mat = 15  tmp = 1000  vol = 1.178097
    cell 115  ((65 & 67 & -68) : -67 : 68) & -66   mat = 8  tmp = 1000 vol = 5.898340
    cell 116  66    mat = 9  tmp = 1000  vol = 185.314015

    Universe 42  rotate = -0.5 -0.8660254 0 0.8660254 -0.5 0 0 0 1 //BP1-3 r240
    cell 120 -61 & 67 & -68        mat = 15  tmp = 1000  vol = 7.068583
    cell 121  61 & -62 & 67 & -68  mat = 15  tmp = 1000  vol = 7.068583
    cell 122  62 & -63 & 67 & -68  mat = 15  tmp = 1000  vol = 4.712389
    cell 123  63 & -64 & 67 & -68  mat = 15  tmp = 1000  vol = 3.534292
    cell 124  64 & -65 & 67 & -68  mat = 15  tmp = 1000  vol = 1.178097
    cell 125  ((65 & 67 & -68) : -67 : 68) & -66   mat = 8  tmp = 1000 vol = 5.898340
    cell 126  66    mat = 9  tmp = 1000  vol = 185.314015

    // block
    //lattice各个cell的体积在volume卡提供\n
    Universe 9  move = -24 -13.85640646 0 
         lat=2 scope= 9 9 sita = 60 pitch = 4 4 fill = //inner block 
             7 * 9
             7  7  7  7  7  6  6  41 7 
             7  7  7  6  6  8  6  6  7
             7  7  6  8  6  6  8  6  7
             7  40 6  6  8  6  6  7  7
             7  6  8  6  6  8  6  7  7
             7  6  6  8  6  6  7  7  7
             7  7  6  6  42 7  7  7  7
             7 * 9

    Universe 10
    //cell体积需要提供均匀化区域包含的所有层级的cell，体积可以是真实的也可以是相对的\n
    cell 27  31 & -32 & -33 & 34 & 35 & -36        fill =  9      vol=498.8452656  //outer block
    cell 28  -31 : 32 : 33 : -34 : -35 : 36        mat =  8   tmp = 1000 vol = 8.348729792  //He 1mm
    /////// a block end 

    Universe 11
    cell 29  31 & -32 & -33 & 34 & 35 & -36        fill =  9     vol=498.8452656         //outer block
    cell 30  -31 : 32 : 33 : -34 : -35 : 36        mat =  8   tmp = 1000 vol = 8.348729792  //He 1mm

    Universe 12
    cell 31  31 & -32 & -33 & 34 & 35 & -36        fill =  9       vol=498.8452656       //outer block
    cell 32  -31 : 32 : 33 : -34 : -35 : 36        mat =  8   tmp = 1000 vol = 8.348729792  //He 1mm

    Universe 13
    cell 33 -74 mat = 9 tmp = 1000 vol=1.0  //core graphite



    Universe 73 //move = 24.2 0 0 
    cell 60 -40       mat = 8  tmp = 1000 vol=0.188495556//He
    cell 61 40 & -41  mat = 12 tmp = 1000 vol=0.146607655//inner cladding
    cell 62 41 & -42  mat = 8  tmp = 1000 vol=0.08901179//He 
    cell 63 42 & -43  mat = 11 tmp = 1000 vol=3.979350627//control rod 
    cell 64 43 & -44  mat = 8  tmp = 1000 vol=0.184097326//He 
    cell 65 44 & -45  mat = 12 tmp = 1000 vol=0.64088489//outer cladding
    cell 66 45        mat = 8  tmp = 1000 vol=1.939619271//He 


    Universe 21  //move = 24.2 0 0 ////shutdown contrl column
    cell 84 -46 vol=7.168067116 fill = 73
    cell 67 46 & 31 & -32 & -33 & 34 & 35 & -36   mat = 9 tmp = 1000 vol=34.40237168  //core graphite
    cell 83 -31 : 32 : 33 : -34 : -35 : 36    mat = 8 tmp = 1000 vol=0.695727483 //He 1mm

    Universe 30 lat=2 scope= 3 3 sita = 60 pitch = 24.2 24.2 fill = //inner block 
     13 10 13
     21 11 13
     12 13 13


    Universe 0
    cell 90  69 & -70 & 71 & -72 & -73  fill = 30 vol=1.0 //core 
    cell 92  -69: 70: -71 : 72 : 73    mat = 0 vol=1.0e-30  void = 1 


    SURFACE
    // ----------triso partic
    surf 1   so   0.025       // keneral
    surf 2   so   0.033396452     // buffer
    surf 3   so   0.037047997      // IPyC
    surf 4   so   0.040272833   // SiC
    surf 5   so   0.043981974   // OPyC
    surf 6   inf
    /// ----------pellet 
    //surf 11 cz 0.30    //inner radius
    //surf 12 cz 0.35    //outer radius
    surf 13 cz 1.1     //pellet
    surf 14 cz 1.15    //sleeve radius
    surf 15 cz 1.163   //fuel hole 
    surf 16 pz 0
    surf 17 pz 0.05
    surf 18 pz 3.646
    surf 19 pz 3.696
    surf 20 cz  0.8   // coolant hole
    /// ---------- block
    surf 21 cz 10    // block inner radius
    // surf 22 cz 10.05 // inner tube inner radius
    // surf 23 cz 10.25 // inner tube outer radius
    // surf 24 cz 10.4  // pressure tube inner radius
    // surf 25 cz 10.9  // pressure tube outer radius
    // surf 26 cz 11    // block outer radius
    surf 27 cz 0.75  //relector hole
    surf 31 px -12
    surf 32 px 12
    surf 33 p 1 1.732 0 24
    surf 34 p 1 -1.732 0 -24
    surf 35 p 1 1.732 0 -24
    surf 36 p 1 -1.732 0 24
    ///----------shutdown control column
    surf 40 cz 0.6      //inner clad inside
    surf 41 cz 0.8      //inner clad outside
    surf 42 cz 0.9      //control rod inside
    surf 43 cz 2.9      //control rod outside
    surf 44 cz 2.96     //outer clad inside
    surf 45 cz 3.16     //outer clad outside
    surf 46 cz 3.7      //control rod channel
    ///------------BP
    surf 61 c/z  1 0  0.27386128
    surf 62 c/z  1 0  0.38729834
    surf 63 c/z  1 0  0.44721360
    surf 64 c/z  1 0  0.48733972
    surf 65 c/z  1 0  0.5
    surf 66 c/z  1 0  0.55
    surf 67 pz   0.5
    surf 68 pz   30.5
    surf 69 pz 0  bc=1
    surf 70 pz 31  bc=1
    surf 71 px 12.11 bc=1
    surf 72 p 1 -1.732 0 24.2 bc=1
    surf 73 p 1 1.732 0 96.8   bc=1
    surf 74 cz 200

    //surf 69 pz 0  bc=1
    //surf 70 pz 31  bc=1
    //surf 71 px 0  bc=1
    //surf 72 px 12.1   
    //surf 73 p 1 1.732 0 24.2   bc=1
    //surf 74 p 1 -1.732 0 -24.2 
    //surf 75 p 1 1.732 0 -24.2 
    //surf 76 p 1 -1.732 0 24.2 bc=1



    MATERIAL
    //  -------kernel 8.5%---------
    mat 1  -10.4
          5010.30c  -0.5000E-06  
          8016.30c  -1.1855E-01  
          8017.30c  -5.0406E-05  
         92234.30c  -5.9058E-04  
         92235.30c  -7.4919E-02  
         92238.30c  -8.0589E-01
    //  ------buffer layer--------
    mat 2  -1.235294118
         5010.30c  6.8467E-09  
         6000.30c  6.1936E-02
    //sab 2 Graph.71t
    //  -------IPyC layer---------
    mat 3  -2.235294118
         5010.30c  1.2389E-08  
         6000.30c  1.1207E-01
    //sab 3 Graph.71t
    //  -------SiC layer----------
    mat 4  -3.741176471
         5010.30c  2.0736E-08  
         6000.30c  5.6189E-02 
        14028.30c  5.1823E-02
        14029.30c  2.6313E-03  
        14030.30c  1.7346E-03
    //sab 4 Graph.71t
    //  --------OPyC layer--------
    mat 5   -2.235294118
         5010.30c  1.2389E-08  
         6000.30c  1.1207E-01
    //sab 5 Graph.71t    
    //  ------SiC matrix----
    mat 6  -2.933721806
         5010.30c  3.2520E-08  
         6000.30c  4.4062E-02  
        14028.30c  4.0638E-02
        14029.30c  2.0634E-03  
        14030.30c  1.3602E-03
    //sab 6 Graph.71t
    //  ------SiC sleeve-----
    mat 7  -3.18
         5010.30c  3.5251E-8  
         6000.30c  4.7761E-2  
        14028.30c  4.4050E-2
        14029.30c  2.2366E-3  
        14030.30c  1.4744E-3
    //sab 7 Graph.71t
    //  ------helium coolant------
    mat 8  -1.6361E-4
         2003.30c  3.3724E-11  
         2004.30c  2.4616E-5
    //  ------IG-110 graphite-----
    mat 9  -1.7512
         5010.30c  1.9412E-8  
         6000.30c  8.7804E-2
    //sab 9 Graph.71t
    //  ------control rod natural B4C---------
    mat 11  -2.5
         5010.30c  2.1579E-02  
         5011.30c  8.7406E-02  
         6000.30c  2.7246E-02
    //sab 11 Graph.71t
    //  -------alloy 800H---------
    mat 12  -8.03
        6000.30c  3.2210E-4  
        13027.30c  6.7209E-4  
        14028.30c  5.5580E-4  
        14029.30c  2.8222E-5  
        14030.30c  1.8604E-5  
        15031.30c  3.1225E-5  
        16032.30c  1.4325E-5
        16033.30c  1.1311E-7
        16034.30c  6.4094E-7
        16036.30c  1.5081E-9
        22046.30c  3.1254E-5
        22047.30c  2.8186E-5
        22048.30c  2.7928E-4
        22049.30c  2.0495E-5
        22050.30c  1.9624E-5  
        24050.30c  8.4860E-4  
        24052.30c  1.6364E-2  
        24053.30c  1.8556E-3  
        24054.30c  4.6189E-4  
        25055.30c  8.8022E-4  
        26054.30c  2.2265E-3  
        26056.30c  3.4951E-2  
        26057.30c  8.0717E-4  
        26058.30c  1.0742E-4  
        28058.30c  1.8229E-2  
        28060.30c  7.0217E-3  
        28061.30c  3.0523E-4  
        28062.30c  9.7320E-4  
        28064.30c  2.4785E-4  
        29063.30c  1.5791E-4  
        29065.30c  7.0383E-5  
    // ------ Burnable Poison (Gd2O3 1%) -----
    mat 13  -1.71789
         5010.30c  1.9043E-8  
         6000.30c  8.6134E-2
    //sab 13 Graph.71t
    mat 15 -1.7  
         6000.30c  8.4383E-02
         8016.30c  8.4691E-05
         8017.30c  3.3890E-08 
        64152.30c  1.1297E-07
        64154.30c  1.2144E-06
        64155.30c  8.3200E-06
        64156.30c  1.1562E-05
        64157.30c  8.8566E-06
        64158.30c  1.4047E-05
        64160.30c  1.2370E-05
    //sab 15 Graph.71t
    CeAce  OTFDB=1  OTFSab=0  pTable=0 DBRC=0  ErgBinHash=1  

    CRITICALITY
    PowerIter   population = 1000  10  15
    InitSrc point =  30  30  5

    GroupConstant
    //支持多个universe，该卡必须放在第一个位置
    Universe = 10 11 12 13 21 
    Energy = 4E-6//3.000000E-08 1.463700E-07 3.500000E-07 1.071000E-06 1.855390E-06 9.118820E-03 8.208500E-01
    WIMS=0  //采用两步法，细群69群结构，并群后采用energy结构，因此energy结构需要包含于wims结构中\n
    BONE=0  //采用b1修正\n
    Hybrid=1  // Output MCNP格式多群文件
    Angular=1  //角分布变量阶数 1 for the default, as p1\n
    //均匀化方式，0：不均匀化，1：DF，2：sph
    //DF参数：1（四边形) 2（六边形）
    //SPH参数：迭代次数\n
    EQUIVALENCE = 2 10
    //volume卡说明：
    //注意：该卡可以多次定义，但需要与universe卡的输入个数一致\n
    //卡片给出顺序和universe卡的universe对应
    //volume卡5行数据
    //第一行第一个为总体积（真实体积），用于sph计算\n     
    //1-3 //4-5 //6-7 //8-9 //axial
    volume = 7732 0*20 71.59 0*6
                  0*2 4.2955E+02 2.1477E+02 0*6 2.1477E+02 4.2955E+02*2 2.1477E+02 0*4
                  0 4.2955E+02*4 2.1477E+02 0*3 1.4318E+02 4.2955E+02*5 71.59 0*2
                  0 2.1477E+02 4.2955E+02*2 2.1477E+02 0*6 1.4318E+02 0*6 
                  0 3.696*8 1.432
    volume = 1.5464E+04 1.0E-30*6 1.4318E+02 1.0E-30*6 2.1477E+02 4.2955E+02*2 2.1477E+02 1.0E-30*3 1.4318E+02 4.2955E+02*5 1.4318E+02
                                     1.0E-30*2 4.2955E+02*6 1.0E-30*2 2.1477E+02 4.2955E+02*5 2.1477E+02 1.0E-30*2 4.2955E+02*6 1.0E-30*2
                                     1.4318E+02 4.2955E+02*5 1.4318E+02 1.0E-30*3 2.1477E+02 4.2955E+02*2 2.1477E+02 1.0E-30*6 1.4318E+02
                                     1.0E-30*6 0 3.696*8 1.432 
    //volume卡5行数据
    //第一行第一个为总体积（真实体积），用于sph计算\n                 
    //81个数据的结构：
    //1-2 //3-4 //5-6 //7-9 
    //10个axial数据
    //注意：volume卡内部不要加注释，数据太多可以分行写数据\n
    volume = 7732 0*6 1.4318E+02 0*6 2.1477E+02 4.2955E+02*2 2.1477E+02 0
                  0*2 1.4318E+02 4.2955E+02*5 71.59 0*2 4.2955E+02*4 2.1477E+02 0*2
                  0 2.1477E+02 4.2955E+02*2 2.1477E+02 0*5 4.2955E+02 2.1477E+02 0*6
                  71.59 0*26
                  0 3.696*8 1.432
    //对应universe13,该区域不是lattice，给1.0即可\n
    //但如果要算SPH给出真实体积\n
    volume = 2577.3
    //对应universe21,该区域不是lattice，给1.0\n
    volume = 7732
    //ASSEMBINFO卡说明：
    //结构：<univ paras>...
    //<cell number>,<level>,<matrix>,<axial para num>,<axial para>
    //含义：
    //有多少universe，给定多少组<univ paras>
    //每个<univ paras>包含<cell number>,<level>,<matrix>,<rod cell level>
    //例如universe10: 81 1 9 16 8 1*15
    //包含81个cell,包含lattice结构，层级为向下找1层，找到universe9,输出该区域功率和燃耗的h5文件采用9*9矩阵输出81个数据\n
    //由于输入卡有轴向分层，需要对轴向的燃耗区进行累加，因此设置该卡
    //universe10包含的burncell有：1 100 101 102 103 104 110 111 112 113 114 120 121 122 123 124
    //轴向根据cell vector 区分，3的含义：90 > 2 > 27 > 15，（0，1，2，3）
    ASSEMBINFO = 81 1 9 3    81 1 9 3   81 1 9 3    1 0 1 3    1 0 1 3
    ////Branch signal
    //1 表示主线，辅线,2再启动\n
    ISBURNUPLINE 1
    //输入各个区域是否为燃耗区，1是，0不是
    IsBurnRegion=1 1 1 0 0
    //SUBUNIVERSE：
    //支持重复定义该卡
    //用于几何截断情况\n
    //卡片给出顺序和universe卡的universe对应
    //例如universe10: 被截断的区域有两个,9,5(volume卡先给出9，再5)\n
    SUBUNIVERSE=9 5
    SUBUNIVERSE=9 5
    SUBUNIVERSE=9 5
    //无截断或者截断无影响给出-1
    SUBUNIVERSE=-1
    SUBUNIVERSE=-1
    FORMATTYPE = 1
    //设置状态参数的卡
    //硼浓度，氙浓度，慢化剂密度，燃料温度对与材料编号\n
    MATINFO = 9 1 9 1

    //注意：截断燃耗区会报0energy的warning,不影响计算\n
    //可以考虑把截断的燃耗区替换为非燃耗结构\n
    BURNUP
    BurnCell    1 100 101 102 103 104 110 111 112 113 114 120 121 122 123 124
    TimeStep    10 20// 
    Power       17.98162286*2
    Substep     10
    Inherent    0.9999
    AceLib      .30c
    Strategy    0
    Parallel    1
    Solver      2
    Merge  7 2  //燃耗区合并功能，(level /universe) 0->30->10/11/12->9->6->5->4->2(7层)，注意，这里必须让10,11,12是同一层，否则出错\n

    //Plot ColorScheme=9  Continue-calculation=0
    //PlotID 1 Type = slice Color = mat Pixels=5000 5000 Vertexes=10  -8 5  60.5 60  5    
    //PlotID 2 Type = slice Color = mat Pixels=4000 4000 Vertexes= 20  -8 -1  20 60 32
    //PlotID 3 Type = slice Color = cell Pixels=4000 8000 Vertexes=23  -1 5  24 1  5


|


参数化计算说明
----------------------

截面参数化的计算流程则如下所示：

1)在用python计算前，请确保已经使用RMC完成群常数计算，
群常数计算需要开启EQUIVALENCE = 2，Hybrid=1 等选项，详见RMC用户手册群常数模块说明；
在群常数计算时，注意开启接续计算功能（在输出控制模块中，定义inpfile为1），用于截面参数化的再启动计算。

2)计算流程：

1 准备好inp_preprocess，用于辅线，再启动等计算；

2 准备好RMC程序，xsdir等文件和程序

3 准备好接续输出文件(XXX.FMTinp.stepXXX 和 materialXX)

4 运行main.py完成参数化分支文件构建及计算

5 利用分支生成的rmc输入文件以及多群输出文件在sph的python程序文件夹下进行sph计算，
注意再启动的sph文件用python处理产生的文件(路径：~/Restart/branch_xx/xsparatable_SPH.h5)

6 将sph计算结果文件复制

 辅线的每个sph_Iter.h5对应放到~/Auxliary/branch_xx/burnup_xx/下

 主线的每个sph_Iter.h5对应放到~/burnup_xx/下

 再启动的每个sph_Iter.h5对应放到~/Restart/branch_xx/step_xx/下

 再启动删除~/Restart/branch_xx/xsparatable_SPH.h5文件

7 准备好Pair_inp文件，里面设置参数化区域和sph区域的对应关系

8 运行ChangeRestartXS.py 和 ChangeAuxliaryXS.py

9 运行H5FileFormat.py

10 最终结果在Result文件夹下

|


断点续算
========

RMC支持接续文件输出功能。接续功能用于在RMC停止计算后，重新启动计算。

接续计算模块输入卡
-----------------------

.. code-block:: none

    RESTARTBINARY
    Write =<flag>
    Cycles=<cycles_vector_group>
    Interval=<N>
    Overwrite=<flag>

其中，

-  **RESTARTBINARY**\ 为接续计算输入卡的关键词；

-  **Write**\ 为指定是否输出接续文件，1表示输出，0表示不输出，默认值为0；
   当该选项卡为1时，\ **Cycles**\或者\ **Interval**\输入卡中必须有一个有输入。
   \ **Cycles**\和\ **Interval**\不能同时定义；

-  **Cycles**\ 为仅在临界计算模式下，指定在哪些cycle中输出；

-  **Interval**\ 适用于临界计算和固定源计算：在临界计算中，指定每隔多少cycle数输出接续计算文件；
   在固定源计算中，指定每隔多少粒子数输出接续计算文件；

-  **Overwrite**\ 是在临界计算中为减少储存占用空间而设置的选项卡。仅在使用\ **Interval**\选项时才可以使用。
   1表示每次输出的文件覆盖上次输出的文件；0则表示不覆盖，默认值为0。

接续计算文件使用
-----------------------

接续计算具体运行过程与运行RMC基本相同，只是在后面加上了“-r 重启文件名”。
假定串行版RMC可执行文件名为“RMC”，串行运行的方法为：在RMC可执行程序所在目录输入以下命令：

.. code-block:: none

    Windows环境：   RMC(空格)-r(空格)重启文件名
       Linux环境：     ./RMC(空格)-r(空格)重启文件名

|

接续面源
====================

RMC支持接续面源计算文件输出功能。接续面源计算，用于将粒子径迹记录在面上，
供屏蔽计算使用。额外信息由模块BinaryOut定义。

接续面源文件输出模块输入卡
---------------------------------------------

.. code-block:: none

    Binaryout
    WrtSurfSrc  Write=<flag>  SYMM=<symm>  PARTYPE = <parms>
                Surf = <Surface_vector_group>  CeL=<cell_vector_group>
                WCylces=<wcycles>

其中，

-   **Write**\ 指定是否输出接续计算文件，1表示输出，0表示不输出，默认值为0。

-   **Cel**\ 仅适用于临界计算。记录临界计算中，在指定栅元中产生的源粒子。

-   **Symm**\ 指定粒子径迹记录的方式。0代表对称记录，即Surf中定义的面仅能为球面，
    且只能定义1个，这种情况很少见，用户需要确定是否可以使用。1代表记录方式按Surf中介绍记录。
    2代表记录穿过Surf中定义面的径迹，无论径迹方向如何。默认值是1。

-   **Partype**\ 指定记录的径迹类型，0代表中子，1代表光子。默认包含计算中所使用的所有种类径迹。

-   **Surf**\ 是指定需要被记录的面，将在下面详细介绍。
    其输入格式具体为Ids1(Idc1 Idc2 Idc3) Ids2，如：Surf=-1(2 -3)  3。
    其中Ids代表的是需要记录面的序号，可正可负。正负号代表粒子径迹穿过面的方向与面的法向夹角余弦值为正或为负。
    括号内代表栅元序号，可正可负。“+”(可缺省)代表进入该栅元，“-”代表离开该栅元。
    例如Surf=-1(2 -3)  3，表示记录穿过面1，且与1面正法线方向夹角为负数，进入栅元2或者离开栅元3的径迹，
    或者沿与面3正法线方向夹角为正的径迹。如果Symm为2，则记录穿过面1且进入栅元2或者离开栅元3，或者穿过面3的径迹。

-   **Wcycles**\ 是指接续计算中需要记录的活跃代数，如果不定义则默认记录全部活跃代数。

接续面源文件使用
-----------------------

要使用接续面源，首先需要输出接续面源文件，接续面源文件输出使用方法见3.1.21.1接续面源文件输出。
接续面源文件输出为WSurfSrc文件。要计算，则将WSurfSrc重命名为SurfSrc文件。此外，按照3.1.16.3中描述进行计算则可以。

在计算当中，除了输出RMC规定的文件之外，还将会输出SurfSrcOutput.out文件，其中将记录接续面源文件的相近信息。


接续面源模块示例
-----------------------   

.. code-block:: c

    BinaryOut
    SurfSrcWrt    surf = 1(-2 3) cel =2 symm=0 Partype = 0 1


粒子事件追踪
====================

RMC支持按照一定的条件筛选粒子的事件，并将其输出的功能。粒子事件包括初始源、产生粒子的储存、穿面、碰撞、终止等。条件包括粒子
发生反应时的位置、中子速度、权重、是否进入指定栅元或穿过某个面元、对制定计数器有贡献等。输出文件名字与输出文件名相同，后加后缀为.PTRAC
粒子事件跟踪功能，用于在固定源计算中记录中子反应的历史，供进一步的细化研究。

粒子事件追踪功能输入卡
---------------------------------------------

.. code-block:: none

    PTRAC NEU=<flag>  ELEC=<flag> PHO=<flag> 
	  SRC=<flag> BNK=<flag> SUR=<flag> COL=<flag> TER=<flag> 
	  FILE=<flag>
	  WRTIE=<flag> 
	  MAX=<max_number_of_events_in_output>
	  BUFFER=<max_number_in_one_output> 
	  MEPH=<max_number_in_one_history>
	  X=<bmin> <bmax> Y=<bmin> <bmax> Z=<bmin> <bmax>
	  U=<bmin> <bmax> V=<bmin> <bmax> W=<bmin> <bmax>
	  ERG=<bmin> <bmax> WGT=<bmin> <bmax> VEL=<bmin> <bmax>
	  CELL=[cell_number_list]
	  SURFACE=[surface_number_list]
	  CELLTALLY=[celltally_number_list]
	  MESHTALLY=[meshtally_number_list]
	  SURFTALLY=[surftally_number_list]
	  POINTTALLY=[pointtally_number_list]
	  

其中，
-   **NEU**\ 指定是否记录中子事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **ELEC**\ 指定是否记录电子事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **PHO**\ 指定是否记录光子事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **SRC**\ 指定是否记录初始源事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **BNK**\ 指定是否记录BANK事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **SUR**\ 指定是否记录穿面事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **COL**\ 指定是否记录碰撞事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **TER**\ 指定是否记录终止事件，1表示记录。如果不记录则不需要加入本选项卡。

-   **FILE**\ 指定以何种文件格式记录，1表示以ACSII码输出结果，0表示以二进制输出结果，此选项卡必须定义。

-   **WRITE**\ 指定以何种方式记录粒子事件，1表示粒子的详细状态输出结果。默认只输出事件的简要内容，如果取默认值则不需要定义此选项卡。

-   **MAX**\ 指定一个输出文件中最多记录多少个事件，如果事件数目过多可能会导致输出文件很大，默认值为10000，如果取默认值则不需要定义此选项卡。

-   **BUFFER**\ 指定一次输出过程中写入多少事件进文件，默认值为1000，如果取默认值则不需要定义此选项卡。

-   **MEPH**\ 指定一个粒子的生存期中最多输出多少次事件，默认值为100，如果取默认值则不需要定义此选项卡。

-   **X**\ 筛选器，指定粒子反应时的x坐标范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **Y**\ 筛选器，指定粒子反应时的y坐标范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **Z**\ 筛选器，指定粒子反应时的z坐标范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **U**\ 筛选器，指定粒子反应时的速度方向与X轴夹角的余弦值范围，第一个值为坐标下界，第二个值为坐标上界，两者的绝对值均必须不大于1,前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **V**\ 筛选器，指定粒子反应时的速度方向与Y轴夹角的余弦值范围，第一个值为坐标下界，第二个值为坐标上界，两者的绝对值均必须不大于1,前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **W**\ 筛选器，指定粒子反应时的速度方向与Z轴夹角的余弦值范围，第一个值为坐标下界，第二个值为坐标上界，两者的绝对值均必须不大于1,前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **ERG**\ 筛选器，指定粒子反应时的能量范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者，单位为MeV。如果不加入此筛选器则不需此选项卡。

-   **WGT**\ 筛选器，指定粒子反应时的权重范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者。如果不加入此筛选器则不需此选项卡。

-   **VEL**\ 筛选器，指定粒子反应时的速度范围，第一个值为坐标下界，第二个值为坐标上界，前者必须小于后者，单位为1.0e08cm/s。如果不加入此筛选器则不需此选项卡。

-   **CELL**\ 历史筛选器，监控粒子是否在其历史中经过指定栅元范围中的任何一个，如果经过，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。面元编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。

-   **SURFACE**\ 历史筛选器，监控粒子是否在其历史中穿过指定面元范围中的任何一个，如果经过，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。面元编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。

-   **CELLTALLY**\ 计数器筛选器，监控粒子是否在其历史中对指定CellTally中的任何一个有贡献，如果有，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。CellTally编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。

-   **SURFTALLY**\ 计数器筛选器，监控粒子是否在其历史中对指定SurfTally中的任何一个有贡献，如果有，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。SurfTally编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。

-   **MESHTALLY**\ 计数器筛选器，监控粒子是否在其历史中对指定MeshTally中的任何一个有贡献，如果有，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。MeshTally编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。

-   **POINTTALLY**\ 计数器筛选器，监控粒子是否在其历史中对指定PointTally中的任何一个有贡献，如果有，则输出此粒子历史中所有通过全部筛选的事件；否则此粒子的事件全部不输出。PointTally编号之间以一个空格分离，如果不加入此筛选器则不需此选项卡。


粒子事件追踪模块示例
-----------------------

.. code-block:: c

   PTRAC NEU=1 SUR=1 COL=1 MAX=1000 MEPH=2 ERG=1 4 WRITE=1 CELL=1 2 3

INCLUDE 文件包含功能
=======================

INCLUDE 功能提供了多文件输入的方法，只需要在\ **INCLUDE** \后面添加上包含文件的路径，即可将目标文件包含进来。其形式如下：

.. code-block:: none

    INCLUDE /path/to/file


或

.. code-block:: none

    INCLUDE
    /path/to/file


其中，文件路径可以是绝对路径或相对路径，\ **允许有空格** \。

注意：

- 文件路径\ **不需要也不允许用引号（中文引号“”，‘’或英文引号）包围** \。
- INCLUDE卡的前后必须由空行或者文件终止符包围，即必须是一个独立的卡，包含的文件中的卡也应该是完整的，
  目前不支持单一卡片内部拆分为多个文件。


减方差
====================

RMC支持减方差计算功能，包括区域重要性，源偏倚和权窗技术。
目前区域重要性和权窗技术都只在固定源模式下使用。
权窗技术包括栅元权窗和网格权窗，对于同一种粒子类型（中子、光子、电子），
区域重要性、栅元权窗和网格权窗三种减方差方法只能同时使用其中的一种。

区域重要性输入卡
----------------------

在栅元信息卡中增加几何重要性\ **imp**\ 选项卡，其分为中子几何重要性\ **imp:n**\ 、
光子几何重要性\ **imp:p**\ 和电子几何重要性\ **imp:e**\ 。例如：imp:n=0，
imp:n=1，imp:n=2，imp:p=0，imp:p=1，imp:p=2，imp:e=0，imp:e=1，imp:e=2，等等。

权窗输入卡
----------------------

.. code-block:: none

    WeightWindow
    WWN:N  W_1  W_2  W_3  W_4 … W_n 
    WWMESH:N  W_1  W_2  W_3  W_4 … W_n
    WWP:N  WUPN WSUV 

示例为中子的栅元权窗和网格权窗输入卡。其中，

-  **WeightWindow**\ 为减方差的权窗输入卡的关键词；

-  **WWN:N**\ 为中子的栅元权窗卡，W1、W2、W3等等分别表示每个栅元
   的权窗下限。若是光子的栅元权窗卡，则把关键词替换为WWN:P。
   若是电子的栅元权窗卡，则把关键词替换为WWN:E；

-  **WWMESH:N**\ 为中子的网格权窗卡，W1、W2、W3等等分别表示每个网格的权窗下限。
   网格的几个定义在网格计数器部分，目前的程序支持非均匀网格和
   非均匀圆柱网格。若是光子的网格权窗卡，则把关键词替换为\ **WWMESH:P**\ 。
   若是电子的网格权窗卡，则把关键词替换为\ **WWMESH:E**\ 。；

-  **WWP:N**\ 为中子的权窗参数卡，\ **WUPN**\ 表示权窗上限与下限的倍数，
   要求WUPN>2，默认值为5。\ **WSUV**\ 表示存活粒子权重与权窗下限的倍数，
   要求1<WSURVN<WUPN，默认值为3。若是光子的权窗参数卡，则把关键词替换
   为\ **WWP:P**\ 。若是电子的权窗参数卡，则把关键词替换为\ **WWP:E**\ ；

-  注意，同一种粒子权窗卡只能同时使用一种。比如对于中子，\ **WWN:N**\ 和
   \ **WWMESH:N**\ 只定义其中的一个就可以。若\ **WWP:N**\ 没有定义，则为默认值。


随机中子动力学
=====================

RMC支持中子点火概率、中子脉冲引发时间等随机中子动力学计算模拟功能,也支持直接模拟法中子动力学计算功能。

随机中子动力学模拟时以中子链为单位，按照定义的时间步大小，模拟中子链随时间的演化特点，设定中子链自持的标准，计算统计中子的点火概率或者超临界系统的脉冲引发时间。

随机中子动力学输入卡
-------------------------

.. code-block:: none

     KINETICS
     Particle  FissionChain=<fission_chain_number>  TimeStep=<time_step>
               StochasticMode=<calculation_mode_option>
               [MaxPopulation=<maximum_population>]  [Batch=<batch_number>]
               [Lambda=<sponta_fission_rate>]  [Nu=<average_neutron_number>] 
               [TerminateTime=<terminate_time>]  [TerminateFisRate=Terminate_fission_rate]
               [ExpFisRate=<exponential_fission_rate>]  [TargetFisRate=<target_fission_rate>]
               [InitSourceNum=<initial_neutron_number>] [PrecursorMode=<precursor_mode_option>]
               [DecayTimeStep=<decay_timestep>] [CaptureMode=<capture_mode_option>]
               [UseComb=<use_comb_method_option>] [ControlNum=<comb_control_number>]
               [FissMultiplicity=<fission_multiplicity>] [SpontaFiss=<spontaneous_fission>]
               [InitCriSrc=<initial_critical_source>]
     TimeStep  Time=<t0 t1 t2 ... tn>  Step=<s1 s2 ... sn>
     RNG       [Type = <type>] [Seed = <seed>] [Stride = <stride>]


其中，

-  **KINETICS**\ 为随机中子动力学关键词。\ **Particle**\ 卡定义中子链相关参数，
   \ **TimeStep**\ 卡定义变时间步长的相关参数，\ **RNG**\ 卡定义随机数，和临界计算模块中的随机数定义卡的使用方法相同，这里不再赘述。下面分别介绍
   \ **Particle**\ 卡和\ **TimeStep**\ 卡的使用方法。

Particle 选项卡
~~~~~~~~~~~~~~~~~~~~~~

Particle卡指定随机中子动力学模拟时中子链的相关参数。

-  **FissionChain**\ 指定模拟的中子链数目，需为正整数。
-  **TimeStep**\ 中子链模拟时的时间步间隔，单位为s。
-  **StochasticMode**\ 随机中子动力学计算模式选项，0为脉冲引发时间计算或者直接模拟法中子动力学计算模式，1为POI计算模式,默认为0。
-  **MaxPopulation**\ 指定中子链模拟时的最大中子数，当中子链中的瞬发中子数超过该数目时，认为该中子链自持，停止该中子链的模拟。
-  **Batch**\ 定义分组的数目，该卡在使用组统计法计算点火概率的不确定度时使用，默认不分组，即分组数目为1。
-  **Lambda**\ 定义自发裂变源的裂变强度，单位为/s。
-  **Nu**\ 定义自发裂变源的平均裂变中子数。
-  **TerminateTime**\ 定义中子链模拟的终止时间，单位为s。
-  **TerminateFisRate**\ 定义中子链模拟终止的裂变反应率，单位为/s。
-  **ExpFisRate**\ 定义中子链模拟时开始指数增长的裂变反应率，超过该裂变率认为中子链已进入显著的指数增长阶段。
-  **TargetFisRate**\ 定义中子链模拟时的外推目标裂变反应率，在静态超临界系统中，
   可以根据定义的\ **ExpFisRate**\和\ **TargetFisRate**\指数外推出中子链裂变率达到\ **TargetFisRate**\的时间。
-  **InitSourceNum**\ 定义初始中子源数量，在直接模拟法中子动力学计算模式中使用。
-  **PrecursorMode**\ 缓发中子先驱核衰变模式，0为先驱核直接模拟(常用于脉冲引发时间计算模式)，1为先驱核强制衰变(常用于直接模拟法中子动力学计算模式)，默认为0。
-  **DecayTimeStep**\ 缓发中子先驱核强制衰变的时间步(即每隔该时间步强制衰变一次)，默认为1ms，仅在先驱核强制衰变模式时有效。
-  **CaptureMode**\ 处理辐射俘获反应的两种模式，0为直接模拟吸收，杀死粒子，1为隐伏获，默认为0。
-  **UseComb**\ 是否开启梳子法，0为关闭，1为开启，默认为0。
-  **ControlNum**\ 梳子法调整后的粒子数，仅在开启梳子法后有效，默认为10000。
-  **FissMultiplicity**\ 是否开启裂变多重性，0为关闭，1为开启，默认为1。
-  **SpontaFiss**\ 是否开启自发裂变，0为关闭，1为开启，默认为1。
-  **InitCriSrc**\ 是否存在初始临界源(需要由准静态S模式计算，生成后缀为".KineticsInitSource"的源文件)，0为不存在，1为存在，默认为0。若存在，则初始源分布由给定文件确定，常用于直接模拟法中子动力学计算模式。


TimeStep 选项卡
~~~~~~~~~~~~~~~~~~~~~~

TimeStep卡指定随机中子动力学模拟时动态时间步长的相关参数，用于动态系统（几何或材料随时间变化）。

-  **Time**\ 指定时间区间边界，单位为s。
-  **TimeStep**\ 每个时间区间内的时间步长，数目比时间区间边界的数目少1，单位为s。


随机中子动力学模块输入示例
-------------------------------

-  中子点火概率计算使用示例

.. code-block:: c

    KINETICS
    Particle  StochasticMode=1 FissionChain=1000 TimeStep=1e-9  MaxPopulation=1000 Batch=10


该示例定义了中子点火概率的计算参数，计算模式为POI，模拟1000条中子链，共分成10组进行模拟和统计，模拟时的时间步大小为1纳秒（ns），每条中子链的瞬发中子数上限为1000。


-  中子脉冲引发时间计算使用示例

.. code-block:: c

    KINETICS
    Particle  StochasticMode=0 fissionchain=2  TimeStep=0.1  MaxPopulation=100000  lambda=200  
              Nu=1  TerminateTime=300  TerminateFisRate=2.0e9  ExpFisRate=1e9
              TargetFisRate=2.7e11
    TimeStep  Time=0 10  300  Step=0.1 0.5


该示例定义了中子脉冲引发时间的计算参数(未设置的参数均为默认参数设置)，计算模式为脉冲引发时间计算,模拟2条中子链，时间步为0.1s，每条中子链
的最大瞬发中子数为100000，超过100000即认为中子脉冲引发成功，自发裂变源强为200次/s，
每次自发裂变释放出的平均裂变中子数为1，每条中子链模拟的截止时间为300s，超过300s
则中止该中子链的模拟，每条中子链的截止裂变率为2.0e9/s，超过该裂变率自动停止该条
中子链的模拟，每条中子链开始指数增长的裂变反应率为1e9/s，超过该裂变率即认为该条
中子链已进入显著的指数增长阶段，中子链模拟时的外推目标裂变反应率为2.7e11/s。该算
例还定义了动态时间步长，此时\ **Particle**\卡中定义的时间步长失效，在0到10s
之间，时间步长为0.1s，在10s到300s之间时间步长为0.5s。

-  直接模拟法中子动力学计算使用示例1

.. code-block:: c

    Kinetics
    particle  StochasticMode=0 UseComb=1 ControlNum=1000 InitSourceNum=1000 PrecursorMode=1  CaptureMode=1 
              SpontaFiss=0 FissMultiplicity=0  FissionChain =10  TimeStep=0.000001 
              MaxPopulation=1e12 TerminateTime=0.00001 


该示例定义了直接模拟法中子动力学的计算参数，计算模式为直接模拟法中子动力学，使用梳子法，梳子法控制粒子数为1000，初始源中子数为1000，缓发中子衰变模式为强制衰变，辐射俘获模式为隐俘获，关闭自发裂变，关闭裂变多重性，模拟10条中子链，相当于分成10组进行模拟和统计，模拟时的时间步大小为0.000001s，每条中子链的中子数上限为1e12，模拟终止时间设置为0.00001s。

-  直接模拟法中子动力学计算使用示例2

.. code-block:: c

    Kinetics
    particle  StochasticMode=0 UseComb=1 ControlNum=100 InitCriSrc=1 PrecursorMode=1  CaptureMode=0 
              SpontaFiss=0 FissMultiplicity=0 FissionChain = 4 TimeStep=1e-7 MaxPopulation=1e12 TerminateTime=1e-6   

    Tally
    CellTally 1 type = 1 cell = 1 time =0 1.0e-07 2.0e-07 3.0e-07 4.0e-07 5.0e-07 6.0e-07 7.0e-07 8.0e-07 9.0e-07 1.0e-06 
    CellTally 2 type = 2 cell = 1 time =0 1.0e-07 2.0e-07 3.0e-07 4.0e-07 5.0e-07 6.0e-07 7.0e-07 8.0e-07 9.0e-07 1.0e-06 
    CellTally 3 type = 3 cell = 1 time =0 1.0e-07 2.0e-07 3.0e-07 4.0e-07 5.0e-07 6.0e-07 7.0e-07 8.0e-07 9.0e-07 1.0e-06 


该示例定义了直接模拟法中子动力学的计算参数，计算模式为直接模拟法中子动力学，使用梳子法，梳子法控制粒子数为100，采用初始临界源分布(需要有后缀为".KineticsInitSource"的源文件，并放置在与可执行文件同一目录)，缓发中子衰变模式为强制衰变，辐射俘获模式为直接模拟吸收，关闭自发裂变，关闭裂变多重性，模拟4条中子链，相当于分成4组进行模拟和统计，模拟时的时间步大小为1e-7s，每条中子链的中子数上限为1e12，模拟终止时间设置为1e-6s。并设置有通量，功率，裂变反应率三个计数器，并设置有时间分箱。


附录
====

输入输出文件清单
----------------------

RMC程序发布包中附带典型算例的输入文件（详见 :numref:`input_files_table` ）
及输出结果，所有算例均在清
华大学“探索100”百万亿次集群系统（Red Hat Enterprise Linux 5.6）中运行通过，部分
算例采用大规模并行计算。

.. table:: 输入文件清单
  :name: input_files_table

  +---------------------------------+------------------------------------+
  | 输入文件                        | 算例描述                           |
  +=================================+====================================+
  | 3_1_PWR_assembly                | 几何重复结构示例，PWR组件          |
  +---------------------------------+------------------------------------+
  | 3_2_PWR_core                    | 几何重复结构示例，PWR堆芯          |
  +---------------------------------+------------------------------------+
  | 3_3_MFR_assembly                | 几何重复结构示例，六边形组件       |
  +---------------------------------+------------------------------------+
  | 3_4_MFR_core                    | 几何重复结构示例，六边形堆芯       |
  +---------------------------------+------------------------------------+
  | 6_1_Tally_PWR_pin               | 计数器示例，轴向分段的PWR燃料棒    |
  +---------------------------------+------------------------------------+
  | 6_2_Tally_Hoogenboom_core       | 计数器示例，蒙卡全堆基准题         |
  +---------------------------------+------------------------------------+
  | 7_1_FSC_slab                    | 源收敛加速示例，OECD源收敛基准题   |
  +---------------------------------+------------------------------------+
  | 7_2_FSC_Hoogenboom_core         | 源收敛加速示例，蒙卡全堆基准题     |
  +---------------------------------+------------------------------------+
  | 8_1_Burn_PWR_pin                | 燃耗示例，PWR燃料棒                |
  +---------------------------------+------------------------------------+
  | 8_2_Burn_PWR_assembly           | 燃耗示例，PWR组件                  |
  +---------------------------------+------------------------------------+


连续能量ACE数据库
-----------------------

RMC程序发布包中附带一套基于ENDF7.0制作的300K温度下的连续能量ACE数据库
（后缀为.30c），包括近400个核素，见 :numref:`acedata_table` 。此外，
发布包中还附带有部分热化数据
库，以及天然元素数据库（见 :numref:`natiso_table` ）。具体信息请参阅xdir文件。

.. table:: 连续能量ACE数据库清单
  :name: acedata_table

  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | ZAID     | Nuclide   | ZAID    | Nuclide   | ZAID    | Nuclide   | ZAID    | Nuclide   |
  +==========+===========+=========+===========+=========+===========+=========+===========+
  | 1001     | H1        | 1002    | H2        | 1003    | H3        | 2003    | He3       |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 2004     | He4       | 3006    | Li6       | 3007    | Li7       | 4007    | Be7       |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 4009     | Be9       | 5010    | B10       | 5011    | B11       | 6000    | C         |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 7014     | N14       | 7015    | N15       | 8016    | O16       | 8017    | O17       |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 9019     | F19       | 11022   | Na22      | 11023   | Na23      | 12024   | Mg24      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 12025    | Mg25      | 12026   | Mg26      | 13027   | Al27      | 14028   | Si28      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 14029    | Si29      | 14030   | Si30      | 15031   | P31       | 16032   | S32       |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 16033    | S33       | 16034   | S34       | 16036   | S36       | 17035   | Cl35      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 17037    | Cl37      | 18036   | Ar36      | 18038   | Ar38      | 18040   | Ar40      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 19039    | K39       | 19040   | K40       | 19041   | K41       | 20040   | Ca40      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 20042    | Ca42      | 20043   | Ca43      | 20044   | Ca44      | 20046   | Ca46      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 20048    | Ca48      | 21045   | Sc45      | 22046   | Ti46      | 22047   | Ti47      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 22048    | Ti48      | 22049   | Ti49      | 22050   | Ti50      | 23000   | V         |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 24050    | Cr50      | 24052   | Cr52      | 24053   | Cr53      | 24054   | Cr54      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 25055    | Mn55      | 26054   | Fe54      | 26056   | Fe56      | 26057   | Fe57      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 26058    | Fe58      | 27058   | Co58      | 27458   | Co58m1    | 27059   | Co59      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 28058    | Ni58      | 28059   | Ni59      | 28060   | Ni60      | 28061   | Ni61      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 28062    | Ni62      | 28064   | Ni64      | 29063   | Cu63      | 29065   | Cu65      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 30000    | Zn        | 31069   | Ga69      | 31071   | Ga71      | 32070   | Ge70      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 32072    | Ge72      | 32073   | Ge73      | 32074   | Ge74      | 32076   | Ge76      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 33074    | As74      | 33075   | As75      | 34074   | Se74      | 34076   | Se76      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 34077    | Se77      | 34078   | Se78      | 34079   | Se79      | 34080   | Se80      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 34082    | Se82      | 35079   | Br79      | 35081   | Br81      | 36078   | Kr78      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 36080    | Kr80      | 36082   | Kr82      | 36083   | Kr83      | 36084   | Kr84      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 36085    | Kr85      | 36086   | Kr86      | 37085   | Rb85      | 37086   | Rb86      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 37087    | Rb87      | 38084   | Sr84      | 38086   | Sr86      | 38087   | Sr87      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 38088    | Sr88      | 38089   | Sr89      | 38090   | Sr90      | 39089   | Y89       |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 39090    | Y90       | 39091   | Y91       | 40090   | Zr90      | 40091   | Zr91      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 40092    | Zr92      | 40093   | Zr93      | 40094   | Zr94      | 40095   | Zr95      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 40096    | Zr96      | 41093   | Nb93      | 41094   | Nb94      | 41095   | Nb95      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 42092    | Mo92      | 42094   | Mo94      | 42095   | Mo95      | 42096   | Mo96      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 42097    | Mo97      | 42098   | Mo98      | 42099   | Mo99      | 42100   | Mo100     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 43099    | Tc99      | 44096   | Ru96      | 44098   | Ru98      | 44099   | Ru99      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 44100    | Ru100     | 44101   | Ru101     | 44102   | Ru102     | 44103   | Ru103     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 44104    | Ru104     | 44105   | Ru105     | 44106   | Ru106     | 45103   | Rh103     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 45105    | Rh105     | 46102   | Pd102     | 46104   | Pd104     | 46105   | Pd105     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 46106    | Pd106     | 46107   | Pd107     | 46108   | Pd108     | 46110   | Pd110     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 47107    | Ag107     | 47109   | Ag109     | 47510   | Ag110m1   | 47111   | Ag111     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 48106    | Cd106     | 48108   | Cd108     | 48110   | Cd110     | 48111   | Cd111     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 48112    | Cd112     | 48113   | Cd113     | 48114   | Cd114     | 48515   | Cd115m1   |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 48116    | Cd116     | 49113   | In113     | 49115   | In115     | 50112   | Sn112     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 50113    | Sn113     | 50114   | Sn114     | 50115   | Sn115     | 50116   | Sn116     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 50117    | Sn117     | 50118   | Sn118     | 50119   | Sn119     | 50120   | Sn120     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 50122    | Sn122     | 50123   | Sn123     | 50124   | Sn124     | 50125   | Sn125     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 50126    | Sn126     | 51121   | Sb121     | 51123   | Sb123     | 51124   | Sb124     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 51125    | Sb125     | 51126   | Sb126     | 52120   | Te120     | 52122   | Te122     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 52123    | Te123     | 52124   | Te124     | 52125   | Te125     | 52126   | Te126     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 52527    | Te127m1   | 52128   | Te128     | 52529   | Te129m1   | 52130   | Te130     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 52132    | Te132     | 53127   | I127      | 53129   | I129      | 53130   | I130      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 53131    | I131      | 53135   | I135      | 54123   | Xe123     | 54124   | Xe124     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 54126    | Xe126     | 54128   | Xe128     | 54129   | Xe129     | 54130   | Xe130     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 54131    | Xe131     | 54132   | Xe132     | 54133   | Xe133     | 54134   | Xe134     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 54135    | Xe135     | 54136   | Xe136     | 55133   | Cs133     | 55134   | Cs134     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 55135    | Cs135     | 55136   | Cs136     | 55137   | Cs137     | 56130   | Ba130     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 56132    | Ba132     | 56133   | Ba133     | 56134   | Ba134     | 56135   | Ba135     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 56136    | Ba136     | 56137   | Ba137     | 56138   | Ba138     | 56140   | Ba140     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 57138    | La138     | 57139   | La139     | 57140   | La140     | 58136   | Ce136     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 58138    | Ce138     | 58139   | Ce139     | 58140   | Ce140     | 58141   | Ce141     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 58142    | Ce142     | 58143   | Ce143     | 58144   | Ce144     | 59141   | Pr141     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 59142    | Pr142     | 59143   | Pr143     | 60142   | Nd142     | 60143   | Nd143     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 60144    | Nd144     | 60145   | Nd145     | 60146   | Nd146     | 60147   | Nd147     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 60148    | Nd148     | 60150   | Nd150     | 61147   | Pm147     | 61148   | Pm148     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 61548    | Pm148m1   | 61149   | Pm149     | 61151   | Pm151     | 62144   | Sm144     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 62147    | Sm147     | 62148   | Sm148     | 62149   | Sm149     | 62150   | Sm150     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 62151    | Sm151     | 62152   | Sm152     | 62153   | Sm153     | 62154   | Sm154     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 63151    | Eu151     | 63152   | Eu152     | 63153   | Eu153     | 63154   | Eu154     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 63155    | Eu155     | 63156   | Eu156     | 63157   | Eu157     | 64152   | Gd152     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 64153    | Gd153     | 64154   | Gd154     | 64155   | Gd155     | 64156   | Gd156     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 64157    | Gd157     | 64158   | Gd158     | 64160   | Gd160     | 65159   | Tb159     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 65160    | Tb160     | 66156   | Dy156     | 66158   | Dy158     | 66160   | Dy160     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 66161    | Dy161     | 66162   | Dy162     | 66163   | Dy163     | 66164   | Dy164     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 67165    | Ho165     | 67566   | Ho166m1   | 68162   | Er162     | 68164   | Er164     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 68166    | Er166     | 68167   | Er167     | 68168   | Er168     | 68170   | Er170     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 71175    | Lu175     | 71176   | Lu176     | 72174   | Hf174     | 72176   | Hf176     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 72177    | Hf177     | 72178   | Hf178     | 72179   | Hf179     | 72180   | Hf180     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 73181    | Ta181     | 73182   | Ta182     | 74182   | W182      | 74183   | W183      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 74184    | W184      | 74186   | W186      | 75185   | Re185     | 75187   | Re187     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 77191    | Ir191     | 77193   | Ir193     | 79197   | Au197     | 80196   | Hg196     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 80198    | Hg198     | 80199   | Hg199     | 80200   | Hg200     | 80201   | Hg201     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 80202    | Hg202     | 80204   | Hg204     | 82204   | Pb204     | 82206   | Pb206     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 82207    | Pb207     | 82208   | Pb208     | 83209   | Bi209     | 88223   | Ra223     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 88224    | Ra224     | 88225   | Ra225     | 88226   | Ra226     | 89225   | Ac225     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 89226    | Ac226     | 89227   | Ac227     | 90227   | Th227     | 90228   | Th228     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 90229    | Th229     | 90230   | Th230     | 90232   | Th232     | 90233   | Th233     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 90234    | Th234     | 91231   | Pa231     | 91232   | Pa232     | 91233   | Pa233     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 92232    | U232      | 92233   | U233      | 92234   | U234      | 92235   | U235      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 92236    | U236      | 92237   | U237      | 92238   | U238      | 92239   | U239      |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 92240    | U240      | 92241   | U241      | 93235   | Np235     | 93236   | Np236     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 93237    | Np237     | 93238   | Np238     | 93239   | Np239     | 94236   | Pu236     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 94237    | Pu237     | 94238   | Pu238     | 94239   | Pu239     | 94240   | Pu240     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 94241    | Pu241     | 94242   | Pu242     | 94243   | Pu243     | 94244   | Pu244     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 94246    | Pu246     | 95241   | Am241     | 95242   | Am242     | 95642   | Am242m1   |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 95243    | Am243     | 95244   | Am244     | 95644   | Am244m1   | 96241   | Cm241     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 96242    | Cm242     | 96243   | Cm243     | 96244   | Cm244     | 96245   | Cm245     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 96246    | Cm246     | 96247   | Cm247     | 96248   | Cm248     | 96249   | Cm249     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 96250    | Cm250     | 97249   | Bk249     | 97250   | Bk250     | 98249   | Cf249     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 98250    | Cf250     | 98251   | Cf251     | 98252   | Cf252     | 98253   | Cf253     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 98254    | Cf254     | 99253   | Es253     | 99254   | Es254     | 99255   | Es255     |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+
  | 100255   | Fm255     |         |           |         |           |         |           |
  +----------+-----------+---------+-----------+---------+-----------+---------+-----------+

.. table:: 天然元素数据库清单
  :name: natiso_table

  +-------------+-------------+-------------+-------------+
  | 6000.60c    | 12000.60c   | 14000.60c   | 16000.60c   |
  +-------------+-------------+-------------+-------------+
  | 17000.60c   | 18000.59c   | 19000.60c   | 20000.60c   |
  +-------------+-------------+-------------+-------------+
  | 22000.60c   | 23000.60c   | 24000.50c   | 26000.55c   |
  +-------------+-------------+-------------+-------------+
  | 28000.50c   | 29000.50c   | 30000.42c   | 31000.60c   |
  +-------------+-------------+-------------+-------------+
  | 40000.60c   | 42000.60c   | 47000.55c   | 48000.51c   |
  +-------------+-------------+-------------+-------------+
  | 49000.60c   | 50000.42c   | 51000.42c   | 54000.42c   |
  +-------------+-------------+-------------+-------------+
  | 63000.42c   | 64000.35c   | 72000.60c   | 74000.55c   |
  +-------------+-------------+-------------+-------------+
  | 77000.55c   | 78000.42c   | 82000.50c   |             |
  +-------------+-------------+-------------+-------------+


燃耗数据库
----------------

发布包中附带适用于压水堆的燃耗数据库，含有1487个核素的单群截面及30个核素的裂变产额。


功能兼容性矩阵
----------------------

.. table:: 功能兼容性矩阵
  :name: function_compatibility

  +---------------------+-------------------+---------+---------+
  | 功能                |  子功能           | MPI     | OpenMP  |
  +=====================+===================+=========+=========+
  | 临界计算            |  ——               | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 燃耗计算            | 正常燃耗计算      | √       | √       |
  +---------------------+-------------------+---------+---------+
  |                     | 燃耗区合并        | √       | Future  |
  +---------------------+-------------------+---------+---------+
  | 计数器              | 栅元计数器        | √       | √       |
  +---------------------+-------------------+---------+---------+
  |                     | 网格计数器        | √       | √       |
  +---------------------+-------------------+---------+---------+
  |                     | 截面计数器        | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 数据分解            | ——                | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 区域分解            | ——                | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 源收敛诊断及加速    | 香农熵统计        | √       | Future  |
  +---------------------+-------------------+---------+---------+
  |                     | 源收敛加速        | √       | Future  |
  +---------------------+-------------------+---------+---------+
  | 输出及绘图          | 计算结果输出      | √       | √       |
  +---------------------+-------------------+---------+---------+
  |                     | 绘图              | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 固定源计算          | ——                | √       | ×       |
  +---------------------+-------------------+---------+---------+
  | 时空动力学计算      | ——                | √       | ×       |
  +---------------------+-------------------+---------+---------+
  | 直接模拟法动力学计算| ——                | √       | ×       |
  +---------------------+-------------------+---------+---------+
  | 临界搜索            | 材料搜索          | √       | √       |
  +---------------------+-------------------+---------+---------+
  |                     | 几何搜索          | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 反复裂变几率法      | ——                | √       | √       |
  +---------------------+-------------------+---------+---------+
  | 随机介质            | ——                | √       | Future  |
  +---------------------+-------------------+---------+---------+
  | 群常数计算          | ——                | √       | ×       |
  +---------------------+-------------------+---------+---------+
  | 统计检验            | ——                | √       | ×       |
  +---------------------+-------------------+---------+---------+


.. _UltraEdit: https://www.ultraedit.com
.. _VSCode: https://code.visualstudio.com
